<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–°–ò–°–Ø –ö–õ–ò–ö–ï–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #242433;
            --accent: #ff4d8d;
            --accent-glow: rgba(255, 77, 141, 0.5);
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-muted: #606080;
            --border: rgba(255, 255, 255, 0.08);
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --gold: #fcd34d;
            --purple: #b366ff;
            --tg-theme-bg-color: #0a0a0f;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #a0a0c0;
            --tg-theme-link-color: #ff4d8d;
            --tg-theme-button-color: #ff4d8d;
            --tg-theme-button-text-color: #ffffff;
        }

        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .bg-gradient {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 77, 141, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(179, 102, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0) 0%, var(--bg-primary) 100%);
            pointer-events: none;
            z-index: 0;
            animation: pulse-bg 10s ease-in-out infinite alternate;
        }
        @keyframes pulse-bg {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            background: linear-gradient(to bottom, var(--bg-primary) 60%, transparent);
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 500px;
            margin: 0 auto;
        }

        .user-section { display: flex; align-items: center; gap: 10px; }

        .user-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #b366ff);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info h2 { font-size: 14px; font-weight: 600; }
        .user-info span { font-size: 11px; color: var(--text-secondary); }

        .stats-row { display: flex; gap: 8px; }

        .stat-badge {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 24px;
            border: 1px solid var(--border);
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .stat-badge:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.08); }
        .stat-badge.coins .icon { color: var(--gold); }
        .stat-badge.size .icon { color: var(--accent); }

        .main-container {
            position: relative;
            z-index: 1;
            padding-top: calc(70px + env(safe-area-inset-top));
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            min-height: 100vh;
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .game-section { display: flex; flex-direction: column; align-items: center; padding: 16px; }

        .model-container {
            width: 100%;
            max-width: 350px;
            height: 380px;
            border-radius: 32px;
            background: radial-gradient(circle at 50% 40%, #2a2a3a 0%, #0a0a0f 100%);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 77, 141, 0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .model-container:active { transform: scale(0.96) translateY(4px); }
        .model-container::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 32px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent, rgba(255,77,141,0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        .model-canvas { width: 100%; height: 100%; }

        .size-indicator {
            position: absolute;
            bottom: 12px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 6px 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--accent);
            font-size: 14px;
            pointer-events: none;
        }
        .size-indicator span { color: var(--accent); font-weight: 700; }

        .level-bar-container {
            width: 100%;
            max-width: 350px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .level-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
        }

        .level-progress-bg {
            width: 100%;
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #b366ff);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .click-controls { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 14px; }
        .per-click { text-align: center; font-size: 13px; color: var(--text-secondary); }
        .per-click strong { color: var(--accent); }

        .exchange-section {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 14px;
            border: 1px solid var(--border);
        }
        .exchange-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; }
        .exchange-row { display: flex; gap: 8px; }
        .exchange-input {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        .exchange-input:focus { outline: none; border-color: var(--accent); }
        .exchange-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .exchange-btn:active { transform: scale(0.95); }
        .exchange-rate { margin-top: 8px; font-size: 10px; color: var(--text-muted); text-align: center; }

        .section-content { padding: 16px; max-width: 500px; margin: 0 auto; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .section-title { font-size: 18px; font-weight: 700; }

        /* Upgrade Tab Styles */
        .upgrade-grid { display: flex; flex-direction: column; gap: 10px; }
        
        .upgrade-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .upgrade-card:hover { 
            border-color: var(--accent); 
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(255, 77, 141, 0.15);
        }
        .upgrade-card:active { transform: scale(0.98); }
        .upgrade-card.maxed { border-color: var(--gold); opacity: 0.7; }
        .upgrade-card.maxed::after {
            content: '–ú–ê–ö–°';
            position: absolute;
            top: 8px; right: 8px;
            background: var(--gold);
            color: #1a1a1a;
            font-size: 9px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 6px;
        }
        
        .upgrade-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .upgrade-icon {
            width: 48px; height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }
        
        .upgrade-info { flex: 1; }
        .upgrade-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .upgrade-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.3; }
        .upgrade-level-badge {
            font-size: 11px;
            color: var(--purple);
            font-weight: 600;
            margin-top: 2px;
        }
        
        .upgrade-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .upgrade-cost {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .upgrade-cost-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .upgrade-cost-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }
        .upgrade-cost-value.coins-cost { color: var(--gold); }
        
        .upgrade-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .upgrade-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .upgrade-buy-btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .upgrade-buy-btn:active { transform: scale(0.93); }
        .upgrade-buy-btn.size-btn {
            background: linear-gradient(135deg, var(--accent), #e0437a);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 77, 141, 0.3);
        }
        .upgrade-buy-btn.coins-btn {
            background: linear-gradient(135deg, var(--gold), #e6b800);
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(252, 211, 77, 0.3);
        }
        .upgrade-buy-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none;
        }
        
        .upgrade-effect-preview {
            font-size: 10px;
            color: var(--success);
            margin-top: 4px;
        }

        .upgrade-category {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 16px 0 8px;
            padding-left: 4px;
        }
        .upgrade-category:first-child { margin-top: 0; }

        /* Shop */
        .shop-grid { display: flex; flex-direction: column; gap: 8px; }
        .shop-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border-radius: 14px;
            padding: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .shop-item:hover { border-color: var(--accent); }
        .shop-item-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .shop-item-info { flex: 1; }
        .shop-item-name { font-size: 13px; font-weight: 600; }
        .shop-item-desc { font-size: 11px; color: var(--text-secondary); }
        .shop-item-price { font-size: 13px; font-weight: 700; color: var(--gold); }

        /* Cases */
        .cases-grid { display: flex; flex-direction: column; gap: 12px; }
        .case-card {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 16px;
            text-align: center;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .case-card:hover { transform: translateY(-3px); }
        .case-icon { width: 50px; height: 50px; margin: 0 auto 10px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .case-name { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
        .case-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 10px; }
        .case-price { display: inline-flex; align-items: center; gap: 4px; background: var(--bg-elevated); padding: 8px 16px; border-radius: 16px; font-weight: 600; font-size: 13px; }

        /* Leaderboard */
        .leaderboard-list { display: flex; flex-direction: column; gap: 6px; }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .leaderboard-item.current-user { border-color: var(--accent); background: rgba(255, 77, 141, 0.1); }
        
        .lb-rank { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; background: var(--bg-elevated); }
        .lb-rank.gold { background: linear-gradient(135deg, #ffd700, #ffb700); color: #1a1a1a; }
        .lb-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #1a1a1a; }
        .lb-rank.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); color: #1a1a1a; }
        
        .lb-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 11px; overflow: hidden; }
        .lb-info { flex: 1; }
        .lb-name { font-size: 12px; font-weight: 600; }
        .lb-name.you { color: var(--accent); }
        .lb-value { font-size: 13px; font-weight: 700; color: var(--accent); text-align: right; }
        .lb-value span { display: block; font-size: 10px; color: var(--text-muted); font-weight: 400; }

        /* Achievements */
        .ach-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .ach-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border);
            opacity: 0.4;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .ach-item:hover { border-color: var(--text-secondary); }
        .ach-item.unlocked { opacity: 1; border-color: var(--warning); background: rgba(251, 191, 36, 0.1); }
        .ach-item.selected { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .ach-icon { width: 32px; height: 32px; margin: 0 auto 6px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; background: var(--bg-elevated); }
        .ach-item.unlocked .ach-icon { background: var(--warning); color: #1a1a1a; }
        .ach-name { font-size: 10px; font-weight: 600; line-height: 1.2; }

        .ach-info-box {
            margin-top: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: left;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .ach-info-box.empty {
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
        }
        .ach-info-title { font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
        .ach-info-desc { font-size: 12px; color: var(--text-secondary); }

        /* Inventory */
        .inventory-section { margin-bottom: 20px; }
        .inv-section-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .inventory-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .inventory-item:hover { border-color: var(--accent); }
        .inv-icon { width: 36px; height: 36px; margin: 0 auto 6px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .inv-name { font-size: 11px; font-weight: 600; }
        .inv-timer { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
        .use-btn { margin-top: 6px; padding: 5px 10px; border-radius: 6px; border: none; background: var(--accent); color: white; font-size: 9px; font-weight: 600; cursor: pointer; }
        .empty-text { text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px; }

        /* Daily Reward Game */
        .daily-info {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .daily-info-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .daily-info-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
        .daily-timer { font-size: 24px; font-weight: 800; color: var(--accent); }
        .daily-streak { font-size: 12px; color: var(--gold); margin-top: 8px; }

        .daily-game {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        .daily-game-title { font-size: 14px; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .daily-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .daily-cell {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .daily-cell:hover { transform: translateY(-4px); border-color: var(--accent); }
        .daily-cell:active { transform: scale(0.95); }
        .daily-cell.revealed { cursor: default; pointer-events: none; }
        .daily-cell.key { background: linear-gradient(135deg, var(--gold), #e6b800); border-color: var(--gold); animation: keyPulse 0.5s ease; }
        .daily-cell.bomb { background: linear-gradient(135deg, var(--danger), #dc2626); border-color: var(--danger); animation: bombShake 0.5s ease; }
        .daily-cell.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        @keyframes keyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes bombShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .explosion-effect {
            position: fixed;
            pointer-events: none;
            z-index: 250;
            animation: explode 0.6s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(3) rotate(360deg);
                opacity: 0;
            }
        }

        .explosion-particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 250;
            animation: explodeParticle 0.8s ease-out forwards;
        }

        @keyframes explodeParticle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--ex), var(--ey)) scale(0);
                opacity: 0;
            }
        }

        .screen-shake {
            animation: screenShake 0.5s ease-in-out;
        }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -5px); }
            20% { transform: translate(10px, 5px); }
            30% { transform: translate(-8px, 3px); }
            40% { transform: translate(8px, -3px); }
            50% { transform: translate(-5px, 5px); }
            60% { transform: translate(5px, -5px); }
            70% { transform: translate(-3px, 2px); }
            80% { transform: translate(3px, -2px); }
            90% { transform: translate(-1px, 1px); }
        }

        .daily-progress {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .daily-progress .keys { color: var(--gold); }
        .daily-reset-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .daily-reset-btn:active { transform: scale(0.95); }
        .daily-reset-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .daily-reward-display {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-top: 16px;
            border: 2px solid var(--gold);
        }
        .daily-reward-display .reward-icon { font-size: 48px; margin-bottom: 8px; }
        .daily-reward-display .reward-name { font-size: 16px; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
        .daily-reward-display .reward-desc { font-size: 12px; color: var(--text-secondary); }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 12px; left: 8px; right: 8px;
            z-index: 100;
            background: rgba(20, 20, 28, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 4px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            margin-bottom: env(safe-area-inset-bottom);
        }
        .nav-items { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            max-width: 100%; 
            margin: 0 auto; 
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 2px;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s ease;
            min-width: 0;
            flex: 1;
            overflow: hidden;
        }
        .nav-item.active { 
            color: var(--accent); 
            background: rgba(255, 77, 141, 0.12);
        }
        .nav-item:active { transform: scale(0.92); }
        .nav-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .nav-label { 
            font-size: 9px; 
            font-weight: 600; 
            white-space: nowrap;
            letter-spacing: -0.2px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-overlay.active .modal { transform: scale(1); }

        .modal-icon {
            width: 60px; height: 60px;
            margin: 0 auto 14px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            animation: popIn 0.4s ease;
        }
        @keyframes popIn { 0% { transform: scale(0) rotate(-10deg); } 60% { transform: scale(1.1) rotate(5deg); } 100% { transform: scale(1) rotate(0); } }

        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .modal-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; }
        .modal-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--accent); color: white; font-size: 13px; font-weight: 600; cursor: pointer; }

        .profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .profile-stat { background: var(--bg-elevated); border-radius: 10px; padding: 8px; }
        .profile-stat-val { font-size: 14px; font-weight: 700; color: var(--accent); }
        .profile-stat-label { font-size: 9px; color: var(--text-muted); }

        .ach-info-display {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 10px;
            min-height: 40px;
            margin-bottom: 16px;
            text-align: left;
            border-left: 3px solid var(--accent);
        }
        .ach-info-title-modal { font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 2px; }
        .ach-info-desc-modal { font-size: 11px; color: var(--text-secondary); }

        /* Toast */
        .toast {
            position: fixed;
            top: 80px; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-elevated);
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            max-width: 90%;
            text-align: center;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--danger); color: var(--danger); }

        /* Effects */
        .particle {
            position: fixed;
            width: 6px; height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: partMove 0.6s ease-out forwards;
            z-index: 150;
        }
        
        .heart-particle {
            position: fixed;
            font-size: 16px;
            pointer-events: none;
            animation: heartFloat 1s ease-out forwards;
            z-index: 150;
            color: #ff4d8d;
            opacity: 0;
        }

        @keyframes partMove { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } }
        @keyframes heartFloat { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.5); } }

        .float-num {
            position: fixed;
            font-size: 28px;
            font-weight: 900;
            pointer-events: none;
            animation: floatUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 150;
            color: var(--accent);
            text-shadow: 0 4px 12px rgba(255, 77, 141, 0.6);
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.2);
        }
        @keyframes floatUp { 
            0% { opacity: 0; transform: translateY(20px) scale(0.5) rotate(-10deg); } 
            20% { opacity: 1; transform: translateY(0) scale(1.2) rotate(5deg); }
            100% { opacity: 0; transform: translateY(-120px) scale(1.5) rotate(15deg); } 
        }

        .effect-pill { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; margin: 2px; }
        .effect-pill.buff { background: rgba(74, 222, 128, 0.2); border: 1px solid var(--success); color: var(--success); }
        .effect-pill.debuff { background: rgba(248, 113, 113, 0.2); border: 1px solid var(--danger); color: var(--danger); }

        .RARITY-COMMON { background: #3a3a4a; border: 2px solid #5a5a6a; }
        .RARITY-RARE { background: linear-gradient(135deg, #b366ff, #8b5cf6); border: 2px solid #b366ff; }
        .RARITY-EPIC { background: linear-gradient(135deg, #fbbf24, #f59e0b); border: 2px solid #fbbf24; }
        .RARITY-LEGENDARY { background: linear-gradient(135deg, #ff4d8d, #f43f5e); border: 2px solid #ff4d8d; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <header class="header">
        <div class="header-content">
            <div class="user-section">
                <div class="user-avatar" id="userAvatar"><span id="avatarLetter">U</span></div>
                <div class="user-info">
                    <h2 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <span id="userRank">–†–∞–Ω–≥: --</span>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-badge coins"><span class="icon">üí∞</span><span id="coinCount">0</span></div>
                <div class="stat-badge size"><span class="icon">üìè</span><span id="sizeCount">0</span></div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Game -->
        <section class="tab-content active" id="gameTab">
            <div class="game-section">
                <div id="activeEffectsBar" style="min-height: 24px; margin-bottom: 8px;"></div>
                
                <div class="model-container" id="modelContainer">
                    <canvas class="model-canvas" id="modelCanvas"></canvas>
                    <div class="size-indicator">
                        –†–∞–∑–º–µ—Ä: <span id="modelSize">0</span>
                    </div>
                </div>

                <div class="level-bar-container">
                    <div class="level-info">
                        <span id="currentLevel">–£—Ä–æ–≤–µ–Ω—å 1</span>
                        <span id="nextLevelBonus">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x1.00</span>
                    </div>
                    <div class="level-progress-bg">
                        <div class="level-progress-fill" id="levelProgress" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-top: 4px;">
                        üí° –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É–º–Ω–æ–∂–∞–µ—Ç –≤–µ—Å—å –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞
                    </div>
                </div>

                <div class="click-controls">
                    <div class="per-click">–ó–∞ –∫–ª–∏–∫: <strong id="perClickVal">+1</strong></div>

                    <div class="exchange-section">
                        <div class="exchange-title">–û–±–º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–∞ –º–æ–Ω–µ—Ç—ã</div>
                        <div class="exchange-row">
                            <input type="number" class="exchange-input" id="exchangeAmount" placeholder="–†–∞–∑–º–µ—Ä" min="1" value="10">
                            <button class="exchange-btn" id="exchangeBtn">–û–±–º–µ–Ω</button>
                        </div>
                        <div class="exchange-rate">–ö—É—Ä—Å: 1 –µ–¥. —Ä–∞–∑–º–µ—Ä–∞ = 3 –º–æ–Ω–µ—Ç—ã</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Upgrades -->
        <section class="tab-content" id="upgradeTab">
            <div class="section-content">
                <div class="section-header">
                    <h2 class="section-title">–ü—Ä–æ–∫–∞—á–∫–∞</h2>
                </div>
                <div class="upgrade-grid" id="upgradeGrid"></div>
            </div>
        </section>

        <!-- Shop -->
        <section class="tab-content" id="shopTab">
            <div class="section-content">
                <div class="section-header">
                    <h2 class="section-title">–ú–∞–≥–∞–∑–∏–Ω</h2>
                    <span class="shop-timer" id="shopTimer">--:--:--</span>
                </div>
                <div class="shop-grid" id="shopGrid"></div>
            </div>
        </section>

        <!-- Cases -->
        <section class="tab-content" id="casesTab">
            <div class="section-content">
                <div class="section-header"><h2 class="section-title">–ö–µ–π—Å—ã</h2></div>
                <div class="cases-grid" id="casesGrid"></div>
            </div>
        </section>

        <!-- Top -->
        <section class="tab-content" id="topTab">
            <div class="section-content">
                <div class="section-header"><h2 class="section-title">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2></div>
                <div class="leaderboard-list" id="leaderboardList"></div>
            </div>
        </section>

        <!-- Achievements -->>
        <section class="tab-content" id="achTab">
            <div class="section-content">
                <div class="section-header">
                    <h2 class="section-title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                    <span id="achProgress">0/0</span>
                </div>
                <div class="ach-grid" id="achGrid"></div>
                <div id="achInfoBox" class="ach-info-box empty">
                    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —É—Å–ª–æ–≤–∏–µ
                </div>
            </div>
        </section>

        <!-- Inventory -->
        <section class="tab-content" id="inventoryTab">
            <div class="section-content">
                <div class="inventory-section">
                    <div class="inv-section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                    <div class="inventory-grid" id="activeItems"></div>
                    <div class="empty-text" id="noActive">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤</div>
                </div>
                <div class="inventory-section">
                    <div class="inv-section-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
                    <div class="inventory-grid" id="inventoryGrid"></div>
                    <div class="empty-text" id="noInventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>
                </div>
            </div>
        </section>

        <!-- Daily Reward -->
        <section class="tab-content" id="dailyTab">
            <div class="section-content">
                <div class="section-header">
                    <h2 class="section-title">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</h2>
                </div>
                <div id="dailyRewardContent"></div>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-items">
            <button class="nav-item active" data-tab="gameTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>
                <span class="nav-label">–ò–≥—Ä–∞</span>
            </button>
            <button class="nav-item" data-tab="upgradeTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <span class="nav-label">–ü—Ä–æ–∫–∞—á–∫–∞</span>
            </button>
            <button class="nav-item" data-tab="shopTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                <span class="nav-label">–ú–∞–≥–∞–∑–∏–Ω</span>
            </button>
            <button class="nav-item" data-tab="casesTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
                <span class="nav-label">–ö–µ–π—Å—ã</span>
            </button>

            <button class="nav-item" data-tab="topTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 21h8M12 17v4M17 3H7l-2 8h14l-2-8z"/><circle cx="12" cy="11" r="2"/></svg>
                <span class="nav-label">–¢–æ–ø</span>
            </button>

            <button class="nav-item" data-tab="achTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                <span class="nav-label">–ê—á–∏–≤–∫–∏</span>
            </button>
            <button class="nav-item" data-tab="inventoryTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="14" rx="2"/><path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                <span class="nav-label">–°—É–º–∫–∞</span>
            </button>
            <button class="nav-item" data-tab="dailyTab">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                <span class="nav-label">–ù–∞–≥—Ä–∞–¥–∞</span>
            </button>
        </div>
    </nav>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-icon" id="modalIcon"></div>
            <h3 class="modal-title" id="modalTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
            <p class="modal-desc" id="modalDesc">–û–ø–∏—Å–∞–Ω–∏–µ</p>
            <div id="modalProfileStats"></div>
            <div id="modalAchGrid"></div>
            <div class="ach-info-display" id="achInfoDisplay" style="display:none;">
                <div class="ach-info-title-modal" id="achInfoTitle"></div>
                <div class="ach-info-desc-modal" id="achInfoDesc"></div>
            </div>
            <button class="modal-btn" id="modalBtn">OK</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Anti-AutoClicker System -->
    <script src="anti-autoclicker.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ============================================
        // ECONOMY SCALING SYSTEM
        // ============================================
        
        function getProgressTier() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º "—É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞" –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞
            if (state.size < 500) return 1;
            if (state.size < 2000) return 2;
            if (state.size < 5000) return 3;
            if (state.size < 10000) return 4;
            if (state.size < 25000) return 5;
            if (state.size < 50000) return 6;
            if (state.size < 100000) return 7;
            return 8;
        }
        
        function getPriceMultiplier() {
            // –ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ü–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const tier = getProgressTier();
            const multipliers = [1, 1, 1.2, 1.5, 2, 3, 4.5, 7, 10];
            return multipliers[tier] || 1;
        }
        
        function getScaledPrice(basePrice) {
            return Math.floor(basePrice * getPriceMultiplier());
        }

        // ============================================
        // CONFIG & STATE
        // ============================================
        
        const SHOP_REFRESH_MS = 24 * 60 * 60 * 1000;
        const EXCHANGE_RATE = 3;
        const SIZE_PER_LEVEL = 100;
        const DAILY_REWARD_COOLDOWN = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
        
        // Firebase Configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyB1ruI165WFEB-x0PxBK0-aTgz-bIR7kuY",
            authDomain: "sisya-clicker.firebaseapp.com",
            databaseURL: "https://sisya-clicker-default-rtdb.firebaseio.com",
            projectId: "sisya-clicker",
            storageBucket: "sisya-clicker.firebasestorage.app",
            messagingSenderId: "657572523974",
            appId: "1:657572523974:web:a43b0fa0dbf18138e14cc7",
            measurementId: "G-FS3BR77SYR"
        };

        const DAILY_REWARDS = [
            // –û–±—ã—á–Ω—ã–µ (70% —à–∞–Ω—Å)
            { id: 'small_mult', name: '–ë—É—Å—Ç x2', desc: 'x2 –∫ –∫–ª–∏–∫—É –Ω–∞ 5 –º–∏–Ω—É—Ç', icon: '‚ö°', rarity: 'common', weight: 30, effect: { type: 'multiply', value: 2 }, duration: 300000, color: '#4ade80' },
            { id: 'small_size', name: '–†–∞–∑–º–µ—Ä +50', desc: '–ù–µ–±–æ–ª—å—à–∞—è –ø—Ä–∏–±–∞–≤–∫–∞', icon: 'üìè', rarity: 'common', weight: 25, effect: { type: 'instantSizePercent', value: 0.05 }, duration: 0, color: '#60a5fa' },
            { id: 'small_coins', name: '–ú–æ–Ω–µ—Ç—ã', desc: '+5% –æ—Ç —Ç–µ–∫—É—â–∏—Ö', icon: 'üí∞', rarity: 'common', weight: 15, effect: { type: 'instantCoinsPercent', value: 0.05 }, duration: 0, color: '#fcd34d' },
            
            // –†–µ–¥–∫–∏–µ (20% —à–∞–Ω—Å)
            { id: 'medium_mult', name: '–£—Å–∏–ª–∏—Ç–µ–ª—å x5', desc: 'x5 –∫ –∫–ª–∏–∫—É –Ω–∞ 10 –º–∏–Ω—É—Ç', icon: 'üí∏', rarity: 'rare', weight: 10, effect: { type: 'multiply', value: 5 }, duration: 600000, color: '#b366ff' },
            { id: 'medium_auto', name: '–ê–≤—Ç–æ-–∫–ª–∏–∫', desc: '2 –∫–ª–∏–∫–∞/—Å–µ–∫ –Ω–∞ 10 –º–∏–Ω—É—Ç', icon: 'ü§ñ', rarity: 'rare', weight: 8, effect: { type: 'autoclick', value: 2 }, duration: 600000, color: '#8b5cf6' },
            { id: 'medium_size', name: '–†–∞–∑–º–µ—Ä +10%', desc: '–û—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞', icon: 'üìê', rarity: 'rare', weight: 2, effect: { type: 'instantSizePercent', value: 0.10 }, duration: 0, color: '#3b82f6' },
            
            // –≠–ø–∏—á–µ—Å–∫–∏–µ (8% —à–∞–Ω—Å)
            { id: 'epic_mult', name: '–ú–µ–≥–∞ x10', desc: 'x10 –∫ –∫–ª–∏–∫—É –Ω–∞ 15 –º–∏–Ω—É—Ç', icon: 'üí´', rarity: 'epic', weight: 4, effect: { type: 'multiply', value: 10 }, duration: 900000, color: '#fbbf24' },
            { id: 'epic_size', name: '–†–∞–∑–º–µ—Ä +20%', desc: '–ë–æ–ª—å—à–∞—è –ø—Ä–∏–±–∞–≤–∫–∞', icon: 'üíé', rarity: 'epic', weight: 3, effect: { type: 'instantSizePercent', value: 0.20 }, duration: 0, color: '#10b981' },
            { id: 'epic_coins', name: '–ú–æ–Ω–µ—Ç—ã +15%', desc: '–û—Ç —Ç–µ–∫—É—â–∏—Ö –º–æ–Ω–µ—Ç', icon: 'üí∏', rarity: 'epic', weight: 1, effect: { type: 'instantCoinsPercent', value: 0.15 }, duration: 0, color: '#f59e0b' },
            
            // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ (2% —à–∞–Ω—Å)
            { id: 'legend_mult', name: '–£–õ–¨–¢–†–ê x20', desc: 'x20 –∫ –∫–ª–∏–∫—É –Ω–∞ 20 –º–∏–Ω—É—Ç', icon: 'üåü', rarity: 'legendary', weight: 1, effect: { type: 'multiply', value: 20 }, duration: 1200000, color: '#ff4d8d' },
            { id: 'legend_auto', name: '–ê–≤—Ç–æ-–∫–ª–∏–∫ –ú–ê–ö–°', desc: '5 –∫–ª–∏–∫–æ–≤/—Å–µ–∫ –Ω–∞ 15 –º–∏–Ω—É—Ç', icon: '‚ö°', rarity: 'legendary', weight: 0.5, effect: { type: 'autoclick', value: 5 }, duration: 900000, color: '#ec4899' },
            { id: 'legend_jackpot', name: '–î–ñ–ï–ö–ü–û–¢', desc: '+30% —Ä–∞–∑–º–µ—Ä–∞ –∏ –º–æ–Ω–µ—Ç', icon: 'üëë', rarity: 'legendary', weight: 0.5, effect: { type: 'jackpot', value: 0.30 }, duration: 0, color: '#fbbf24' },
        ];

        let state = {
            coins: 0,
            size: 0,
            totalClicks: 0,
            totalPlayTime: 0,
            inventory: [],
            activeEffects: [],
            unlockedAchievements: [],
            statsCases: 0,
            statsExchanges: 0,
            statsBuffsUsed: 0,
            upgrades: {},
            userId: 'local_' + Math.random().toString(36).substr(2, 9),
            userName: '–ò–≥—Ä–æ–∫',
            shopLastUpdate: Date.now(),
            dailyRewardLastClaim: 0,
            dailyRewardStreak: 0
        };

        // ============================================
        // ANTI-AUTOCLICKER SYSTEM
        // ============================================
        
        let antiCheat = null;

        // ============================================
        // UPGRADES SYSTEM
        // ============================================

        const UPGRADES = [
            {
                id: 'click_power',
                name: '–°–∏–ª–∞ –∫–ª–∏–∫–∞',
                desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∫–ª–∏–∫',
                icon: 'üëÜ',
                color: '#ff4d8d',
                category: 'click',
                maxLevel: 50,
                costType: 'size',
                baseCost: 50,
                costScale: 1.8,
                costExponent: 1.15,
                effect: (lvl) => ({ clickBonus: lvl * 1 }),
                effectDesc: (lvl) => `+${lvl} –∫ –±–∞–∑–æ–≤–æ–º—É –∫–ª–∏–∫—É`
            },
            {
                id: 'click_multi',
                name: '–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä',
                desc: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∏–ª—ã –∫–ª–∏–∫–∞',
                icon: '‚úñÔ∏è',
                color: '#b366ff',
                category: 'click',
                maxLevel: 25,
                costType: 'size',
                baseCost: 500,
                costScale: 2.5,
                costExponent: 1.25,
                effect: (lvl) => ({ clickMulti: 1 + lvl * 0.15 }),
                effectDesc: (lvl) => `x${(1 + lvl * 0.15).toFixed(2)} –∫ –∫–ª–∏–∫—É`
            },
            {
                id: 'critical_chance',
                name: '–ö—Ä–∏—Ç. —à–∞–Ω—Å',
                desc: '–®–∞–Ω—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª–∏–∫–∞ (x5)',
                icon: 'üí•',
                color: '#f59e0b',
                category: 'click',
                maxLevel: 20,
                costType: 'size',
                baseCost: 1000,
                costScale: 3.0,
                costExponent: 1.3,
                effect: (lvl) => ({ critChance: lvl * 0.02 }),
                effectDesc: (lvl) => `${(lvl * 2)}% —à–∞–Ω—Å –∫—Ä–∏—Ç–∞`
            },
            {
                id: 'auto_clicker',
                name: '–ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä',
                desc: '–ü–∞—Å—Å–∏–≤–Ω—ã–π —Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤ —Å–µ–∫—É–Ω–¥—É',
                icon: 'ü§ñ',
                color: '#4ade80',
                category: 'passive',
                maxLevel: 30,
                costType: 'size',
                baseCost: 2000,
                costScale: 2.8,
                costExponent: 1.22,
                effect: (lvl) => ({ autoPerSec: lvl }),
                effectDesc: (lvl) => `+${lvl}/—Å–µ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`
            },
            {
                id: 'exchange_rate',
                name: '–ö—É—Ä—Å –æ–±–º–µ–Ω–∞',
                desc: '–£–ª—É—á—à–∞–µ—Ç –∫—É—Ä—Å —Ä–∞–∑–º–µ—Ä ‚Üí –º–æ–Ω–µ—Ç—ã',
                icon: 'üí±',
                color: '#fcd34d',
                category: 'economy',
                maxLevel: 20,
                costType: 'size',
                baseCost: 3000,
                costScale: 3.5,
                costExponent: 1.35,
                effect: (lvl) => ({ exchangeBonus: lvl * 1 }),
                effectDesc: (lvl) => `+${lvl} –∫ –∫—É—Ä—Å—É –æ–±–º–µ–Ω–∞ (=${3 + lvl})`
            },
            {
                id: 'coin_magnet',
                name: '–ú–æ–Ω–µ—Ç–Ω—ã–π –º–∞–≥–Ω–∏—Ç',
                desc: '–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –º–æ–Ω–µ—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ',
                icon: 'üß≤',
                color: '#60a5fa',
                category: 'economy',
                maxLevel: 15,
                costType: 'coins',
                baseCost: 5000,
                costScale: 4.0,
                costExponent: 1.4,
                effect: (lvl) => ({ coinChance: lvl * 0.03, coinAmount: Math.ceil(lvl * 2) }),
                effectDesc: (lvl) => `${(lvl * 3)}% —à–∞–Ω—Å +${Math.ceil(lvl * 2)} –º–æ–Ω–µ—Ç/–∫–ª–∏–∫`
            },
            {
                id: 'level_speed',
                name: '–°–∫–æ—Ä–æ—Å—Ç—å —É—Ä–æ–≤–Ω—è',
                desc: '–£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –¥–ª—è —É—Ä–æ–≤–Ω—è',
                icon: '‚ö°',
                color: '#8b5cf6',
                category: 'passive',
                maxLevel: 10,
                costType: 'size',
                baseCost: 5000,
                costScale: 5.0,
                costExponent: 1.5,
                effect: (lvl) => ({ levelReduction: lvl * 5 }),
                effectDesc: (lvl) => `-${lvl * 5} –∫ —Ä–∞–∑–º–µ—Ä—É –¥–ª—è —É—Ä–æ–≤–Ω—è`
            },
            {
                id: 'lucky_star',
                name: '–°—á–∞—Å—Ç–ª–∏–≤–∞—è –∑–≤–µ–∑–¥–∞',
                desc: '–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å x10 –æ—Ç –∫–ª–∏–∫–∞',
                icon: '‚≠ê',
                color: '#ff6b6b',
                category: 'click',
                maxLevel: 10,
                costType: 'coins',
                baseCost: 50000,
                costScale: 5.5,
                costExponent: 1.55,
                effect: (lvl) => ({ luckyChance: lvl * 0.005 }),
                effectDesc: (lvl) => `${(lvl * 0.5).toFixed(1)}% —à–∞–Ω—Å x10`
            },
            {
                id: 'prestige_power',
                name: '–ü—Ä–µ—Å—Ç–∏–∂–Ω–∞—è –º–æ—â—å',
                desc: '–ë–æ–Ω—É—Å –æ—Ç —É—Ä–æ–≤–Ω—è —É–≤–µ–ª–∏—á–µ–Ω',
                icon: 'üëë',
                color: '#ffd700',
                category: 'passive',
                maxLevel: 15,
                costType: 'size',
                baseCost: 10000,
                costScale: 4.0,
                costExponent: 1.45,
                effect: (lvl) => ({ levelBonusMod: lvl * 0.5 }),
                effectDesc: (lvl) => `+${(lvl * 0.5).toFixed(1)}% –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å`
            },
            {
                id: 'diamond_touch',
                name: '–ê–ª–º–∞–∑–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ',
                desc: '–°—É–ø–µ—Ä-–º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –≤—Å–µ–≥–æ',
                icon: 'üíé',
                color: '#00ffff',
                category: 'click',
                maxLevel: 5,
                costType: 'size',
                baseCost: 100000,
                costScale: 10.0,
                costExponent: 2.0,
                effect: (lvl) => ({ globalMulti: 1 + lvl * 0.5 }),
                effectDesc: (lvl) => `x${(1 + lvl * 0.5).toFixed(1)} –∫–æ –≤—Å–µ–º—É`
            }
        ];

        function getUpgradeLevel(id) {
            return state.upgrades[id] || 0;
        }

        function getUpgradeCost(upgrade) {
            const lvl = getUpgradeLevel(upgrade.id);
            if (lvl >= upgrade.maxLevel) return Infinity;
            const baseCost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costScale, lvl) * Math.pow(lvl + 1, upgrade.costExponent));
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫ –∞–ø–≥—Ä–µ–π–¥–∞–º –∑–∞ —Ä–∞–∑–º–µ—Ä
            if (upgrade.costType === 'size') {
                return getScaledPrice(baseCost);
            }
            return baseCost;
        }

        function getUpgradeEffect(id) {
            const upgrade = UPGRADES.find(u => u.id === id);
            if (!upgrade) return {};
            const lvl = getUpgradeLevel(id);
            return lvl > 0 ? upgrade.effect(lvl) : {};
        }

        function getAllUpgradeEffects() {
            const combined = {
                clickBonus: 0,
                clickMulti: 1,
                critChance: 0,
                autoPerSec: 0,
                exchangeBonus: 0,
                coinChance: 0,
                coinAmount: 0,
                levelReduction: 0,
                luckyChance: 0,
                levelBonusMod: 0,
                globalMulti: 1
            };
            
            UPGRADES.forEach(u => {
                const eff = getUpgradeEffect(u.id);
                Object.keys(eff).forEach(key => {
                    if (key === 'clickMulti' || key === 'globalMulti') {
                        combined[key] *= eff[key];
                    } else {
                        combined[key] = (combined[key] || 0) + (eff[key] || 0);
                    }
                });
            });
            
            return combined;
        }

        function buyUpgrade(upgrade) {
            const lvl = getUpgradeLevel(upgrade.id);
            if (lvl >= upgrade.maxLevel) return showToast('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!', 'error');
            
            const cost = getUpgradeCost(upgrade);
            
            if (upgrade.costType === 'size') {
                if (state.size < cost) return showToast(`–ù—É–∂–Ω–æ ${cost.toLocaleString()} —Ä–∞–∑–º–µ—Ä–∞!`, 'error');
                state.size -= cost;
                updateTargetScale();
            } else {
                if (state.coins < cost) return showToast(`–ù—É–∂–Ω–æ ${cost.toLocaleString()} –º–æ–Ω–µ—Ç!`, 'error');
                state.coins -= cost;
            }
            
            state.upgrades[upgrade.id] = lvl + 1;
            playSound('buy');
            
            const newEffect = upgrade.effect(lvl + 1);
            showToast(`${upgrade.name} ‚Üí –£—Ä.${lvl + 1}!`, 'success');
            
            renderUpgrades();
            updateUI();
            saveState();
        }

        function renderUpgrades() {
            const grid = els.upgradeGrid;
            grid.innerHTML = '';
            
            const categories = {
                click: '–ö–ª–∏–∫',
                passive: '–ü–∞—Å—Å–∏–≤–Ω—ã–µ',
                economy: '–≠–∫–æ–Ω–æ–º–∏–∫–∞'
            };
            
            const grouped = {};
            UPGRADES.forEach(u => {
                if (!grouped[u.category]) grouped[u.category] = [];
                grouped[u.category].push(u);
            });
            
            Object.keys(categories).forEach(cat => {
                if (!grouped[cat]) return;
                
                const catLabel = document.createElement('div');
                catLabel.className = 'upgrade-category';
                catLabel.textContent = categories[cat];
                grid.appendChild(catLabel);
                
                grouped[cat].forEach(upgrade => {
                    const lvl = getUpgradeLevel(upgrade.id);
                    const cost = getUpgradeCost(upgrade);
                    const isMaxed = lvl >= upgrade.maxLevel;
                    const effects = getAllUpgradeEffects();
                    
                    const canAfford = upgrade.costType === 'size' 
                        ? state.size >= cost 
                        : state.coins >= cost;
                    
                    const card = document.createElement('div');
                    card.className = `upgrade-card ${isMaxed ? 'maxed' : ''}`;
                    
                    const progressPct = (lvl / upgrade.maxLevel) * 100;
                    const progressColor = upgrade.color;
                    
                    card.innerHTML = `
                        <div class="upgrade-top">
                            <div class="upgrade-icon" style="background: ${upgrade.color}20; color: ${upgrade.color}; border: 2px solid ${upgrade.color}40;">
                                ${upgrade.icon}
                            </div>
                            <div class="upgrade-info">
                                <div class="upgrade-name">${upgrade.name}</div>
                                <div class="upgrade-desc">${upgrade.desc}</div>
                                <div class="upgrade-level-badge">–£—Ä–æ–≤–µ–Ω—å ${lvl}/${upgrade.maxLevel}</div>
                                ${lvl > 0 ? `<div class="upgrade-effect-preview">‚úì ${upgrade.effectDesc(lvl)}</div>` : ''}
                            </div>
                        </div>
                        <div class="upgrade-bottom">
                            <div class="upgrade-cost">
                                <div class="upgrade-cost-label">${isMaxed ? '–ú–ê–ö–°' : '–¶–µ–Ω–∞'}</div>
                                <div class="upgrade-cost-value ${upgrade.costType === 'coins' ? 'coins-cost' : ''}">
                                    ${isMaxed ? '‚Äî' : (upgrade.costType === 'size' ? 'üìè ' : 'üí∞ ') + cost.toLocaleString()}
                                </div>
                            </div>
                            <div class="upgrade-progress-bar">
                                <div class="upgrade-progress-fill" style="width: ${progressPct}%; background: ${upgrade.color};"></div>
                            </div>
                            <button class="upgrade-buy-btn ${upgrade.costType === 'size' ? 'size-btn' : 'coins-btn'}" 
                                    ${isMaxed || !canAfford ? 'disabled' : ''}>
                                ${isMaxed ? '–ú–ê–ö–°' : '–ö—É–ø–∏—Ç—å'}
                            </button>
                        </div>
                    `;
                    
                    if (!isMaxed) {
                        card.querySelector('.upgrade-buy-btn').addEventListener('click', () => {
                            window.haptic('medium');
                            buyUpgrade(upgrade);
                        });
                    }
                    
                    grid.appendChild(card);
                });
            });
        }

        // Data
        const ACHIEVEMENTS = [
            { id: 'click1', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫', icon: '1', condition: s => s.totalClicks >= 1 },
            { id: 'size10', name: '–ù–∞—á–∞–ª–æ', desc: '–†–∞–∑–º–µ—Ä 10', icon: 'S', condition: s => s.size >= 10 },
            { id: 'click100', name: '–°—Ç–∞—Ä–∞—Ç–µ–ª—å–Ω—ã–π', desc: '100 –∫–ª–∏–∫–æ–≤', icon: 'C', condition: s => s.totalClicks >= 100 },
            { id: 'size100', name: '–ó–∞–º–µ—Ç–Ω—ã–π', desc: '–†–∞–∑–º–µ—Ä 100', icon: 'S', condition: s => s.size >= 100 },
            { id: 'time10m', name: '–ò–≥—Ä–æ–∫', desc: '–ò–≥—Ä–∞–π 10 –º–∏–Ω—É—Ç', icon: 'T', condition: s => s.totalPlayTime >= 600000 },
            { id: 'click1000', name: '–ú–∞—Å—Ç–µ—Ä –∫–ª–∏–∫–∞', desc: '1000 –∫–ª–∏–∫–æ–≤', icon: 'M', condition: s => s.totalClicks >= 1000 },
            { id: 'size1000', name: '–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã–π', desc: '–†–∞–∑–º–µ—Ä 1000', icon: 'S', condition: s => s.size >= 1000 },
            { id: 'coins10k', name: '–ë–æ–≥–∞—á', desc: '10,000 –º–æ–Ω–µ—Ç', icon: '$', condition: s => s.coins >= 10000 },
            { id: 'case10', name: '–ê–∑–∞—Ä—Ç–Ω—ã–π', desc: '–û—Ç–∫—Ä–æ–π 10 –∫–µ–π—Å–æ–≤', icon: '?', condition: s => s.statsCases >= 10 },
            { id: 'click5000', name: '–õ–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞', desc: '5000 –∫–ª–∏–∫–æ–≤', icon: 'L', condition: s => s.totalClicks >= 5000 },
            { id: 'size5000', name: '–ò–¥–µ–∞–ª', desc: '–†–∞–∑–º–µ—Ä 5000', icon: 'S', condition: s => s.size >= 5000 },
            { id: 'time1h', name: '–ü—Ä–µ–¥–∞–Ω–Ω—ã–π', desc: '–ò–≥—Ä–∞–π 1 —á–∞—Å', icon: 'T', condition: s => s.totalPlayTime >= 3600000 },
            { id: 'case50', name: '–û—Ö–æ—Ç–Ω–∏–∫', desc: '–û—Ç–∫—Ä–æ–π 50 –∫–µ–π—Å–æ–≤', icon: '?', condition: s => s.statsCases >= 50 },
            { id: 'click10000', name: '–ö–ª–∏–∫-–º–∞—à–∏–Ω–∞', desc: '10,000 –∫–ª–∏–∫–æ–≤', icon: '!', condition: s => s.totalClicks >= 10000 },
            { id: 'size10000', name: '–ë–æ–≥–∏–Ω—è', desc: '–†–∞–∑–º–µ—Ä 10,000', icon: 'G', condition: s => s.size >= 10000 },
            { id: 'coins1m', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', desc: '1,000,000 –º–æ–Ω–µ—Ç', icon: '$$', condition: s => s.coins >= 1000000 },
            { id: 'time10h', name: '–ó–∞—Ç—è–∂–Ω–æ–π', desc: '–ò–≥—Ä–∞–π 10 —á–∞—Å–æ–≤', icon: 'TT', condition: s => s.totalPlayTime >= 36000000 },
            { id: 'exchange100', name: '–¢–æ—Ä–≥–æ–≤–µ—Ü', desc: '–û–±–º–µ–Ω—è–π 100 —Ä–∞–∑–º–µ—Ä–∞', icon: 'E', condition: s => s.statsExchanges >= 100 },
            { id: 'buff10', name: '–•–∏–º–∏–∫', desc: '–ò—Å–ø–æ–ª—å–∑—É–π 10 –±–∞—Ñ—Ñ–æ–≤', icon: 'B', condition: s => s.statsBuffsUsed >= 10 },
            { id: 'level10', name: '–û–ø—ã—Ç–Ω—ã–π', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 10 —É—Ä–æ–≤–Ω—è', icon: 'Lv', condition: s => getLevel() >= 10 },
            { id: 'upgrade5', name: '–ê–ø–≥—Ä–µ–π–¥–µ—Ä', desc: '–ö—É–ø–∏ 5 –∞–ø–≥—Ä–µ–π–¥–æ–≤', icon: '‚¨Ü', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 5 },
            { id: 'upgrade20', name: '–ú–∞—Å—Ç–µ—Ä –ø—Ä–æ–∫–∞—á–∫–∏', desc: '–ö—É–ø–∏ 20 –∞–ø–≥—Ä–µ–π–¥–æ–≤', icon: 'üîù', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 20 },
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            { id: 'click10', name: '–ù–æ–≤–∏—á–æ–∫', desc: '–°–¥–µ–ª–∞–π 10 –∫–ª–∏–∫–æ–≤', icon: 'üëã', condition: s => s.totalClicks >= 10 },
            { id: 'click50', name: '–ê–∫—Ç–∏–≤–Ω—ã–π', desc: '–°–¥–µ–ª–∞–π 50 –∫–ª–∏–∫–æ–≤', icon: 'üëè', condition: s => s.totalClicks >= 50 },
            { id: 'click500', name: '–£–ø–æ—Ä–Ω—ã–π', desc: '–°–¥–µ–ª–∞–π 500 –∫–ª–∏–∫–æ–≤', icon: 'üî•', condition: s => s.totalClicks >= 500 },
            { id: 'click2500', name: '–ü—Ä–æ—Ñ–∏', desc: '–°–¥–µ–ª–∞–π 2500 –∫–ª–∏–∫–æ–≤', icon: 'üí´', condition: s => s.totalClicks >= 2500 },
            { id: 'click25000', name: '–ë–æ–≥ –∫–ª–∏–∫–æ–≤', desc: '–°–¥–µ–ª–∞–π 25,000 –∫–ª–∏–∫–æ–≤', icon: 'üëë', condition: s => s.totalClicks >= 25000 },
            { id: 'click50000', name: '–ê–±—Å–æ–ª—é—Ç', desc: '–°–¥–µ–ª–∞–π 50,000 –∫–ª–∏–∫–æ–≤', icon: 'üíé', condition: s => s.totalClicks >= 50000 },
            { id: 'click100000', name: '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å', desc: '–°–¥–µ–ª–∞–π 100,000 –∫–ª–∏–∫–æ–≤', icon: '‚ôæÔ∏è', condition: s => s.totalClicks >= 100000 },
            
            { id: 'size50', name: '–†–∞—Å—Ç—É—â–∏–π', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 50', icon: 'üåø', condition: s => s.size >= 50 },
            { id: 'size500', name: '–í–Ω—É—à–∏—Ç–µ–ª—å–Ω—ã–π', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 500', icon: 'üèîÔ∏è', condition: s => s.size >= 500 },
            { id: 'size2500', name: '–ö–æ–ª–æ—Å—Å–∞–ª—å–Ω—ã–π', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 2500', icon: 'üåã', condition: s => s.size >= 2500 },
            { id: 'size25000', name: '–¢–∏—Ç–∞–Ω', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 25,000', icon: 'ü¶æ', condition: s => s.size >= 25000 },
            { id: 'size50000', name: '–ì–∏–≥–∞–Ω—Ç', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 50,000', icon: 'üóø', condition: s => s.size >= 50000 },
            { id: 'size100000', name: '–í—Å–µ–ª–µ–Ω–Ω–∞—è', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 100,000', icon: 'üåå', condition: s => s.size >= 100000 },
            { id: 'size500000', name: '–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 500,000', icon: 'üå†', condition: s => s.size >= 500000 },
            { id: 'size1000000', name: '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 1,000,000', icon: '‚ú®', condition: s => s.size >= 1000000 },
            
            { id: 'coins100', name: '–ö–æ–ø–∏–ª–∫–∞', desc: '–°–æ–±–µ—Ä–∏ 100 –º–æ–Ω–µ—Ç', icon: 'ü™ô', condition: s => s.coins >= 100 },
            { id: 'coins1000', name: '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', desc: '–°–æ–±–µ—Ä–∏ 1,000 –º–æ–Ω–µ—Ç', icon: 'üí∞', condition: s => s.coins >= 1000 },
            { id: 'coins50k', name: '–°–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π', desc: '–°–æ–±–µ—Ä–∏ 50,000 –º–æ–Ω–µ—Ç', icon: 'üí∏', condition: s => s.coins >= 50000 },
            { id: 'coins100k', name: '–ú–∞–≥–Ω–∞—Ç', desc: '–°–æ–±–µ—Ä–∏ 100,000 –º–æ–Ω–µ—Ç', icon: 'ü§ë', condition: s => s.coins >= 100000 },
            { id: 'coins500k', name: '–û–ª–∏–≥–∞—Ä—Ö', desc: '–°–æ–±–µ—Ä–∏ 500,000 –º–æ–Ω–µ—Ç', icon: 'üíé', condition: s => s.coins >= 500000 },
            
            { id: 'time5m', name: '–õ—é–±–æ–ø—ã—Ç–Ω—ã–π', desc: '–ò–≥—Ä–∞–π 5 –º–∏–Ω—É—Ç', icon: '‚è±Ô∏è', condition: s => s.totalPlayTime >= 300000 },
            { id: 'time30m', name: '–£–≤–ª–µ—á–µ–Ω–Ω—ã–π', desc: '–ò–≥—Ä–∞–π 30 –º–∏–Ω—É—Ç', icon: 'üïê', condition: s => s.totalPlayTime >= 1800000 },
            { id: 'time3h', name: '–§–∞–Ω–∞—Ç', desc: '–ò–≥—Ä–∞–π 3 —á–∞—Å–∞', icon: 'üïí', condition: s => s.totalPlayTime >= 10800000 },
            { id: 'time24h', name: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü', desc: '–ò–≥—Ä–∞–π 24 —á–∞—Å–∞', icon: 'üèÉ', condition: s => s.totalPlayTime >= 86400000 },
            
            { id: 'case1', name: '–ü–µ—Ä–≤—ã–π –∫–µ–π—Å', desc: '–û—Ç–∫—Ä–æ–π –ø–µ—Ä–≤—ã–π –∫–µ–π—Å', icon: 'üì¶', condition: s => s.statsCases >= 1 },
            { id: 'case5', name: '–í–µ–∑—É–Ω—á–∏–∫', desc: '–û—Ç–∫—Ä–æ–π 5 –∫–µ–π—Å–æ–≤', icon: 'üéÅ', condition: s => s.statsCases >= 5 },
            { id: 'case25', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc: '–û—Ç–∫—Ä–æ–π 25 –∫–µ–π—Å–æ–≤', icon: 'üé∞', condition: s => s.statsCases >= 25 },
            { id: 'case100', name: '–ó–∞–≤–∏—Å–∏–º—ã–π', desc: '–û—Ç–∫—Ä–æ–π 100 –∫–µ–π—Å–æ–≤', icon: 'üé™', condition: s => s.statsCases >= 100 },
            
            { id: 'exchange1', name: '–ü–µ—Ä–≤—ã–π –æ–±–º–µ–Ω', desc: '–û–±–º–µ–Ω—è–π —Ä–∞–∑–º–µ—Ä –Ω–∞ –º–æ–Ω–µ—Ç—ã', icon: 'üîÑ', condition: s => s.statsExchanges >= 1 },
            { id: 'exchange10', name: '–ú–µ–Ω—è–ª–∞', desc: '–°–¥–µ–ª–∞–π 10 –æ–±–º–µ–Ω–æ–≤', icon: 'üí±', condition: s => s.statsExchanges >= 10 },
            { id: 'exchange50', name: '–ë–∏—Ä–∂–µ–≤–∏–∫', desc: '–°–¥–µ–ª–∞–π 50 –æ–±–º–µ–Ω–æ–≤', icon: 'üìà', condition: s => s.statsExchanges >= 50 },
            
            { id: 'buff1', name: '–ü–µ—Ä–≤—ã–π –±–∞—Ñ—Ñ', desc: '–ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–≤—ã–π –±–∞—Ñ—Ñ', icon: '‚öóÔ∏è', condition: s => s.statsBuffsUsed >= 1 },
            { id: 'buff5', name: '–ê–ª—Ö–∏–º–∏–∫', desc: '–ò—Å–ø–æ–ª—å–∑—É–π 5 –±–∞—Ñ—Ñ–æ–≤', icon: 'üß™', condition: s => s.statsBuffsUsed >= 5 },
            { id: 'buff25', name: '–ó–µ–ª—å–µ–≤–∞—Ä', desc: '–ò—Å–ø–æ–ª—å–∑—É–π 25 –±–∞—Ñ—Ñ–æ–≤', icon: 'üßô', condition: s => s.statsBuffsUsed >= 25 },
            
            { id: 'level5', name: '–ù–æ–≤–∏—á–æ–∫', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 5 —É—Ä–æ–≤–Ω—è', icon: '5Ô∏è‚É£', condition: s => getLevel() >= 5 },
            { id: 'level20', name: '–í–µ—Ç–µ—Ä–∞–Ω', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 20 —É—Ä–æ–≤–Ω—è', icon: '2Ô∏è‚É£0Ô∏è‚É£', condition: s => getLevel() >= 20 },
            { id: 'level30', name: '–≠–∫—Å–ø–µ—Ä—Ç', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 30 —É—Ä–æ–≤–Ω—è', icon: '3Ô∏è‚É£0Ô∏è‚É£', condition: s => getLevel() >= 30 },
            { id: 'level50', name: '–ú–∞—Å—Ç–µ—Ä', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 50 —É—Ä–æ–≤–Ω—è', icon: '5Ô∏è‚É£0Ô∏è‚É£', condition: s => getLevel() >= 50 },
            { id: 'level100', name: '–õ–µ–≥–µ–Ω–¥–∞', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 100 —É—Ä–æ–≤–Ω—è', icon: 'üíØ', condition: s => getLevel() >= 100 },
            
            { id: 'upgrade1', name: '–ü–µ—Ä–≤—ã–π –∞–ø–≥—Ä–µ–π–¥', desc: '–ö—É–ø–∏ –ø–µ—Ä–≤—ã–π –∞–ø–≥—Ä–µ–π–¥', icon: '‚¨ÜÔ∏è', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 1 },
            { id: 'upgrade10', name: '–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä', desc: '–ö—É–ø–∏ 10 –∞–ø–≥—Ä–µ–π–¥–æ–≤', icon: 'üìà', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 10 },
            { id: 'upgrade50', name: '–ú–∞–∫—Å–∏–º–∞–ª–∏—Å—Ç', desc: '–ö—É–ø–∏ 50 –∞–ø–≥—Ä–µ–π–¥–æ–≤', icon: 'üöÄ', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 50 },
            { id: 'upgrade100', name: '–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç', desc: '–ö—É–ø–∏ 100 –∞–ø–≥—Ä–µ–π–¥–æ–≤', icon: '‚ú®', condition: s => Object.values(s.upgrades).reduce((a, b) => a + b, 0) >= 100 },
            
            { id: 'daily1', name: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫', desc: '–ü–æ–ª—É—á–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É', icon: 'üìÖ', condition: s => s.dailyStreak >= 1 },
            { id: 'daily7', name: '–ù–µ–¥–µ–ª—è', desc: '–°–µ—Ä–∏—è 7 –¥–Ω–µ–π', icon: 'üìÜ', condition: s => s.dailyStreak >= 7 },
            { id: 'daily30', name: '–ú–µ—Å—è—Ü', desc: '–°–µ—Ä–∏—è 30 –¥–Ω–µ–π', icon: 'üóìÔ∏è', condition: s => s.dailyStreak >= 30 },
            { id: 'speedster', name: '–°–ø–∏–¥—Ä–∞–Ω–µ—Ä', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ —Ä–∞–∑–º–µ—Ä–∞ 1000 –∑–∞ 10 –º–∏–Ω—É—Ç', icon: '‚ö°', condition: s => s.size >= 1000 && s.totalPlayTime <= 600000 },
            { id: 'patient', name: '–¢–µ—Ä–ø–µ–ª–∏–≤—ã–π', desc: '–ò–≥—Ä–∞–π –±–µ–∑ –∫–ª–∏–∫–æ–≤ 5 –º–∏–Ω—É—Ç', icon: 'üßò', condition: s => s.totalPlayTime >= 300000 && s.totalClicks === 0 },
        ];

        const SHOP_DB = [
            { id: 'mult2', name: '–£—Å–∏–ª–∏—Ç–µ–ª—å x2', desc: '–î–≤–æ–π–Ω–æ–π —Ä–æ—Å—Ç', icon: '2x', price: 5000, color: '#4ade80', type: 'boost', effect: { type: 'multiply', value: 2 }, duration: 600000 },
            { id: 'auto', name: '–ê–≤—Ç–æ-—Ä–æ—Å—Ç', desc: '–ê–≤—Ç–æ-–∫–ª–∏–∫', icon: 'A', price: 30000, color: '#b366ff', type: 'ability', effect: { type: 'autoclick', value: 1 }, duration: 600000 },
            { id: 'size100', name: '–†–∞–∑–º–µ—Ä +100', desc: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ', icon: '+', price: 15000, color: '#ff4d8d', type: 'instant', effect: { type: 'instantSize', value: 100 }, duration: 0 },
            { id: 'size500', name: '–†–∞–∑–º–µ—Ä +500', desc: '–ë–æ–ª—å—à–∞—è –ø—Ä–∏–±–∞–≤–∫–∞', icon: '++', price: 60000, color: '#ff4d8d', type: 'instant', effect: { type: 'instantSize', value: 500 }, duration: 0 },
            { id: 'mult5', name: '–£—Å–∏–ª–∏—Ç–µ–ª—å x5', desc: '–ú–æ—â–Ω—ã–π –±—É—Å—Ç', icon: '5x', price: 80000, color: '#fbbf24', type: 'boost', effect: { type: 'multiply', value: 5 }, duration: 300000 },
            { id: 'auto2', name: '–ê–≤—Ç–æ-—Ä–æ—Å—Ç PRO', desc: '2 –∫–ª–∏–∫–∞/—Å–µ–∫', icon: 'AA', price: 100000, color: '#b366ff', type: 'ability', effect: { type: 'autoclick', value: 2 }, duration: 600000 },
            { id: 'frenzy', name: '–§—Ä–µ–Ω–∑–∏ x10', desc: '–ë–µ—à–µ–Ω—ã–π —Ä–æ—Å—Ç', icon: 'F', price: 200000, color: '#ff4d8d', type: 'boost', effect: { type: 'multiply', value: 10 }, duration: 180000 },
            { id: 'shield', name: '–©–∏—Ç', desc: '–ë–ª–æ–∫ –¥–µ–±–∞—Ñ—Ñ–∞', icon: 'S', price: 10000, color: '#60a5fa', type: 'shield', effect: { type: 'shield', value: 1 }, duration: 0 },
        ];

        const CASES = [
            { id: 'common', name: '–û–±—ã—á–Ω—ã–π', desc: '–ë–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã', price: 2000, icon: '?', rarity: 'common' },
            { id: 'rare', name: '–†–µ–¥–∫–∏–π', desc: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ', price: 8000, icon: '?', rarity: 'rare' },
            { id: 'epic', name: '–≠–ø–∏—á–µ—Å–∫–∏–π', desc: '–õ—É—á—à–∏–µ –Ω–∞–≥—Ä–∞–¥—ã', price: 25000, icon: '?', rarity: 'epic' }
        ];

        const CASE_REWARDS = [
            { id: 'size20', name: '–†–∞–∑–º–µ—Ä +20', icon: '+', rarity: 'common', weight: 20, type: 'instant', effect: { type: 'instantSize', value: 20 } },
            { id: 'mult2c', name: 'x2 –Ω–∞ 5 –º–∏–Ω', icon: '2x', rarity: 'rare', weight: 10, type: 'boost', effect: { type: 'multiply', value: 2 }, duration: 300000 },
            { id: 'freeze', name: '–ó–∞–º–æ—Ä–æ–∑–∫–∞', icon: 'X', rarity: 'common', weight: 8, type: 'debuff', effect: { type: 'freeze' }, duration: 30000 },
            { id: 'size500', name: '–†–∞–∑–º–µ—Ä +500', icon: '+', rarity: 'epic', weight: 4, type: 'instant', effect: { type: 'instantSize', value: 500 } },
            { id: 'doom', name: '–†–æ–∫ -70%', icon: 'D', rarity: 'legendary', weight: 0.5, type: 'debuff', effect: { type: 'percentLoss', value: 0.7 }, duration: 0 }
        ];

        const RARITY = {
            common: { bg: '#3a3a4a', border: '#5a5a6a', cls: 'RARITY-COMMON' },
            rare: { bg: 'linear-gradient(135deg, #b366ff, #8b5cf6)', border: '#b366ff', cls: 'RARITY-RARE' },
            epic: { bg: 'linear-gradient(135deg, #fbbf24, #f59e0b)', border: '#fbbf24', cls: 'RARITY-EPIC' },
            legendary: { bg: 'linear-gradient(135deg, #ff4d8d, #f43f5e)', border: '#ff4d8d', cls: 'RARITY-LEGENDARY' }
        };

        // –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ Firebase
        let LEADERBOARD_DATA = [];
        let firebaseDB = null;
        let firebaseApp = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        function initFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseDB = getDatabase(firebaseApp);
                console.log('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ Firebase
        async function fetchLeaderboard() {
            console.log('üîÑ [fetchLeaderboard] –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏...');
            
            if (!firebaseDB) {
                console.error('‚ùå Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return [];
            }
            
            try {
                console.log('ÔøΩ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Firebase...');
                const dbRef = ref(firebaseDB);
                const snapshot = await get(child(dbRef, 'players'));
                
                console.log('ÔøΩ –ü–æ–ª—É—á–µ–Ω snapshot:', snapshot);
                console.log('üì¶ snapshot.exists():', snapshot.exists());
                
                if (!snapshot.exists()) {
                    console.warn('üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Firebase (snapshot.exists() = false)');
                    return [];
                }
                
                const playersData = snapshot.val();
                console.log('üìä –î–∞–Ω–Ω—ã–µ –∏–∑ Firebase:', playersData);
                console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π:', Object.keys(playersData || {}).length);
                
                const players = [];
                
                for (const userId in playersData) {
                    const player = playersData[userId];
                    console.log(`üë§ –ò–≥—Ä–æ–∫ ${userId}:`, player);
                    players.push({
                        userId: userId,
                        name: player.name || '–ò–≥—Ä–æ–∫',
                        size: player.size || 0,
                        coins: player.coins || 0,
                        time: player.time || 0,
                        achievements: player.achievements || [],
                        photoUrl: player.photoUrl || null // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
                    });
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä—É (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
                players.sort((a, b) => b.size - a.size);
                
                LEADERBOARD_DATA = players;
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: ${players.length}`);
                if (players.length > 0) {
                    console.log('üèÜ –¢–æ–ø-3:', players.slice(0, 3).map(p => `${p.name}: ${p.size}`));
                }
                return players;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞:', error);
                console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
                console.error('‚ùå Stack:', error.stack);
                return [];
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–≤–æ–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ Firebase
        async function syncPlayerData() {
            if (!firebaseDB) {
                console.log('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ Telegram
                const tg = window.Telegram?.WebApp;
                let photoUrl = null;
                
                if (tg && tg.initDataUnsafe?.user?.photo_url) {
                    photoUrl = tg.initDataUnsafe.user.photo_url;
                }
                
                const playerData = {
                    name: state.userName,
                    size: state.size,
                    coins: state.coins,
                    time: state.totalPlayTime,
                    achievements: state.unlockedAchievements,
                    photoUrl: photoUrl, // –î–æ–±–∞–≤–ª—è–µ–º URL —Ñ–æ—Ç–æ
                    lastUpdate: Date.now()
                };
                
                const playerRef = ref(firebaseDB, `players/${state.userId}`);
                await set(playerRef, playerData);
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å Firebase');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // ============================================
        // AUDIO ENGINE
        // ============================================
        
        let audioCtx;
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                gain.gain.setValueAtTime(0.08, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'squish') {
                // –ó–≤—É–∫ —Å–∂–∞—Ç–∏—è –º—è–≥–∫–æ–π —Ç–∫–∞–Ω–∏ - –Ω–∏–∑–∫–∏–π "—Ö–ª—é–ø–∞—é—â–∏–π" –∑–≤—É–∫
                osc.type = 'sine';
                
                // –ü–µ—Ä–≤–∞—è —Ñ–∞–∑–∞ - —Å–∂–∞—Ç–∏–µ (–ø–æ–Ω–∏–∂–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã)
                osc.frequency.setValueAtTime(180, now);
                osc.frequency.exponentialRampToValueAtTime(120, now + 0.08);
                osc.frequency.exponentialRampToValueAtTime(160, now + 0.15);
                
                gain.gain.setValueAtTime(0.12, now);
                gain.gain.exponentialRampToValueAtTime(0.08, now + 0.08);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.18);
                
                osc.start(now);
                osc.stop(now + 0.18);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π —Å–ª–æ–π –¥–ª—è "–º—è–≥–∫–æ—Å—Ç–∏"
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(90, now);
                osc2.frequency.exponentialRampToValueAtTime(70, now + 0.1);
                osc2.frequency.exponentialRampToValueAtTime(85, now + 0.16);
                
                gain2.gain.setValueAtTime(0.06, now);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.16);
                
                osc2.start(now + 0.02);
                osc2.stop(now + 0.18);
            } else if (type === 'buy') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.setValueAtTime(900, now + 0.1);
                gain.gain.setValueAtTime(0.08, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'levelup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.setValueAtTime(600, now + 0.1);
                osc.frequency.setValueAtTime(800, now + 0.2);
                gain.gain.setValueAtTime(0.08, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'crit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(1500, now + 0.05);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'explosion') {
                // –í–∑—Ä—ã–≤ - –Ω–∏–∑–∫–∏–π –≥—Ä–æ—Ö–æ—Ç —Å —à—É–º–æ–º
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(80, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.3);
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(120, now);
                osc2.frequency.exponentialRampToValueAtTime(30, now + 0.35);
                gain2.gain.setValueAtTime(0.12, now);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
                osc2.start(now + 0.05);
                osc2.stop(now + 0.4);
            } else if (type === 'error') {
                // –ó–≤—É–∫ –æ—à–∏–±–∫–∏
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.08, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        // ============================================
        // THREE.JS SETUP
        // ============================================
        
        let els = {};
        let scene, camera, renderer, breastGroup;
        let targetScale = 1;
        let currentScale = 1;
        let pulseEffect = 0;
        let autoclickInterval = null;
        let upgradeAutoInterval = null;

        function initThree() {
            const canvas = els.modelCanvas;
            const container = els.modelContainer;
            
            // Use a small delay to ensure container is rendered and has dimensions
            setTimeout(() => {
                const rect = container.getBoundingClientRect();
                const width = rect.width || 350;
                const height = rect.height || 380;

                scene = new THREE.Scene();
                
                camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
                camera.position.set(0, 0.3, 4.5);
                camera.lookAt(0, 0, 0);
                
                renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
                renderer.setSize(width, height);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.1;
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                const ambient = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambient);

                const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
                keyLight.position.set(3, 4, 5);
                keyLight.castShadow = true;
                keyLight.shadow.mapSize.width = 1024;
                keyLight.shadow.mapSize.height = 1024;
                scene.add(keyLight);

                const fillLight = new THREE.DirectionalLight(0xffb3d9, 0.4);
                fillLight.position.set(-4, 1, 3);
                scene.add(fillLight);

                const rimLight = new THREE.DirectionalLight(0xffd9e6, 0.3);
                rimLight.position.set(0, -3, -4);
                scene.add(rimLight);

                const topLight = new THREE.PointLight(0xffffff, 0.6, 10);
                topLight.position.set(0, 3, 2);
                scene.add(topLight);

                createBreasts();
                animate();
            }, 100);
        }

        function createBreasts() {
            breastGroup = new THREE.Group();

            const skinMat = new THREE.MeshStandardMaterial({
                color: 0xffdbd0,
                roughness: 0.4,
                metalness: 0.05,
            });

            // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –≥—Ä—É–¥–∏ —Å –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
            function createBreastGeometry() {
                const points = [];
                const segments = 32;
                
                for (let i = 0; i <= segments; i++) {
                    const t = i / segments; // 0 (–≤–µ—Ä—Ö/—Å–æ—Å–æ–∫) to 1 (–æ—Å–Ω–æ–≤–∞–Ω–∏–µ)
                    let r;
                    
                    if (t < 0.02) {
                        // –°–æ—Å–æ–∫ - –Ω–µ–±–æ–ª—å—à–∞—è –≤—ã–ø—É–∫–ª–æ—Å—Ç—å
                        r = 0.08 + t * 2;
                    } else if (t < 0.15) {
                        // –ê—Ä–µ–æ–ª–∞ - –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                        const areolaT = (t - 0.02) / 0.13;
                        r = 0.12 + Math.pow(areolaT, 0.6) * 0.35;
                    } else if (t < 0.45) {
                        // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å - –ø–ª–∞–≤–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
                        const upperT = (t - 0.15) / 0.3;
                        r = 0.47 + Math.sin(upperT * Math.PI * 0.5) * 0.35;
                    } else if (t < 0.75) {
                        // –°–∞–º–∞—è –ø–æ–ª–Ω–∞—è —á–∞—Å—Ç—å - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º
                        const midT = (t - 0.45) / 0.3;
                        r = 0.82 + Math.sin(midT * Math.PI) * 0.08;
                    } else {
                        // –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å - –ø–ª–∞–≤–Ω–æ–µ —Å—É–∂–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
                        const lowerT = (t - 0.75) / 0.25;
                        r = 0.82 * (1 - Math.pow(lowerT, 1.2) * 0.75);
                    }
                    
                    const y = t * 1.4;
                    points.push(new THREE.Vector2(r, y));
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —É –æ—Å–Ω–æ–≤–∞–Ω–∏—è
                points.push(new THREE.Vector2(0, 1.4));
                
                return new THREE.LatheGeometry(points, 64);
            }

            const breastGeo = createBreastGeometry();

            const breastL = new THREE.Mesh(breastGeo, skinMat);
            breastL.rotation.x = -Math.PI / 2;
            breastL.position.set(-0.65, 0, 0);
            breastL.castShadow = true;
            breastL.receiveShadow = true;
            breastGroup.add(breastL);

            const breastR = new THREE.Mesh(breastGeo, skinMat);
            breastR.rotation.x = -Math.PI / 2;
            breastR.position.set(0.65, 0, 0);
            breastR.castShadow = true;
            breastR.receiveShadow = true;
            breastGroup.add(breastR);

            // ========================================
            // –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ï –°–û–°–ö–ò
            // ========================================
            
            // 1. –ê—Ä–µ–æ–ª–∞ - —Å–ª–µ–≥–∫–∞ –≤—ã–ø—É–∫–ª—ã–π –¥–∏—Å–∫ —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
            const areolaMat = new THREE.MeshStandardMaterial({ 
                color: 0xd4787a,
                roughness: 0.65,
                metalness: 0.0,
            });
            
            // –ê—Ä–µ–æ–ª–∞ –∫–∞–∫ –ø—Ä–∏–ø–ª—é—Å–Ω—É—Ç–∞—è —Å—Ñ–µ—Ä–∞
            const areolaGeo = new THREE.SphereGeometry(0.24, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2.2);
            
            const areolaL = new THREE.Mesh(areolaGeo, areolaMat);
            areolaL.position.set(0, 0.015, 0);
            areolaL.scale.set(1, 0.18, 1);
            breastL.add(areolaL);

            const areolaR = new THREE.Mesh(areolaGeo, areolaMat);
            areolaR.position.set(0, 0.015, 0);
            areolaR.scale.set(1, 0.18, 1);
            breastR.add(areolaR);

            // 2. –°–æ—Å–æ–∫ - —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ñ–æ—Ä–º–∞ (—Ü–∏–ª–∏–Ω–¥—Ä + –ø–æ–ª—É—Å—Ñ–µ—Ä–∞)
            const nippleMat = new THREE.MeshStandardMaterial({ 
                color: 0xc96b6d,
                emissive: 0x2a0000,
                roughness: 0.3,
                metalness: 0.1,
            });
            
            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ —Å–æ—Å–∫–∞ (–∫–æ–Ω—É—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞)
            const nippleBaseGeo = new THREE.ConeGeometry(0.10, 0.15, 32);
            
            const nippleBaseL = new THREE.Mesh(nippleBaseGeo, nippleMat);
            nippleBaseL.position.set(0, 0.10, 0);
            breastL.add(nippleBaseL);
            
            const nippleBaseR = new THREE.Mesh(nippleBaseGeo, nippleMat);
            nippleBaseR.position.set(0, 0.10, 0);
            breastR.add(nippleBaseR);
            
            // –°—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å —Å–æ—Å–∫–∞ (—Ü–∏–ª–∏–Ω–¥—Ä)
            const nippleMidGeo = new THREE.CylinderGeometry(0.09, 0.10, 0.12, 32);
            
            const nippleMidL = new THREE.Mesh(nippleMidGeo, nippleMat);
            nippleMidL.position.set(0, 0.19, 0);
            breastL.add(nippleMidL);
            
            const nippleMidR = new THREE.Mesh(nippleMidGeo, nippleMat);
            nippleMidR.position.set(0, 0.19, 0);
            breastR.add(nippleMidR);
            
            // –í–µ—Ä—Ö—É—à–∫–∞ —Å–æ—Å–∫–∞ (–ø–æ–ª—É—Å—Ñ–µ—Ä–∞ - –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—á–∏–∫)
            const nippleTipGeo = new THREE.SphereGeometry(0.09, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            
            const nippleTipL = new THREE.Mesh(nippleTipGeo, nippleMat);
            nippleTipL.position.set(0, 0.25, 0);
            breastL.add(nippleTipL);
            
            const nippleTipR = new THREE.Mesh(nippleTipGeo, nippleMat);
            nippleTipR.position.set(0, 0.25, 0);
            breastR.add(nippleTipR);

            scene.add(breastGroup);
            updateTargetScale();
        }

        function updateTargetScale() {
            const base = 0.8;
            const growth = Math.sqrt(state.size) * 0.1;
            targetScale = Math.min(base + growth, 2.5); 
        }

        function animate() {
            requestAnimationFrame(animate);

            const t = Date.now() * 0.001;

            currentScale += (targetScale - currentScale) * 0.1;
            
            const finalScale = currentScale * (1 + pulseEffect);
            pulseEffect *= 0.85; 

            const breath = Math.sin(t * 2) * 0.008;

            if (breastGroup) {
                breastGroup.children.forEach((breast, i) => {
                    const scale = finalScale * (1 + breath);
                    breast.scale.setScalar(scale);
                    
                    const separation = 0.6 + (scale - 0.8) * 0.1;
                    breast.position.x = i === 0 ? -separation : separation;
                });

                breastGroup.rotation.y = Math.sin(t * 0.5) * 0.05;
            }

            renderer.render(scene, camera);
        }

        // ============================================
        // LOGIC
        // ============================================

        function saveState() {
            localStorage.setItem('bustClickerV4', JSON.stringify(state));
            if (!localStorage.getItem('shopLastUpdate')) {
                localStorage.setItem('shopLastUpdate', Date.now().toString());
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            syncPlayerData();
        }

        function loadState() {
            const saved = localStorage.getItem('bustClickerV4');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                if (!state.upgrades) state.upgrades = {};
                state.activeEffects = state.activeEffects.filter(e => !e.endTime || e.endTime > Date.now());
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω–∞
            if (!localStorage.getItem('shopLastUpdate')) {
                localStorage.setItem('shopLastUpdate', Date.now().toString());
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä–∞–¥—ã
            if (!state.dailyRewardLastClaim) state.dailyRewardLastClaim = 0;
            if (!state.dailyRewardStreak) state.dailyRewardStreak = 0;
        }

        function showToast(msg, type = 'success') {
            els.toast.textContent = msg;
            els.toast.className = 'toast ' + type + ' show';
            setTimeout(() => els.toast.classList.remove('show'), 2500);
        }

        function formatTime(ms) {
            if (ms <= 0) return '0—Å';
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            if (h > 0) return `${h}—á ${m}–º`;
            if (m > 0) return `${m}–º ${s}—Å`;
            return `${s}—Å`;
        }
        
        function formatTimeShort(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function weightedRandom(items) {
            const total = items.reduce((s, i) => s + i.weight, 0);
            let r = Math.random() * total;
            for (const item of items) {
                r -= item.weight;
                if (r <= 0) return item;
            }
            return items[0];
        }

        function getLevel() {
            const effects = getAllUpgradeEffects();
            const reduction = effects.levelReduction || 0;
            const sizePerLvl = Math.max(10, SIZE_PER_LEVEL - reduction);
            return Math.floor(state.size / sizePerLvl);
        }

        function getLevelProgress() {
            const effects = getAllUpgradeEffects();
            const reduction = effects.levelReduction || 0;
            const sizePerLvl = Math.max(10, SIZE_PER_LEVEL - reduction);
            const currentLevelSize = getLevel() * sizePerLvl;
            const progress = state.size - currentLevelSize;
            return (progress / sizePerLvl) * 100;
        }

        function getLevelBonus() {
            const level = getLevel();
            const effects = getAllUpgradeEffects();
            const basePct = 0.01 + (effects.levelBonusMod || 0) / 100;
            return level * basePct;
        }

        function calcPerClick() {
            const effects = getAllUpgradeEffects();
            const now = Date.now();
            
            // –ë–∞–∑–∞: 1 + –±–æ–Ω—É—Å –æ—Ç –∞–ø–≥—Ä–µ–π–¥–∞ "–°–∏–ª–∞ –∫–ª–∏–∫–∞"
            let base = 1 + (effects.clickBonus || 0);
            
            // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –∞–ø–≥—Ä–µ–π–¥–∞ "–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä"
            base *= (effects.clickMulti || 1);
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –∞–ø–≥—Ä–µ–π–¥–∞ "–ê–ª–º–∞–∑–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ"
            base *= (effects.globalMulti || 1);
            
            // –ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞/–∫–µ–π—Å–æ–≤ (x2, x5, x10, x20)
            state.activeEffects.forEach(e => {
                if (e.endTime > now && e.effect.type === 'multiply') {
                    base *= e.effect.value;
                }
            });

            // –ë–û–ù–£–° –û–¢ –£–†–û–í–ù–Ø - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —É—Ä–æ–Ω
            // –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–∞—ë—Ç +1% (–∏–ª–∏ –±–æ–ª—å—à–µ —Å –∞–ø–≥—Ä–µ–π–¥–æ–º "–ü—Ä–µ—Å—Ç–∏–∂–Ω–∞—è –º–æ—â—å")
            // –ù–∞–ø—Ä–∏–º–µ—Ä: —É—Ä–æ–≤–µ–Ω—å 10 = x1.10, —É—Ä–æ–≤–µ–Ω—å 50 = x1.50
            const levelBonus = 1 + getLevelBonus();
            base *= levelBonus;
            
            return Math.max(1, Math.floor(base));
        }

        function isFrozen() {
            return state.activeEffects.some(e => e.effect.type === 'freeze' && e.endTime > Date.now());
        }

        function handleClick(e) {
            // Check if blocked by anti-cheat
            if (antiCheat && antiCheat.isBlocked) {
                showToast('üö´ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...', 'error');
                return;
            }
            
            if (isFrozen()) {
                showToast('–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ! ‚ùÑÔ∏è', 'error');
                return;
            }
            
            const effects = getAllUpgradeEffects();
            let amount = calcPerClick();
            let isCrit = false;
            let isLucky = false;
            
            // Critical hit check
            if (Math.random() < (effects.critChance || 0)) {
                amount *= 5;
                isCrit = true;
            }
            
            // Lucky star check
            if (!isCrit && Math.random() < (effects.luckyChance || 0)) {
                amount *= 10;
                isLucky = true;
            }
            
            const oldLevel = getLevel();
            
            state.size += amount;
            state.totalClicks++;
            
            // Coin magnet check
            if (Math.random() < (effects.coinChance || 0)) {
                const coinGain = effects.coinAmount || 1;
                state.coins += coinGain;
            }

            const newLevel = getLevel();
            if (newLevel > oldLevel) {
                showToast(`‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å ${newLevel}! –ë–æ–Ω—É—Å +${(getLevelBonus() * 100).toFixed(1)}%`, 'success');
                playSound('levelup');
            } else if (isCrit) {
                playSound('crit');
            } else if (isLucky) {
                playSound('crit');
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–≤—É–∫ —Å–∂–∞—Ç–∏—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
                playSound('squish');
            }

            pulseEffect = isCrit || isLucky ? 0.4 : 0.2; 
            updateTargetScale(); 
            
            checkAchievements();
            updateUI();
            saveState();
            
            createFloatingNum(amount, e, isCrit, isLucky);
            createParticles(e);
            if (isCrit || isLucky) {
                createParticles(e);
                createParticles(e);
            }
            createHeart(e);
        }

        function createFloatingNum(amount, e, isCrit = false, isLucky = false) {
            const num = document.createElement('div');
            num.className = 'float-num';
            let prefix = '+';
            if (isCrit) prefix = '–ö–†–ò–¢! +';
            if (isLucky) prefix = '‚≠ê –£–î–ê–ß–ê! +';
            num.textContent = prefix + amount;
            
            if (isCrit) {
                num.style.color = '#fbbf24';
                num.style.textShadow = '0 0 15px rgba(251, 191, 36, 0.8)';
            }
            if (isLucky) {
                num.style.color = '#00ffff';
                num.style.textShadow = '0 0 15px rgba(0, 255, 255, 0.8)';
            }
            
            const rect = els.modelContainer.getBoundingClientRect();
            // Use click coordinates if available, otherwise center
            const x = e && e.clientX ? e.clientX : rect.left + rect.width / 2;
            const y = e && e.clientY ? e.clientY : rect.top + rect.height * 0.3;
            
            num.style.left = x + (Math.random() - 0.5) * 60 - 20 + 'px';
            num.style.top = y - 40 + 'px';
            
            document.body.appendChild(num);
            setTimeout(() => num.remove(), 800);
        }

        function createParticles(e) {
            const rect = els.modelContainer.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            const colors = ['#ff4d8d', '#b366ff', '#fbbf24', '#4ade80'];
            
            for (let i = 0; i < 8; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.setProperty('--tx', (Math.random() - 0.5) * 120 + 'px');
                p.style.setProperty('--ty', (Math.random() - 0.5) * 120 + 'px');
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        }

        function createHeart(e) {
            const rect = els.modelContainer.getBoundingClientRect();
            const h = document.createElement('div');
            h.className = 'heart-particle';
            h.innerHTML = '‚ù§';
            h.style.left = rect.left + rect.width / 2 + (Math.random() - 0.5) * 60 + 'px';
            h.style.top = rect.top + rect.height * 0.4 + 'px';
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 1000);
        }

        function exchangeSize() {
            const amount = parseInt(els.exchangeAmount.value) || 0;
            if (amount <= 0) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error');
            if (amount > state.size) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–º–µ—Ä–∞', 'error');
            
            state.size -= amount;
            
            const effects = getAllUpgradeEffects();
            const hasGoldenTouch = state.inventory.some(i => i.id === 'golden_touch');
            let rate = EXCHANGE_RATE + (effects.exchangeBonus || 0);
            if (hasGoldenTouch) rate *= 3;
            
            state.coins += Math.floor(amount * rate);
            state.statsExchanges += amount;
            
            updateTargetScale();
            updateUI();
            checkAchievements();
            saveState();
            showToast(`+${Math.floor(amount * rate).toLocaleString()} –º–æ–Ω–µ—Ç!`, 'success');
        }

        // ============================================
        // UI & RENDERING
        // ============================================

        function updateUI() {
            els.coinCount.textContent = state.coins.toLocaleString();
            els.sizeCount.textContent = state.size.toLocaleString();
            els.modelSize.textContent = state.size.toLocaleString();
            els.perClickVal.textContent = '+' + calcPerClick();

            const effects = getAllUpgradeEffects();
            const rate = EXCHANGE_RATE + (effects.exchangeBonus || 0);
            els.exchangeRate.textContent = `–ö—É—Ä—Å: 1 –µ–¥. —Ä–∞–∑–º–µ—Ä–∞ = ${rate} –º–æ–Ω–µ—Ç`;

            const level = getLevel();
            const progress = getLevelProgress();
            const tier = getProgressTier();
            const priceMulti = getPriceMultiplier();
            
            els.currentLevel.textContent = `–£—Ä–æ–≤–µ–Ω—å ${level}`;
            els.nextLevelBonus.textContent = `–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x${(1 + getLevelBonus()).toFixed(2)}`;
            els.levelProgress.style.width = Math.min(progress, 100) + '%';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ü–µ–Ω –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ 1
            if (priceMulti > 1) {
                els.userRank.textContent = `–†–∞–Ω–≥: Tier ${tier} (x${priceMulti.toFixed(1)} —Ü–µ–Ω—ã)`;
            } else {
                const allPlayers = [...LEADERBOARD_DATA];
                allPlayers.push({
                    name: state.userName,
                    size: state.size,
                    coins: state.coins,
                    time: state.totalPlayTime,
                    achievements: state.unlockedAchievements,
                    isCurrentUser: true
                });
                allPlayers.sort((a, b) => b[els.currentLbType] - a[els.currentLbType]);
                const userRank = allPlayers.findIndex(p => p.isCurrentUser) + 1;
                els.userRank.textContent = `–†–∞–Ω–≥: #${userRank}`;
            }

            renderInventory();
            renderActiveEffectsBar();
        }

        function checkAchievements() {
            ACHIEVEMENTS.forEach(ach => {
                if (!state.unlockedAchievements.includes(ach.id) && ach.condition(state)) {
                    state.unlockedAchievements.push(ach.id);
                    showToast(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${ach.name}!`, 'success');
                }
            });
            updateAchievementsUI();
        }

        function updateAchievementsUI() {
            els.achGrid.innerHTML = '';
            els.achProgress.textContent = `${state.unlockedAchievements.length}/${ACHIEVEMENTS.length}`;
            
            ACHIEVEMENTS.forEach(ach => {
                const unlocked = state.unlockedAchievements.includes(ach.id);
                const div = document.createElement('div');
                div.className = `ach-item ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<div class="ach-icon">${ach.icon}</div><div class="ach-name">${ach.name}</div>`;
                div.onclick = () => showAchievementInfo(ach, div);
                els.achGrid.appendChild(div);
            });
        }

        function showAchievementInfo(ach, element) {
            document.querySelectorAll('.ach-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            const box = els.achInfoBox;
            box.classList.remove('empty');
            
            const unlocked = state.unlockedAchievements.includes(ach.id);
            
            box.innerHTML = `
                <div class="ach-info-title" style="color: ${unlocked ? 'var(--warning)' : 'var(--text-primary)'}">
                    ${unlocked ? '‚úÖ ' + ach.name + ' (–ü–æ–ª—É—á–µ–Ω–æ)' : 'üîí ' + ach.name}
                </div>
                <div class="ach-info-desc">${ach.desc}</div>
            `;
        }

        function renderShop() {
            els.shopGrid.innerHTML = '';
            SHOP_DB.forEach(item => {
                const scaledPrice = getScaledPrice(item.price);
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-item-icon" style="background: ${item.color}; color: #0d0d12;">${item.icon}</div>
                    <div class="shop-item-info">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-desc">${item.desc}</div>
                    </div>
                    <div class="shop-item-price">$ ${scaledPrice.toLocaleString()}</div>
                `;
                div.addEventListener('click', () => buyItem(item, scaledPrice));
                els.shopGrid.appendChild(div);
            });
        }

        function buyItem(item, price) {
            if (state.coins < price) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
            
            state.coins -= price;
            playSound('buy');

            if (item.type === 'instant') {
                if (item.effect.type === 'instantSize') {
                    state.size += item.effect.value;
                    updateTargetScale();
                    showToast(`+${item.effect.value} –∫ —Ä–∞–∑–º–µ—Ä—É!`, 'success');
                } else if (item.effect.type === 'instantTime') {
                    state.totalPlayTime += item.effect.value;
                    showToast(`+${formatTime(item.effect.value)}!`, 'success');
                }
            } else if (item.type === 'passive') {
                state.inventory.push({ ...item, obtainedAt: Date.now() });
                showToast(`${item.name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!`, 'success');
            } else {
                state.inventory.push({ ...item, obtainedAt: Date.now() });
                showToast(`${item.name} –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!`, 'success');
            }
            updateUI();
            saveState();
        }

        function renderCases() {
            els.casesGrid.innerHTML = '';
            CASES.forEach(c => {
                const scaledPrice = getScaledPrice(c.price);
                const div = document.createElement('div');
                div.className = `case-card ${c.rarity}`;
                div.innerHTML = `
                    <div class="case-icon ${RARITY[c.rarity].cls}">${c.icon}</div>
                    <div class="case-name">${c.name}</div>
                    <div class="case-desc">${c.desc}</div>
                    <div class="case-price">$ ${scaledPrice.toLocaleString()}</div>
                `;
                div.addEventListener('click', () => openCase(c, scaledPrice));
                els.casesGrid.appendChild(div);
            });
        }

        function openCase(c, price) {
            if (state.coins < price) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
            state.coins -= price;
            state.statsCases++;
            playSound('buy');
            
            const reward = weightedRandom(CASE_REWARDS);
            showRewardModal(reward);
        }

        function showRewardModal(reward) {
            els.modalIcon.style.display = 'flex';
            els.modalIcon.className = 'modal-icon';
            els.modalIcon.classList.add(RARITY[reward.rarity].cls);
            els.modalIcon.textContent = reward.icon;
            
            els.modalTitle.textContent = reward.name;
            els.modalTitle.style.color = RARITY[reward.rarity].border;
            
            const rarityNames = { common: '–û–±—ã—á–Ω—ã–π', rare: '–†–µ–¥–∫–∏–π', epic: '–≠–ø–∏—á–µ—Å–∫–∏–π', legendary: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' };
            els.modalDesc.textContent = rarityNames[reward.rarity] + (reward.type === 'debuff' ? ' (–î–µ–±–∞—Ñ—Ñ!)' : '');
            els.modalDesc.style.color = reward.type === 'debuff' ? '#f87171' : 'var(--text-secondary)';
            
            els.modalProfileStats.innerHTML = '';
            els.modalAchGrid.innerHTML = '';
            els.achInfoDisplay.style.display = 'none';
            
            els.modalBtn.textContent = '–ó–∞–±—Ä–∞—Ç—å';
            els.modalBtn.onclick = () => claimReward(reward);
            
            els.modalOverlay.classList.add('active');
        }

        function claimReward(reward) {
            closeModal();
            if (reward.type === 'debuff') {
                const shieldIdx = state.inventory.findIndex(i => i.effect.type === 'shield');
                if (shieldIdx !== -1) {
                    state.inventory.splice(shieldIdx, 1);
                    showToast('üõ°Ô∏è –©–∏—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–µ–±–∞—Ñ—Ñ!', 'success');
                    updateUI(); saveState();
                    return;
                }
            }
            
            if (reward.type === 'instant') {
                if (reward.effect.type === 'instantSize') {
                    state.size += reward.effect.value;
                    updateTargetScale();
                } else if (reward.effect.type === 'instantCoins') {
                    state.coins += reward.effect.value;
                }
            } else if (reward.type === 'debuff') {
                if (reward.effect.type === 'percentLoss') {
                    const loss = Math.floor(state.size * reward.effect.value);
                    state.size = Math.max(0, state.size - loss);
                    updateTargetScale();
                    showToast(`üíÄ –ü–æ—Ç–µ—Ä—è–Ω–æ ${loss} —Ä–∞–∑–º–µ—Ä–∞!`, 'error');
                } else if (reward.duration) {
                    state.activeEffects.push({ ...reward, endTime: Date.now() + reward.duration });
                }
            } else {
                state.inventory.push({ ...reward, obtainedAt: Date.now() });
            }
            
            updateUI();
            checkAchievements();
            saveState();
        }

        async function renderLeaderboard() {
            console.log('üîÑ –†–µ–Ω–¥–µ—Ä —Ç–æ–ø–∞ –∏–≥—Ä–æ–∫–æ–≤...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            els.leaderboardList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞ –∏–≥—Ä–æ–∫–æ–≤...</div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ Firebase
            const otherPlayers = await fetchLeaderboard();
            
            // –î–ï–ë–ê–ì: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            const debugInfo = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firebase: ${otherPlayers.length} –∏–≥—Ä–æ–∫–æ–≤`;
            console.log(`üìä ${debugInfo}`);
            
            // –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            const allPlayers = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ Firebase
            otherPlayers.forEach(player => {
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫ - –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ state
                if (player.userId === state.userId) {
                    allPlayers.push({
                        userId: state.userId,
                        name: state.userName,
                        size: state.size,
                        coins: state.coins,
                        time: state.totalPlayTime,
                        achievements: state.unlockedAchievements,
                        photoUrl: player.photoUrl || null, // –ë–µ—Ä—ë–º —Ñ–æ—Ç–æ –∏–∑ Firebase
                        isCurrentUser: true
                    });
                } else {
                    allPlayers.push({
                        ...player,
                        isCurrentUser: false
                    });
                }
            });
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ - –¥–æ–±–∞–≤–ª—è–µ–º
            if (!allPlayers.some(p => p.userId === state.userId)) {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –∏–∑ Telegram
                const tg = window.Telegram?.WebApp;
                let photoUrl = null;
                if (tg && tg.initDataUnsafe?.user?.photo_url) {
                    photoUrl = tg.initDataUnsafe.user.photo_url;
                }
                
                allPlayers.push({
                    userId: state.userId,
                    name: state.userName,
                    size: state.size,
                    coins: state.coins,
                    time: state.totalPlayTime,
                    achievements: state.unlockedAchievements,
                    photoUrl: photoUrl,
                    isCurrentUser: true
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä—É
            allPlayers.sort((a, b) => b.size - a.size);
            
            console.log(`‚úÖ –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–æ–ø–µ: ${allPlayers.length}`);
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            const userRank = allPlayers.findIndex(p => p.isCurrentUser) + 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥ –≤ —Ö–µ–¥–µ—Ä–µ
            const tier = getProgressTier();
            const priceMulti = getPriceMultiplier();
            if (priceMulti > 1) {
                els.userRank.textContent = `–†–∞–Ω–≥: #${userRank} | Tier ${tier} (x${priceMulti.toFixed(1)})`;
            } else {
                els.userRank.textContent = `–†–∞–Ω–≥: #${userRank}`;
            }
            
            els.leaderboardList.innerHTML = '';
            
            // –î–ï–ë–ê–ì: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∑–∫–µ
            if (otherPlayers.length === 0) {
                const debugDiv = document.createElement('div');
                debugDiv.style.cssText = 'background: #ff4d4d; color: white; padding: 10px; margin: 10px; border-radius: 8px; font-size: 11px;';
                debugDiv.innerHTML = `
                    <strong>‚ö†Ô∏è –î–ï–ë–ê–ì:</strong><br>
                    Firebase –≤–µ—Ä–Ω—É–ª 0 –∏–≥—Ä–æ–∫–æ–≤!<br>
                    –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firebase:<br>
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">
                    {<br>
                    &nbsp;&nbsp;"rules": {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;"players": {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"$userId": {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".read": true,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".write": true<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;}<br>
                    }
                    </code>
                `;
                els.leaderboardList.appendChild(debugDiv);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-100
            const topPlayers = allPlayers.slice(0, 100);
            
            topPlayers.forEach((player, idx) => {
                const div = document.createElement('div');
                div.className = `leaderboard-item ${player.isCurrentUser ? 'current-user' : ''}`;
                
                let rankClass = '';
                if (idx === 0) rankClass = 'gold';
                else if (idx === 1) rankClass = 'silver';
                else if (idx === 2) rankClass = 'bronze';
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∏–Ω–∞—á–µ –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏
                const avatarContent = player.photoUrl 
                    ? `<img src="${player.photoUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${player.name.charAt(0)}'">` 
                    : player.name.charAt(0);
                
                div.innerHTML = `
                    <div class="lb-rank ${rankClass}">${idx + 1}</div>
                    <div class="lb-avatar">${avatarContent}</div>
                    <div class="lb-info">
                        <div class="lb-name ${player.isCurrentUser ? 'you' : ''}">${player.name}${player.isCurrentUser ? ' (–¢—ã)' : ''}</div>
                    </div>
                    <div class="lb-value">${player.size.toLocaleString()}<span>${(player.achievements || []).length} –∞—á–∏–≤–æ–∫</span></div>
                `;
                
                div.addEventListener('click', () => {
                    window.haptic('light');
                    showProfile(player);
                });
                els.leaderboardList.appendChild(div);
            });
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ—Ç (—Ç–æ–ª—å–∫–æ —Ç—ã), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            if (allPlayers.length === 1) {
                const hint = document.createElement('div');
                hint.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;';
                hint.innerHTML = `üë• –ü–æ–∫–∞ —Ç—ã –æ–¥–∏–Ω –≤ —Ç–æ–ø–µ!<br>–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏.<br><br><small style="color: var(--text-muted);">(Firebase: ${otherPlayers.length} –∏–≥—Ä–æ–∫–æ–≤)</small>`;
                els.leaderboardList.appendChild(hint);
            }
        }
        
        function showProfile(player) {
            els.modalIcon.style.display = 'none';
            els.modalTitle.textContent = player.name;
            els.modalDesc.textContent = player.isCurrentUser ? '–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å' : '–ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞';
            
            els.modalProfileStats.innerHTML = `
                <div class="profile-stats">
                    <div class="profile-stat"><div class="profile-stat-val">${player.size.toLocaleString()}</div><div class="profile-stat-label">–†–∞–∑–º–µ—Ä</div></div>
                    <div class="profile-stat"><div class="profile-stat-val">${player.coins.toLocaleString()}</div><div class="profile-stat-label">–ú–æ–Ω–µ—Ç—ã</div></div>
                    <div class="profile-stat"><div class="profile-stat-val">${formatTime(player.time)}</div><div class="profile-stat-label">–í—Ä–µ–º—è</div></div>
                </div>
            `;
            
            els.achInfoDisplay.style.display = 'none';
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
            grid.style.gap = '6px';
            
            ACHIEVEMENTS.forEach(ach => {
                const unlocked = player.achievements.includes(ach.id);
                const div = document.createElement('div');
                div.className = `ach-item ${unlocked ? 'unlocked' : ''}`;
                div.style.padding = '6px';
                div.style.borderRadius = '8px';
                div.style.cursor = 'pointer';
                div.innerHTML = `<div class="ach-icon" style="width:24px; height:24px; font-size:12px; margin:0 auto;">${ach.icon}</div>`;
                
                div.onclick = () => {
                    els.achInfoDisplay.style.display = 'block';
                    els.achInfoTitle.textContent = ach.name;
                    els.achInfoDesc.textContent = ach.desc;
                    els.achInfoTitle.style.color = unlocked ? 'var(--warning)' : 'var(--text-secondary)';
                };
                
                grid.appendChild(div);
            });
            
            els.modalAchGrid.innerHTML = '';
            els.modalAchGrid.appendChild(grid);
            
            els.modalBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
            els.modalBtn.onclick = closeModal;
            
            els.modalOverlay.classList.add('active');
        }

        function renderInventory() {
            const now = Date.now();
            const active = state.activeEffects.filter(e => e.endTime > now);
            
            els.activeItems.innerHTML = '';
            els.noActive.style.display = active.length ? 'none' : 'block';
            active.forEach(eff => {
                const left = Math.max(0, eff.endTime - now);
                const div = document.createElement('div');
                div.className = `inventory-item active ${eff.type === 'debuff' ? 'debuff' : ''}`;
                div.innerHTML = `<div class="inv-icon">${eff.icon}</div><div class="inv-name">${eff.name}</div><div class="inv-timer active">${formatTime(left)}</div>`;
                els.activeItems.appendChild(div);
            });
            
            const usable = state.inventory.filter(i => i.type !== 'instant');
            els.inventoryGrid.innerHTML = '';
            els.noInventory.style.display = usable.length ? 'none' : 'block';
            usable.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.innerHTML = `<div class="inv-icon">${item.icon}</div><div class="inv-name">${item.name}</div><button class="use-btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>`;
                div.querySelector('.use-btn').onclick = () => useItem(item);
                els.inventoryGrid.appendChild(div);
            });
        }

        function useItem(item) {
            if (item.type === 'shield' || item.type === 'passive') return;
            state.activeEffects.push({ ...item, endTime: Date.now() + item.duration });
            state.inventory = state.inventory.filter(i => i !== item);
            state.statsBuffsUsed++;
            showToast(`${item.name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`, 'success');
            processEffects();
            checkAchievements();
            saveState();
            updateUI();
        }

        function processEffects() {
            const now = Date.now();
            state.activeEffects = state.activeEffects.filter(e => !e.endTime || e.endTime > now);
            
            const hasAuto = state.activeEffects.some(e => e.effect.type === 'autoclick' && e.endTime > now);
            
            if (hasAuto && !autoclickInterval) {
                let clickPower = 1;
                state.activeEffects.forEach(e => {
                    if (e.endTime > Date.now() && e.effect.type === 'autoclick') {
                        clickPower = Math.max(clickPower, e.effect.value);
                    }
                });

                autoclickInterval = setInterval(() => {
                    if (!isFrozen()) {
                        state.size += calcPerClick() * clickPower;
                        state.totalClicks += clickPower;
                        pulseEffect = 0.03;
                        updateTargetScale();
                        updateUI();
                        saveState();
                    }
                }, 1000);
            } else if (!hasAuto && autoclickInterval) {
                clearInterval(autoclickInterval);
                autoclickInterval = null;
            }
        }

        // Upgrade-based auto clicker
        function processUpgradeAuto() {
            const effects = getAllUpgradeEffects();
            const autoPerSec = effects.autoPerSec || 0;
            
            if (autoPerSec > 0 && !isFrozen()) {
                state.size += autoPerSec;
                updateTargetScale();
                updateUI();
                saveState();
            }
        }

        function renderActiveEffectsBar() {
            const now = Date.now();
            const effects = getAllUpgradeEffects();
            els.activeEffectsBar.innerHTML = '';
            
            // Show upgrade auto-click if active
            if (effects.autoPerSec > 0) {
                const pill = document.createElement('div');
                pill.className = 'effect-pill buff';
                pill.textContent = `ü§ñ +${effects.autoPerSec}/—Å`;
                els.activeEffectsBar.appendChild(pill);
            }
            
            state.activeEffects.filter(e => e.endTime > now).forEach(eff => {
                const pill = document.createElement('div');
                pill.className = `effect-pill ${eff.type === 'debuff' ? 'debuff' : 'buff'}`;
                pill.textContent = `${eff.icon} ${formatTime(Math.max(0, eff.endTime - now))}`;
                els.activeEffectsBar.appendChild(pill);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
            if (antiCheat && antiCheat.suspicionScore > 0) {
                const suspPill = document.createElement('div');
                suspPill.className = 'effect-pill debuff';
                const score = Math.round(antiCheat.suspicionScore);
                suspPill.textContent = `‚ö†Ô∏è ${score}%`;
                suspPill.style.opacity = '0.6';
                suspPill.title = '–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏';
                els.activeEffectsBar.appendChild(suspPill);
            }
        }

        function closeModal() {
            els.modalOverlay.classList.remove('active');
        }

        // ============================================
        // DAILY REWARD GAME
        // ============================================

        let dailyGameState = {
            grid: [],
            keysFound: 0,
            gameOver: false,
            reward: null,
            attempts: 3,
            maxAttempts: 3
        };

        function createExplosion(x, y) {
            // –û—Å–Ω–æ–≤–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç –≤–∑—Ä—ã–≤–∞
            const explosion = document.createElement('div');
            explosion.className = 'explosion-effect';
            explosion.innerHTML = 'üí•';
            explosion.style.fontSize = '80px';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';
            explosion.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(explosion);
            
            setTimeout(() => explosion.remove(), 600);
            
            // –ß–∞—Å—Ç–∏—Ü—ã –≤–∑—Ä—ã–≤–∞
            const colors = ['#ff4d4d', '#ff8800', '#ffaa00', '#ff6b6b', '#ff0000'];
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'explosion-particle';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                
                const angle = (Math.PI * 2 * i) / 20;
                const distance = 80 + Math.random() * 40;
                const ex = Math.cos(angle) * distance;
                const ey = Math.sin(angle) * distance;
                
                particle.style.setProperty('--ex', ex + 'px');
                particle.style.setProperty('--ey', ey + 'px');
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 800);
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–∫—Ä—ã
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const spark = document.createElement('div');
                    spark.className = 'explosion-particle';
                    spark.style.background = '#ffff00';
                    spark.style.width = '4px';
                    spark.style.height = '4px';
                    spark.style.left = x + 'px';
                    spark.style.top = y + 'px';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 60 + Math.random() * 60;
                    const ex = Math.cos(angle) * distance;
                    const ey = Math.sin(angle) * distance;
                    
                    spark.style.setProperty('--ex', ex + 'px');
                    spark.style.setProperty('--ey', ey + 'px');
                    
                    document.body.appendChild(spark);
                    setTimeout(() => spark.remove(), 600);
                }, i * 30);
            }
        }

        function shakeScreen() {
            document.body.classList.add('screen-shake');
            setTimeout(() => {
                document.body.classList.remove('screen-shake');
            }, 500);
        }

        function canClaimDaily() {
            const now = Date.now();
            return (now - state.dailyRewardLastClaim) >= DAILY_REWARD_COOLDOWN;
        }

        function getTimeUntilNextDaily() {
            const now = Date.now();
            const nextClaim = state.dailyRewardLastClaim + DAILY_REWARD_COOLDOWN;
            return Math.max(0, nextClaim - now);
        }

        function initDailyGame() {
            // –°–æ–∑–¥–∞—ë–º —Å–µ—Ç–∫—É 3x3 (9 —è—á–µ–µ–∫)
            // 1 –∫–ª—é—á, 8 –º–∏–Ω
            const cells = ['key', 'bomb', 'bomb', 'bomb', 'bomb', 'bomb', 'bomb', 'bomb', 'bomb'];
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            for (let i = cells.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cells[i], cells[j]] = [cells[j], cells[i]];
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É —Å —É—á—ë—Ç–æ–º –≤–µ—Å–æ–≤ (—Ä–µ–¥–∫–æ—Å—Ç–∏)
            dailyGameState = {
                grid: cells.map(type => ({ type, revealed: false })),
                keysFound: 0,
                gameOver: false,
                reward: weightedRandom(DAILY_REWARDS),
                attempts: 3,
                maxAttempts: 3
            };
        }

        function revealCell(index) {
            if (dailyGameState.gameOver) return;
            if (dailyGameState.grid[index].revealed) return;
            
            window.haptic('medium');
            dailyGameState.grid[index].revealed = true;
            
            const cell = dailyGameState.grid[index];
            
            if (cell.type === 'bomb') {
                // –ü–æ–ø–∞–ª–∏ –Ω–∞ –º–∏–Ω—É - –º–∏–Ω—É—Å –ø–æ–ø—ã—Ç–∫–∞!
                dailyGameState.attempts--;
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –¥–ª—è –≤–∑—Ä—ã–≤–∞
                const cellElements = document.querySelectorAll('.daily-cell');
                const cellElement = cellElements[index];
                const rect = cellElement.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω—É
                renderDailyReward();
                
                // –ß–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–¥–µ—Ä–∂–∫—É - –≤–∑—Ä—ã–≤!
                setTimeout(() => {
                    playSound('explosion');
                    window.haptic('heavy');
                    createExplosion(x, y);
                    shakeScreen();
                    
                    if (dailyGameState.attempts <= 0) {
                        // –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å - –ø—Ä–æ–∏–≥—Ä—ã—à
                        dailyGameState.gameOver = true;
                        setTimeout(() => {
                            dailyGameState.grid.forEach(c => c.revealed = true);
                            renderDailyReward();
                            showToast('üí£ –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å! –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≤—Ç—Ä–∞!', 'error');
                        }, 400);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏
                        state.dailyRewardLastClaim = Date.now();
                        state.dailyRewardStreak = 0;
                        saveState();
                    } else {
                        // –ï—â—ë –µ—Å—Ç—å –ø–æ–ø—ã—Ç–∫–∏
                        setTimeout(() => {
                            renderDailyReward();
                            showToast(`üí• –ú–∏–Ω–∞! –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${dailyGameState.attempts}`, 'error');
                        }, 400);
                    }
                }, 200);
            } else if (cell.type === 'key') {
                // –ü–û–ë–ï–î–ê! –ù–∞—à—ë–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª—é—á!
                dailyGameState.keysFound = 1;
                dailyGameState.gameOver = true;
                dailyGameState.grid.forEach(c => c.revealed = true);
                playSound('levelup');
                window.haptic('success');
                
                // –í—ã–¥–∞—ë–º –Ω–∞–≥—Ä–∞–¥—É
                const reward = dailyGameState.reward;
                
                if (reward.effect.type === 'instantSizePercent') {
                    const bonus = Math.floor(state.size * reward.effect.value);
                    state.size += bonus;
                    updateTargetScale();
                    showToast(`üéâ ${reward.name}: +${bonus.toLocaleString()} —Ä–∞–∑–º–µ—Ä–∞!`, 'success');
                } else if (reward.effect.type === 'instantCoinsPercent') {
                    const bonus = Math.floor(state.coins * reward.effect.value);
                    state.coins += bonus;
                    showToast(`üéâ ${reward.name}: +${bonus.toLocaleString()} –º–æ–Ω–µ—Ç!`, 'success');
                } else if (reward.effect.type === 'jackpot') {
                    const sizeBonus = Math.floor(state.size * reward.effect.value);
                    const coinBonus = Math.floor(state.coins * reward.effect.value);
                    state.size += sizeBonus;
                    state.coins += coinBonus;
                    updateTargetScale();
                    showToast(`üëë –î–ñ–ï–ö–ü–û–¢! +${sizeBonus.toLocaleString()} —Ä–∞–∑–º–µ—Ä–∞, +${coinBonus.toLocaleString()} –º–æ–Ω–µ—Ç!`, 'success');
                } else if (reward.duration > 0) {
                    state.activeEffects.push({ ...reward, endTime: Date.now() + reward.duration });
                    processEffects();
                    showToast(`üéâ ${reward.name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`, 'success');
                }
                
                state.dailyRewardLastClaim = Date.now();
                state.dailyRewardStreak++;
                
                updateUI();
                saveState();
                
                setTimeout(() => renderDailyReward(), 500);
            }
            
            renderDailyReward();
        }

        function renderDailyReward() {
            const container = els.dailyRewardContent;
            const canClaim = canClaimDaily();
            const timeLeft = getTimeUntilNextDaily();
            
            if (!canClaim) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
                container.innerHTML = `
                    <div class="daily-info">
                        <div class="daily-info-title">‚è∞ –°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑:</div>
                        <div class="daily-timer" id="dailyTimerDisplay">${formatTimeShort(timeLeft)}</div>
                        <div class="daily-streak">üî• –°–µ—Ä–∏—è: ${state.dailyRewardStreak} –¥–Ω–µ–π</div>
                        <div class="daily-info-desc" style="margin-top: 12px;">
                            –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫—Ä—É—Ç—ã–µ –Ω–∞–≥—Ä–∞–¥—ã!
                        </div>
                    </div>
                `;
                return;
            }
            
            // –ò–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (dailyGameState.grid.length === 0) {
                initDailyGame();
            }
            
            const reward = dailyGameState.reward;
            
            const rarityNames = {
                common: '–û–±—ã—á–Ω–∞—è',
                rare: '–†–µ–¥–∫–∞—è',
                epic: '–≠–ø–∏—á–µ—Å–∫–∞—è',
                legendary: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è'
            };
            
            const rarityColors = {
                common: '#4ade80',
                rare: '#b366ff',
                epic: '#fbbf24',
                legendary: '#ff4d8d'
            };
            
            container.innerHTML = `
                <div class="daily-info">
                    <div class="daily-info-title">üéÆ –ù–∞–π–¥–∏ –∫–ª—é—á!</div>
                    <div class="daily-info-desc">–£ —Ç–µ–±—è 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–π—Ç–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª—é—á üîë</div>
                    <div class="daily-streak">üî• –°–µ—Ä–∏—è: ${state.dailyRewardStreak} –¥–Ω–µ–π</div>
                    <div style="margin-top: 8px; font-size: 11px; color: ${rarityColors[reward.rarity]};">
                        –ù–∞–≥—Ä–∞–¥–∞: ${rarityNames[reward.rarity]} ‚ú®
                    </div>
                </div>
                
                <div class="daily-game">
                    <div class="daily-progress">
                        –ü–æ–ø—ã—Ç–æ–∫: <span class="keys">${dailyGameState.attempts}/${dailyGameState.maxAttempts}</span>
                    </div>
                    <div class="daily-grid" id="dailyGrid"></div>
                    ${dailyGameState.gameOver && dailyGameState.keysFound >= 1 ? `
                        <div class="daily-reward-display" style="border-color: ${rarityColors[reward.rarity]};">
                            <div class="reward-icon">${reward.icon}</div>
                            <div class="reward-name" style="color: ${rarityColors[reward.rarity]};">${reward.name}</div>
                            <div class="reward-desc">${reward.desc}</div>
                            <div style="margin-top: 8px; font-size: 10px; color: ${rarityColors[reward.rarity]}; text-transform: uppercase; letter-spacing: 1px;">
                                ${rarityNames[reward.rarity]}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            const grid = document.getElementById('dailyGrid');
            dailyGameState.grid.forEach((cell, index) => {
                const cellDiv = document.createElement('div');
                cellDiv.className = `daily-cell ${cell.revealed ? 'revealed' : ''} ${cell.revealed && cell.type === 'key' ? 'key' : ''} ${cell.revealed && cell.type === 'bomb' ? 'bomb' : ''} ${dailyGameState.gameOver ? 'disabled' : ''}`;
                
                if (cell.revealed) {
                    if (cell.type === 'key') cellDiv.textContent = 'üîë';
                    else if (cell.type === 'bomb') cellDiv.textContent = 'üí£';
                } else {
                    cellDiv.textContent = '‚ùì';
                }
                
                if (!cell.revealed && !dailyGameState.gameOver) {
                    cellDiv.addEventListener('click', () => revealCell(index));
                }
                
                grid.appendChild(cellDiv);
            });
        }

        async function switchTab(tabId) {
            const targetTab = document.getElementById(tabId);
            const targetNav = document.querySelector(`[data-tab="${tabId}"]`);
            
            if (!targetTab || !targetNav) return;

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            targetTab.classList.add('active');
            targetNav.classList.add('active');
            
            if (tabId === 'upgradeTab') renderUpgrades();
            if (tabId === 'shopTab') renderShop();
            if (tabId === 'casesTab') renderCases();
            if (tabId === 'achTab') updateAchievementsUI();
            if (tabId === 'inventoryTab') renderInventory();
            if (tabId === 'topTab') await renderLeaderboard(); // –ñ–î–Å–ú –∑–∞–≥—Ä—É–∑–∫–∏!
            if (tabId === 'dailyTab') renderDailyReward();
        }

        function init() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ Telegram WebApp
            const tg = window.Telegram?.WebApp;
            
            if (!tg) {
                // –ó–∞–ø—É—â–µ–Ω–æ –Ω–µ —á–µ—Ä–µ–∑ Telegram
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg-primary); color: var(--text-primary); text-align: center; padding: 20px;">
                        <div>
                            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h2 style="font-size: 24px; margin-bottom: 10px;">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">
                                –≠—Ç–∞ –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram!<br>
                                –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å.
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            initFirebase();
            
            els = {
                userAvatar: document.getElementById('userAvatar'),
                avatarLetter: document.getElementById('avatarLetter'),
                userName: document.getElementById('userName'),
                userRank: document.getElementById('userRank'),
                coinCount: document.getElementById('coinCount'),
                sizeCount: document.getElementById('sizeCount'),
                modelSize: document.getElementById('modelSize'),
                modelCanvas: document.getElementById('modelCanvas'),
                modelContainer: document.getElementById('modelContainer'),
                perClickVal: document.getElementById('perClickVal'),
                exchangeAmount: document.getElementById('exchangeAmount'),
                exchangeBtn: document.getElementById('exchangeBtn'),
                exchangeRate: document.querySelector('.exchange-rate'),
                activeEffectsBar: document.getElementById('activeEffectsBar'),
                shopGrid: document.getElementById('shopGrid'),
                shopTimer: document.getElementById('shopTimer'),
                casesGrid: document.getElementById('casesGrid'),

                activeItems: document.getElementById('activeItems'),
                noActive: document.getElementById('noActive'),
                inventoryGrid: document.getElementById('inventoryGrid'),
                noInventory: document.getElementById('noInventory'),
                leaderboardList: document.getElementById('leaderboardList'),
                modalOverlay: document.getElementById('modalOverlay'),
                modalIcon: document.getElementById('modalIcon'),
                modalTitle: document.getElementById('modalTitle'),
                modalDesc: document.getElementById('modalDesc'),
                modalProfileStats: document.getElementById('modalProfileStats'),
                modalAchGrid: document.getElementById('modalAchGrid'),
                modalBtn: document.getElementById('modalBtn'),
                achInfoDisplay: document.getElementById('achInfoDisplay'),
                achInfoTitle: document.getElementById('achInfoTitle'),
                achInfoDesc: document.getElementById('achInfoDesc'),
                toast: document.getElementById('toast'),
                achGrid: document.getElementById('achGrid'),
                achProgress: document.getElementById('achProgress'),

                currentLevel: document.getElementById('currentLevel'),
                nextLevelBonus: document.getElementById('nextLevelBonus'),
                levelProgress: document.getElementById('levelProgress'),
                achInfoBox: document.getElementById('achInfoBox'),
                upgradeGrid: document.getElementById('upgradeGrid'),
                dailyRewardContent: document.getElementById('dailyRewardContent'),
            };

            loadState();
            
            // Telegram Init - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é tg
            if (tg) {
                tg.ready();
                tg.expand();
                try {
                    tg.enableClosingConfirmation();
                    tg.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim());
                    tg.setBackgroundColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim());
                } catch(e) {}
                
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    state.userName = user.first_name || '–ò–≥—Ä–æ–∫';
                    state.userId = 'tg_' + user.id;
                    if (els.userName) els.userName.textContent = state.userName;
                    if (els.avatarLetter) els.avatarLetter.textContent = state.userName.charAt(0);
                    if (user.photo_url && els.userAvatar) {
                        const img = document.createElement('img');
                        img.src = user.photo_url;
                        els.userAvatar.innerHTML = '';
                        els.userAvatar.appendChild(img);
                    }
                }
            } else {
                if (els.userName) els.userName.textContent = '–ò–≥—Ä–æ–∫';
            }

            // Haptic feedback helper with fallback
            window.haptic = (type = 'light') => {
                const telegram = window.Telegram?.WebApp;
                if (telegram && telegram.HapticFeedback) {
                    if (type === 'light') telegram.HapticFeedback.impactOccurred('light');
                    else if (type === 'medium') telegram.HapticFeedback.impactOccurred('medium');
                    else if (type === 'heavy') telegram.HapticFeedback.impactOccurred('heavy');
                    else if (type === 'success') telegram.HapticFeedback.notificationOccurred('success');
                    else if (type === 'warning') telegram.HapticFeedback.notificationOccurred('warning');
                    else if (type === 'error') telegram.HapticFeedback.notificationOccurred('error');
                } else if (window.navigator?.vibrate) {
                    if (type === 'light') window.navigator.vibrate(10);
                    else if (type === 'medium') window.navigator.vibrate(20);
                    else if (type === 'heavy') window.navigator.vibrate(40);
                }
            };

            initThree();
            
            // ============================================
            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ANTI-AUTOCLICKER
            // ============================================
            
            antiCheat = new AntiAutoClicker(
                els.modelContainer,
                // ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π –∫–ª–∏–∫
                (clickData) => {
                    handleClick({
                        clientX: clickData.x,
                        clientY: clickData.y,
                        target: els.modelContainer
                    });
                },
                // üö´ –û–±–Ω–∞—Ä—É–∂–µ–Ω —á–∏—Ç–µ—Ä
                (cheatData) => {
                    console.warn('üö® Cheat detected!', cheatData);
                    showToast('‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!', 'error');
                    
                    // Haptic feedback —á–µ—Ä–µ–∑ Telegram API
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                    }
                }
            );
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (medium - —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
            antiCheat.setSensitivity('medium');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π - AntiAutoClicker —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–∏
            // Events —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ AntiAutoClicker
            
            els.exchangeBtn.addEventListener('click', () => {
                window.haptic('medium');
                exchangeSize();
            });
            
            document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => {
                window.haptic('light');
                switchTab(n.dataset.tab);
            }));
            
            els.modalOverlay.addEventListener('click', (e) => { if (e.target === els.modalOverlay) closeModal(); });
            
            // Initial Render
            renderShop();
            renderCases();
            renderUpgrades();
            renderLeaderboard();
            updateAchievementsUI();
            updateUI();
            
            // Game loops
            setInterval(() => {
                if (!document.hidden) state.totalPlayTime += 1000;
                checkAchievements();
                saveState();
            }, 1000);
            
            setInterval(processEffects, 1000);
            
            // Upgrade auto-clicker runs every second
            setInterval(processUpgradeAuto, 1000);
            
            // Refresh upgrades UI periodically when on that tab
            setInterval(() => {
                if (document.getElementById('upgradeTab').classList.contains('active')) {
                    renderUpgrades();
                }
            }, 2000);
            
            setInterval(() => {
                const last = parseInt(localStorage.getItem('shopLastUpdate') || Date.now());
                els.shopTimer.textContent = formatTimeShort(Math.max(0, SHOP_REFRESH_MS - (Date.now() - last)));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä–∞–¥—ã –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                const dailyTimerEl = document.getElementById('dailyTimerDisplay');
                if (dailyTimerEl) {
                    dailyTimerEl.textContent = formatTimeShort(getTimeUntilNextDaily());
                }
            }, 1000);
            
            // Handle window resize for Three.js
            window.addEventListener('resize', () => {
                const rect = els.modelContainer.getBoundingClientRect();
                if (camera && renderer) {—è
                    camera.aspect = rect.width / rect.height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(rect.width, rect.height);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
