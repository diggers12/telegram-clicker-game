<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Telegram Clicker Game</title>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      overflow-x: hidden;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* Container */
    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navigation */
    .nav {
      display: flex;
      justify-content: space-around;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 10px;
      margin-bottom: 20px;
      position: sticky;
      top: 10px;
      z-index: 100;
      gap: 5px;
    }

    .nav-button {
      flex: 1;
      padding: 12px 8px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 15px;
      transition: all 0.3s ease;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .nav-button.active {
      background: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .nav-icon {
      font-size: 20px;
    }

    .nav-label {
      font-size: 10px;
    }

    /* Views */
    .view {
      display: none;
      flex: 1;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Card style */
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* Button styles */
    .button {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 15px;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 44px;
      min-height: 44px;
    }

    .button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .button:active {
      transform: scale(0.95);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #app {
        padding: 10px;
      }

      .nav-button {
        font-size: 11px;
        padding: 10px 6px;
      }

      .nav-icon {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .nav-button {
        font-size: 10px;
        padding: 8px 4px;
      }

      .nav-icon {
        font-size: 16px;
      }

      .nav-label {
        font-size: 9px;
      }
    }

    /* Loading state */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-size: 24px;
      font-weight: 600;
    }

    /* Error state */
    .error {
      background: rgba(255, 59, 48, 0.2);
      border: 2px solid rgba(255, 59, 48, 0.5);
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      text-align: center;
    }

    .error-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .error-message {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    /* Particle canvas */
    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* ClickerView styles */
    .clicker-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .player-info {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
    }

    .player-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin-bottom: 10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .player-name {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #FFD700;
    }

    .boosts-container {
      min-height: 40px;
    }

    .boosts-list {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 15px;
      padding: 15px;
    }

    .boosts-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .boost-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .boost-item:last-child {
      margin-bottom: 0;
    }

    .boost-icon {
      font-size: 20px;
    }

    .boost-multiplier {
      font-size: 18px;
      font-weight: 700;
      color: #FFD700;
      flex: 1;
    }

    .boost-timer {
      font-size: 14px;
      opacity: 0.8;
    }

    .click-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .click-button {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      border: 5px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .click-button:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    .click-button:active {
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .click-emoji {
      display: block;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .click-hint {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.7;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px;
    }

    .progress-label {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .antiboosts-warning {
      background: rgba(255, 59, 48, 0.2);
      border: 2px solid rgba(255, 59, 48, 0.5);
      border-radius: 15px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .warning-icon {
      font-size: 24px;
    }

    .warning-text {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
    }

    /* Shop styles */
    .shop-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .shop-header {
      text-align: center;
    }

    .shop-title {
      font-size: 28px;
      margin-bottom: 15px;
    }

    .shop-currency {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .currency-value {
      color: #FFD700;
      font-weight: 700;
    }

    .shop-timer {
      font-size: 14px;
      opacity: 0.8;
    }

    .shop-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }

    .shop-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .shop-item-disabled {
      opacity: 0.6;
    }

    .item-header {
      margin-bottom: 10px;
    }

    .item-name {
      font-size: 18px;
      font-weight: 700;
    }

    .item-description {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .item-effect {
      font-size: 13px;
      color: #FFD700;
      margin-bottom: 15px;
    }

    .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-price {
      font-size: 16px;
      font-weight: 700;
    }

    .item-buy-button {
      padding: 8px 16px;
      background: rgba(76, 175, 80, 0.8);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .item-buy-button:hover:not(:disabled) {
      background: rgba(76, 175, 80, 1);
      transform: scale(1.05);
    }

    .item-buy-button:disabled {
      background: rgba(255, 255, 255, 0.2);
      cursor: not-allowed;
    }

    /* Profile styles */
    .profile-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .profile-header {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 4px solid rgba(255, 255, 255, 0.3);
    }

    .profile-avatar-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
    }

    .profile-name {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .profile-rank {
      font-size: 16px;
      opacity: 0.8;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }

    .stat-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .stat-content {
      flex: 1;
    }

    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 15px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.02);
    }

    /* Leaderboard styles */
    .leaderboard-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .leaderboard-header {
      text-align: center;
    }

    .leaderboard-title {
      font-size: 28px;
      margin-bottom: 15px;
    }

    .leaderboard-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 14px;
    }

    .player-rank-card {
      background: rgba(255, 215, 0, 0.2);
      border: 2px solid rgba(255, 215, 0, 0.5);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .rank-value {
      font-size: 48px;
      font-weight: 700;
      color: #FFD700;
    }

    .leaderboard-list {
      max-height: 600px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leaderboard-entry {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      transition: all 0.3s ease;
    }

    .leaderboard-entry:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .leaderboard-entry-current {
      background: rgba(255, 215, 0, 0.2);
      border: 2px solid rgba(255, 215, 0, 0.5);
    }

    .entry-rank {
      font-size: 24px;
      font-weight: 700;
      min-width: 50px;
      text-align: center;
    }

    .entry-info {
      flex: 1;
    }

    .entry-name {
      font-size: 18px;
      font-weight: 600;
    }

    .entry-updated {
      font-size: 12px;
      opacity: 0.7;
    }

    .entry-size {
      font-size: 20px;
      font-weight: 700;
      color: #FFD700;
    }

    /* Achievements styles */
    .achievements-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .achievements-header {
      text-align: center;
    }

    .achievements-title {
      font-size: 28px;
      margin-bottom: 15px;
    }

    .achievements-progress {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .achievements-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .filter-button {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 15px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .filter-active {
      background: rgba(255, 215, 0, 0.3);
      border: 2px solid rgba(255, 215, 0, 0.5);
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .achievement-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px;
      display: flex;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .achievement-unlocked {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    .achievement-locked {
      opacity: 0.6;
    }

    .achievement-icon-container {
      position: relative;
    }

    .achievement-icon {
      font-size: 48px;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 13px;
      opacity: 0.9;
    }

    /* Notification styles */
    .achievement-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 215, 0, 0.95);
      color: #000;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: flex;
      gap: 15px;
      align-items: center;
      max-width: 400px;
    }

    .achievement-notification .achievement-icon {
      font-size: 48px;
    }

    .achievement-title {
      font-size: 14px;
      font-weight: 600;
      opacity: 0.8;
    }

    .achievement-notification .achievement-name {
      font-size: 18px;
      font-weight: 700;
      margin: 5px 0;
    }

    .achievement-notification .achievement-description {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <canvas id="particle-canvas"></canvas>
  <div id="app">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    'use strict';

    // ============================================================================
    // Core Modules
    // ============================================================================

    /**
     * StateManager - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
     */
    class StateManager {
      constructor() {
        this.state = {
          player: {
            id: null,
            name: null,
            avatar: null,
            size: 0,
            currency: 0,
            totalClicks: 0,
            playTime: 0,
            startTime: Date.now(),
            baseClickValue: 1,
            baseCurrencyValue: 1
          },
          boosts: [],
          antiBoosts: [],
          achievements: [],
          shopItems: [],
          lastShopUpdate: null,
          statistics: {
            casesOpened: 0,
            itemsPurchased: 0
          }
        };
        this.listeners = new Map();
      }

      getState() {
        return JSON.parse(JSON.stringify(this.state));
      }

      get(path) {
        const keys = path.split('.');
        let value = this.state;
        for (const key of keys) {
          if (value === null || value === undefined) return undefined;
          value = value[key];
        }
        return value;
      }

      setState(path, value) {
        const keys = path.split('.');
        const lastKey = keys.pop();
        let target = this.state;
        
        for (const key of keys) {
          if (!(key in target)) {
            target[key] = {};
          }
          target = target[key];
        }
        
        target[lastKey] = value;
        this.notify(path, value);
      }

      update(path, updates) {
        const current = this.get(path);
        if (typeof current === 'object' && current !== null) {
          const updated = { ...current, ...updates };
          this.setState(path, updated);
        }
      }

      subscribe(path, callback) {
        if (!this.listeners.has(path)) {
          this.listeners.set(path, []);
        }
        this.listeners.get(path).push(callback);
        
        return () => {
          const callbacks = this.listeners.get(path);
          const index = callbacks.indexOf(callback);
          if (index > -1) {
            callbacks.splice(index, 1);
          }
        };
      }

      notify(path, value) {
        if (this.listeners.has(path)) {
          this.listeners.get(path).forEach(callback => callback(value, path));
        }
        
        const parts = path.split('.');
        for (let i = parts.length - 1; i > 0; i--) {
          const parentPath = parts.slice(0, i).join('.');
          if (this.listeners.has(parentPath)) {
            const parentValue = this.get(parentPath);
            this.listeners.get(parentPath).forEach(callback => callback(parentValue, parentPath));
          }
        }
      }

      loadState(newState) {
        this.state = newState;
        this.listeners.forEach((callbacks, path) => {
          const value = this.get(path);
          callbacks.forEach(callback => callback(value, path));
        });
      }
    }

    /**
     * EventBus - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
     */
    class EventBus {
      constructor() {
        this.events = new Map();
      }

      on(event, callback) {
        if (!this.events.has(event)) {
          this.events.set(event, []);
        }
        this.events.get(event).push(callback);
        
        return () => this.off(event, callback);
      }

      off(event, callback) {
        if (!this.events.has(event)) return;
        
        const callbacks = this.events.get(event);
        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
        }
      }

      emit(event, data) {
        if (!this.events.has(event)) return;
        
        this.events.get(event).forEach(callback => {
          try {
            callback(data);
          } catch (error) {
            console.error(`Error in event handler for "${event}":`, error);
          }
        });
      }

      once(event, callback) {
        const onceCallback = (data) => {
          callback(data);
          this.off(event, onceCallback);
        };
        this.on(event, onceCallback);
      }

      clear(event) {
        if (event) {
          this.events.delete(event);
        } else {
          this.events.clear();
        }
      }
    }

    /**
     * StorageManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
     */
    class StorageManager {
      constructor(stateManager) {
        this.stateManager = stateManager;
        this.STORAGE_KEY = 'telegram_clicker_game';
        this.SAVE_DEBOUNCE_MS = 1000;
        this.saveTimeout = null;
        this.isAvailable = this.checkAvailability();
      }

      checkAvailability() {
        try {
          const test = '__storage_test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
          return false;
        }
      }

      load() {
        if (!this.isAvailable) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞');
          return null;
        }

        try {
          const data = localStorage.getItem(this.STORAGE_KEY);
          if (!data) {
            return null;
          }

          const parsed = JSON.parse(data);
          
          if (!this.validateState(parsed)) {
            console.warn('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã');
            return null;
          }

          return parsed;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
          return null;
        }
      }

      validateState(state) {
        if (!state || typeof state !== 'object') return false;
        if (!state.player || typeof state.player !== 'object') return false;
        if (typeof state.player.size !== 'number' || state.player.size < 0) return false;
        if (typeof state.player.currency !== 'number' || state.player.currency < 0) return false;
        if (typeof state.player.totalClicks !== 'number' || state.player.totalClicks < 0) return false;
        if (!Array.isArray(state.boosts)) return false;
        if (!Array.isArray(state.antiBoosts)) return false;
        if (!Array.isArray(state.achievements)) return false;
        if (!Array.isArray(state.shopItems)) return false;
        
        return true;
      }

      save() {
        if (!this.isAvailable) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ');
          return;
        }

        if (this.saveTimeout) {
          clearTimeout(this.saveTimeout);
        }

        this.saveTimeout = setTimeout(() => {
          this.saveImmediate();
        }, this.SAVE_DEBOUNCE_MS);
      }

      saveImmediate() {
        if (!this.isAvailable) return;

        try {
          const state = this.stateManager.getState();
          const serialized = JSON.stringify(state);
          localStorage.setItem(this.STORAGE_KEY, serialized);
        } catch (error) {
          if (error.name === 'QuotaExceededError') {
            console.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ LocalStorage');
          } else {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
          }
        }
      }

      clear() {
        if (!this.isAvailable) return;

        try {
          localStorage.removeItem(this.STORAGE_KEY);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
      }
    }

    /**
     * TelegramBridge - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp API
     */
    class TelegramBridge {
      constructor() {
        this.tg = window.Telegram?.WebApp;
        this.isAvailable = !!this.tg;
      }

      init() {
        if (!this.isAvailable) {
          // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          console.warn('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º');
          return {
            id: 'demo_' + Date.now(),
            first_name: '–î–µ–º–æ',
            last_name: '–ò–≥—Ä–æ–∫',
            username: 'demo_player',
            photo_url: ''
          };
        }

        try {
          this.tg.ready();
          this.tg.expand();
          
          const userData = this.getUserData();
          
          if (!userData) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram');
          }

          return userData;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
          throw error;
        }
      }

      getUserData() {
        if (!this.isAvailable) {
          return null;
        }

        try {
          const user = this.tg.initDataUnsafe?.user;
          
          if (!user) {
            return null;
          }

          return {
            id: user.id?.toString() || null,
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: user.username || '',
            photo_url: user.photo_url || ''
          };
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          return null;
        }
      }

      shareScore(size, rank) {
        if (!this.isAvailable) {
          alert(`–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –†–∞–∑–º–µ—Ä ${size}, –ü–æ–∑–∏—Ü–∏—è #${rank}`);
          return;
        }

        try {
          const message = `üéÆ –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram Clicker Game!\n\nüìä –†–∞–∑–º–µ—Ä: ${size}\nüèÜ –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: ${rank}\n\n–ü–æ–ø—Ä–æ–±—É–π –æ–±–æ–≥–Ω–∞—Ç—å –º–µ–Ω—è!`;
          this.tg.switchInlineQuery(message, ['users', 'groups']);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
        }
      }

      setHeaderColor(color) {
        if (!this.isAvailable) return;

        try {
          this.tg.setHeaderColor(color);
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞:', error);
        }
      }

      showAlert(message) {
        if (!this.isAvailable) {
          alert(message);
          return;
        }

        try {
          this.tg.showAlert(message);
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', error);
          alert(message);
        }
      }

      hapticFeedback(type = 'light') {
        if (!this.isAvailable) return;

        try {
          const validTypes = ['light', 'medium', 'heavy', 'rigid', 'soft'];
          const notificationTypes = ['error', 'success', 'warning'];
          
          if (validTypes.includes(type)) {
            this.tg.HapticFeedback?.impactOccurred(type);
          } else if (notificationTypes.includes(type)) {
            this.tg.HapticFeedback?.notificationOccurred(type);
          }
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å haptic feedback:', error);
        }
      }
    }

    /**
     * GameEngine - –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
     */
    class GameEngine {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.baseClickValue = 1;
        this.baseCurrencyValue = 1;
      }

      handleClick(x, y) {
        const multiplier = this.calculateMultiplier();
        const player = this.stateManager.get('player');
        const baseClickValue = player.baseClickValue || this.baseClickValue;
        const baseCurrencyValue = player.baseCurrencyValue || this.baseCurrencyValue;
        
        const sizeIncrease = baseClickValue * multiplier;
        const currencyIncrease = baseCurrencyValue;
        
        const newSize = player.size + sizeIncrease;
        const newCurrency = player.currency + currencyIncrease;
        const newTotalClicks = player.totalClicks + 1;
        
        this.stateManager.setState('player.size', newSize);
        this.stateManager.setState('player.currency', newCurrency);
        this.stateManager.setState('player.totalClicks', newTotalClicks);
        
        this.eventBus.emit('click', {
          x,
          y,
          sizeIncrease,
          currencyIncrease,
          multiplier
        });
        
        this.eventBus.emit('checkAchievements');
      }

      calculateMultiplier() {
        const boosts = this.stateManager.get('boosts') || [];
        const currentTime = Date.now();
        
        const activeBoosts = boosts.filter(boost => {
          return boost.endTime > currentTime;
        });
        
        if (activeBoosts.length === 0) {
          return 1.0;
        }
        
        const totalMultiplier = activeBoosts.reduce((acc, boost) => {
          return acc * (boost.multiplier || 1.0);
        }, 1.0);
        
        return totalMultiplier;
      }

      update(deltaTime) {
        const currentTime = Date.now();
        
        const boosts = this.stateManager.get('boosts') || [];
        const activeBoosts = boosts.filter(boost => {
          const isActive = boost.endTime > currentTime;
          
          if (!isActive) {
            this.eventBus.emit('boostExpired', { boost });
          }
          
          return isActive;
        });
        
        if (activeBoosts.length !== boosts.length) {
          this.stateManager.setState('boosts', activeBoosts);
        }
        
        const antiBoosts = this.stateManager.get('antiBoosts') || [];
        const activeAntiBoosts = antiBoosts.filter(antiBoost => {
          const isActive = antiBoost.endTime > currentTime;
          
          if (!isActive) {
            this.eventBus.emit('antiBoostExpired', { antiBoost });
          }
          
          return isActive;
        });
        
        if (activeAntiBoosts.length !== antiBoosts.length) {
          this.stateManager.setState('antiBoosts', activeAntiBoosts);
        }
        
        const player = this.stateManager.get('player');
        if (player && player.startTime) {
          const playTime = Math.floor((currentTime - player.startTime) / 1000);
          if (playTime !== player.playTime) {
            this.stateManager.setState('player.playTime', playTime);
          }
        }
      }
    }

    /**
     * ParticleSystem - –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—Ü
     */
    class ParticleSystem {
      constructor() {
        this.particles = [];
        this.maxParticles = 50;
      }

      emit(x, y, count, config = {}) {
        const defaultConfig = {
          color: '#ffffff',
          size: 4,
          velocity: 2,
          lifetime: 1000,
          gravity: 0.5
        };

        const finalConfig = { ...defaultConfig, ...config };

        if (this.particles.length + count > this.maxParticles) {
          const toRemove = this.particles.length + count - this.maxParticles;
          this.particles.splice(0, toRemove);
        }

        const currentTime = Date.now();
        for (let i = 0; i < count; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = finalConfig.velocity * (0.5 + Math.random() * 0.5);

          const particle = {
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: finalConfig.color,
            size: finalConfig.size * (0.7 + Math.random() * 0.6),
            lifetime: finalConfig.lifetime,
            createdAt: currentTime,
            gravity: finalConfig.gravity,
            alpha: 1.0
          };

          this.particles.push(particle);
        }
      }

      update(deltaTime) {
        const currentTime = Date.now();

        this.particles = this.particles.filter(particle => {
          const age = currentTime - particle.createdAt;
          if (age >= particle.lifetime) {
            return false;
          }

          particle.x += particle.vx;
          particle.y += particle.vy;
          particle.vy += particle.gravity;

          const lifeProgress = age / particle.lifetime;
          particle.alpha = 1.0 - lifeProgress;

          return true;
        });
      }

      render(ctx) {
        ctx.save();

        this.particles.forEach(particle => {
          ctx.globalAlpha = particle.alpha;
          ctx.fillStyle = particle.color;
          ctx.beginPath();
          ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
          ctx.fill();
        });

        ctx.restore();
      }

      getParticleCount() {
        return this.particles.length;
      }

      clear() {
        this.particles = [];
      }
    }

    /**
     * ClickerView - –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
     */
    class ClickerView {
      constructor(stateManager, eventBus, gameEngine) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.gameEngine = gameEngine;
        this.container = null;
        
        this.visualThresholds = [
          { size: 0, scale: 1.0, emoji: 'üéØ' },
          { size: 100, scale: 1.2, emoji: 'üéÆ' },
          { size: 500, scale: 1.4, emoji: 'üöÄ' },
          { size: 1000, scale: 1.6, emoji: '‚≠ê' },
          { size: 5000, scale: 1.8, emoji: 'üíé' },
          { size: 10000, scale: 2.0, emoji: 'üëë' },
          { size: 50000, scale: 2.2, emoji: 'üî•' },
          { size: 100000, scale: 2.5, emoji: 'üåü' }
        ];
        
        this.stateManager.subscribe('player', () => {
          this.updateVisuals();
        });
      }

      render(container) {
        this.container = container;
        const state = this.stateManager.getState();
        const player = state.player;
        
        const visualLevel = this.getVisualLevel(player.size);
        
        container.innerHTML = `
          <div class="clicker-container">
            <div class="player-info">
              ${player.avatar ? `<img src="${player.avatar}" alt="${player.name}" class="player-avatar">` : ''}
              <h2 class="player-name">${player.name || '–ò–≥—Ä–æ–∫'}</h2>
            </div>
            
            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                <div class="stat-value" id="size-display">${this.formatNumber(player.size)}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">–í–∞–ª—é—Ç–∞</div>
                <div class="stat-value" id="currency-display">${this.formatNumber(player.currency)}</div>
              </div>
            </div>
            
            <div class="boosts-container" id="boosts-display">
              ${this.renderBoosts(state.boosts)}
            </div>
            
            <div class="click-area">
              <button id="click-button" class="click-button" style="transform: scale(${visualLevel.scale})">
                <span class="click-emoji">${visualLevel.emoji}</span>
              </button>
              <div class="click-hint">–ù–∞–∂–º–∏ –º–µ–Ω—è!</div>
            </div>
            
            <div class="progress-container">
              <div class="progress-label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: ${this.getProgressToNextLevel(player.size)}%"></div>
              </div>
            </div>
            
            ${state.antiBoosts.length > 0 ? `
              <div class="antiboosts-warning">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-text">–ê–∫—Ç–∏–≤–Ω—ã –∞–Ω—Ç–∏–±—É—Å—Ç—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –≤ –ø—Ä–æ—Ñ–∏–ª–µ.</div>
              </div>
            ` : ''}
          </div>
        `;
        
        this.setupClickHandler();
        this.updateVisuals();
      }

      setupClickHandler() {
        const clickButton = document.getElementById('click-button');
        if (!clickButton) return;
        
        clickButton.addEventListener('click', (event) => {
          this.handleClick(event);
        });
      }

      handleClick(event) {
        const clickButton = event.currentTarget;
        
        this.gameEngine.handleClick(event.clientX, event.clientY);
        
        clickButton.style.transform = `scale(${this.getCurrentScale() * 0.95})`;
        setTimeout(() => {
          clickButton.style.transform = `scale(${this.getCurrentScale()})`;
        }, 100);
      }

      updateVisuals() {
        if (!this.container) return;
        
        const state = this.stateManager.getState();
        const player = state.player;
        
        const sizeDisplay = document.getElementById('size-display');
        const currencyDisplay = document.getElementById('currency-display');
        
        if (sizeDisplay) {
          sizeDisplay.textContent = this.formatNumber(player.size);
        }
        
        if (currencyDisplay) {
          currencyDisplay.textContent = this.formatNumber(player.currency);
        }
        
        const clickButton = document.getElementById('click-button');
        const visualLevel = this.getVisualLevel(player.size);
        
        if (clickButton) {
          const emoji = clickButton.querySelector('.click-emoji');
          if (emoji) {
            emoji.textContent = visualLevel.emoji;
          }
          clickButton.style.transform = `scale(${visualLevel.scale})`;
        }
        
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) {
          progressFill.style.width = `${this.getProgressToNextLevel(player.size)}%`;
        }
        
        const boostsDisplay = document.getElementById('boosts-display');
        if (boostsDisplay) {
          boostsDisplay.innerHTML = this.renderBoosts(state.boosts);
        }
      }

      getVisualLevel(size) {
        for (let i = this.visualThresholds.length - 1; i >= 0; i--) {
          if (size >= this.visualThresholds[i].size) {
            return this.visualThresholds[i];
          }
        }
        return this.visualThresholds[0];
      }

      getCurrentScale() {
        const player = this.stateManager.get('player');
        const visualLevel = this.getVisualLevel(player.size);
        return visualLevel.scale;
      }

      getProgressToNextLevel(size) {
        let currentThreshold = this.visualThresholds[0];
        let nextThreshold = null;
        
        for (let i = 0; i < this.visualThresholds.length; i++) {
          if (size >= this.visualThresholds[i].size) {
            currentThreshold = this.visualThresholds[i];
            if (i + 1 < this.visualThresholds.length) {
              nextThreshold = this.visualThresholds[i + 1];
            }
          }
        }
        
        if (!nextThreshold) {
          return 100;
        }
        
        const range = nextThreshold.size - currentThreshold.size;
        const progress = size - currentThreshold.size;
        return Math.min(100, (progress / range) * 100);
      }

      formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(2) + 'M';
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'K';
        }
        return num.toFixed(0);
      }

      renderBoosts(boosts) {
        if (!boosts || boosts.length === 0) {
          return '';
        }
        
        const currentTime = Date.now();
        const activeBoosts = boosts.filter(boost => boost.endTime > currentTime);
        
        if (activeBoosts.length === 0) {
          return '';
        }
        
        return `
          <div class="boosts-list">
            <div class="boosts-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã:</div>
            ${activeBoosts.map(boost => {
              const timeLeft = Math.ceil((boost.endTime - currentTime) / 1000);
              return `
                <div class="boost-item">
                  <span class="boost-icon">‚ö°</span>
                  <span class="boost-multiplier">x${boost.multiplier.toFixed(1)}</span>
                  <span class="boost-timer">${this.formatTime(timeLeft)}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (minutes > 0) {
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        return `${secs}s`;
      }
    }

    // ============================================================================
    // Game Managers
    // ============================================================================

    /**
     * BoostManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É—Å—Ç–∞–º–∏ –∏ –∞–Ω—Ç–∏–±—É—Å—Ç–∞–º–∏
     */
    class BoostManager {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        
        this.eventBus.on('boost:add', (data) => {
          this.addBoost(data.type, data.multiplier, data.duration);
        });
        
        this.eventBus.on('antiboost:add', (data) => {
          this.addAntiBoost(data.type, data.effect || {}, data.duration);
        });
        
        this.eventBus.on('antiboost:use', (data) => {
          this.useAntiBoost(data.antiBoostId);
        });
      }

      addBoost(type, multiplier, duration) {
        const currentTime = Date.now();
        const boost = {
          id: this.generateId(),
          type,
          multiplier,
          duration,
          startTime: currentTime,
          endTime: currentTime + (duration * 1000)
        };

        const boosts = this.stateManager.get('boosts') || [];
        boosts.push(boost);
        this.stateManager.setState('boosts', boosts);

        this.eventBus.emit('boostAdded', { boost });
        return boost.id;
      }

      addAntiBoost(type, effect, duration) {
        const currentTime = Date.now();
        const antiBoost = {
          id: this.generateId(),
          type,
          effect,
          duration,
          startTime: currentTime,
          endTime: currentTime + (duration * 1000),
          blocking: this.isBlockingType(type)
        };

        const antiBoosts = this.stateManager.get('antiBoosts') || [];
        antiBoosts.push(antiBoost);
        this.stateManager.setState('antiBoosts', antiBoosts);

        this.eventBus.emit('antiBoostAdded', { antiBoost });
        return antiBoost.id;
      }

      useAntiBoost(antiBoostId) {
        const antiBoosts = this.stateManager.get('antiBoosts') || [];
        const antiBoostIndex = antiBoosts.findIndex(ab => ab.id === antiBoostId);

        if (antiBoostIndex === -1) {
          return false;
        }

        const antiBoost = antiBoosts[antiBoostIndex];
        this.applyAntiBoostEffect(antiBoost);

        antiBoosts.splice(antiBoostIndex, 1);
        this.stateManager.setState('antiBoosts', antiBoosts);

        this.eventBus.emit('antiBoostUsed', { antiBoost });
        return true;
      }

      applyAntiBoostEffect(antiBoost) {
        const player = this.stateManager.get('player');

        switch (antiBoost.type) {
          case 'Click Blocker':
            break;

          case 'Currency Drain':
            if (antiBoost.effect && typeof antiBoost.effect.amount === 'number') {
              const newCurrency = Math.max(0, player.currency - antiBoost.effect.amount);
              this.stateManager.setState('player.currency', newCurrency);
            }
            break;

          case 'Multiplier Reducer':
            if (antiBoost.effect && typeof antiBoost.effect.percent === 'number') {
              const reduction = player.size * (antiBoost.effect.percent / 100);
              const newSize = Math.max(0, player.size - reduction);
              this.stateManager.setState('player.size', newSize);
            }
            break;
        }
      }

      isBlockingType(type) {
        return ['Click Blocker'].includes(type);
      }

      generateId() {
        return `${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
      }
    }

    /**
     * ShopManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º
     */
    class ShopManager {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.SHOP_UPDATE_INTERVAL = 24 * 60 * 60 * 1000;
        
        this.itemTemplates = [
          { id: 'size_boost_small', name: 'üîπ –ú–∞–ª—ã–π —É—Å–∏–ª–∏—Ç–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ 1', price: 100, type: 'permanent_size_boost', effect: { value: 1 } },
          { id: 'size_boost_medium', name: 'üî∑ –°—Ä–µ–¥–Ω–∏–π —É—Å–∏–ª–∏—Ç–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ 5', price: 500, type: 'permanent_size_boost', effect: { value: 5 } },
          { id: 'size_boost_large', name: 'üíé –ë–æ–ª—å—à–æ–π —É—Å–∏–ª–∏—Ç–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ 10', price: 1000, type: 'permanent_size_boost', effect: { value: 10 } },
          { id: 'size_boost_mega', name: 'üí† –ú–µ–≥–∞ —É—Å–∏–ª–∏—Ç–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ 25', price: 2500, type: 'permanent_size_boost', effect: { value: 25 } },
          { id: 'currency_boost_small', name: 'ü™ô –ú–∞–ª—ã–π —É—Å–∏–ª–∏—Ç–µ–ª—å –≤–∞–ª—é—Ç—ã', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –≤–∞–ª—é—Ç—ã –Ω–∞ 1', price: 150, type: 'permanent_currency_boost', effect: { value: 1 } },
          { id: 'currency_boost_medium', name: 'üí∞ –°—Ä–µ–¥–Ω–∏–π —É—Å–∏–ª–∏—Ç–µ–ª—å –≤–∞–ª—é—Ç—ã', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –≤–∞–ª—é—Ç—ã –Ω–∞ 5', price: 750, type: 'permanent_currency_boost', effect: { value: 5 } },
          { id: 'currency_boost_large', name: 'üíµ –ë–æ–ª—å—à–æ–π —É—Å–∏–ª–∏—Ç–µ–ª—å –≤–∞–ª—é—Ç—ã', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –≤–∞–ª—é—Ç—ã –Ω–∞ 10', price: 1500, type: 'permanent_currency_boost', effect: { value: 10 } },
          { id: 'currency_boost_mega', name: 'üí∏ –ú–µ–≥–∞ —É—Å–∏–ª–∏—Ç–µ–ª—å –≤–∞–ª—é—Ç—ã', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –≤–∞–ª—é—Ç—ã –Ω–∞ 25', price: 3000, type: 'permanent_currency_boost', effect: { value: 25 } },
          { id: 'multiplier_1min_1_5x', name: '‚ö° –ë—ã—Å—Ç—Ä—ã–π –±—É—Å—Ç 1.5x', description: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å 1.5x –Ω–∞ 1 –º–∏–Ω—É—Ç—É', price: 200, type: 'temporary_multiplier', effect: { multiplier: 1.5, duration: 60 } },
          { id: 'multiplier_3min_2x', name: '‚ö°‚ö° –°—Ä–µ–¥–Ω–∏–π –±—É—Å—Ç 2x', description: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å 2x –Ω–∞ 3 –º–∏–Ω—É—Ç—ã', price: 500, type: 'temporary_multiplier', effect: { multiplier: 2.0, duration: 180 } },
          { id: 'multiplier_5min_2_5x', name: '‚ö°‚ö°‚ö° –ë–æ–ª—å—à–æ–π –±—É—Å—Ç 2.5x', description: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å 2.5x –Ω–∞ 5 –º–∏–Ω—É—Ç', price: 1000, type: 'temporary_multiplier', effect: { multiplier: 2.5, duration: 300 } },
          { id: 'multiplier_10min_3x', name: '‚ö°‚ö°‚ö°‚ö° –ú–µ–≥–∞ –±—É—Å—Ç 3x', description: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å 3x –Ω–∞ 10 –º–∏–Ω—É—Ç', price: 2000, type: 'temporary_multiplier', effect: { multiplier: 3.0, duration: 600 } },
          { id: 'case_key_bronze', name: 'üîë –ë—Ä–æ–Ω–∑–æ–≤—ã–π –∫–ª—é—á', description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –∫–µ–π—Å', price: 300, type: 'case_key', effect: { count: 1 } },
          { id: 'case_key_silver', name: 'üóùÔ∏è –°–µ—Ä–µ–±—Ä—è–Ω—ã–π –∫–ª—é—á', description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç 3 –∫–µ–π—Å–∞', price: 800, type: 'case_key', effect: { count: 3 } },
          { id: 'case_key_gold', name: 'üîê –ó–æ–ª–æ—Ç–æ–π –∫–ª—é—á', description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç 5 –∫–µ–π—Å–æ–≤', price: 1200, type: 'case_key', effect: { count: 5 } },
          { id: 'starter_pack', name: 'üì¶ –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä', description: '–†–∞–∑–º–µ—Ä +5, –í–∞–ª—é—Ç–∞ +5, –ë—É—Å—Ç 1.5x –Ω–∞ 2 –º–∏–Ω', price: 600, type: 'combo_pack', effect: { sizeBoost: 5, currencyBoost: 5, multiplier: 1.5, duration: 120 } },
          { id: 'advanced_pack', name: 'üéÅ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –Ω–∞–±–æ—Ä', description: '–†–∞–∑–º–µ—Ä +15, –í–∞–ª—é—Ç–∞ +15, –ë—É—Å—Ç 2x –Ω–∞ 5 –º–∏–Ω', price: 1500, type: 'combo_pack', effect: { sizeBoost: 15, currencyBoost: 15, multiplier: 2.0, duration: 300 } },
          { id: 'premium_pack', name: 'üéâ –ü—Ä–µ–º–∏—É–º –Ω–∞–±–æ—Ä', description: '–†–∞–∑–º–µ—Ä +30, –í–∞–ª—é—Ç–∞ +30, –ë—É—Å—Ç 2.5x –Ω–∞ 10 –º–∏–Ω', price: 3500, type: 'combo_pack', effect: { sizeBoost: 30, currencyBoost: 30, multiplier: 2.5, duration: 600 } },
          { id: 'instant_size_small', name: 'üìà –ú–∞–ª—ã–π –±–æ–Ω—É—Å —Ä–∞–∑–º–µ—Ä–∞', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +50 –∫ —Ä–∞–∑–º–µ—Ä—É', price: 250, type: 'instant_size', effect: { value: 50 } },
          { id: 'instant_size_large', name: 'üìä –ë–æ–ª—å—à–æ–π –±–æ–Ω—É—Å —Ä–∞–∑–º–µ—Ä–∞', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +200 –∫ —Ä–∞–∑–º–µ—Ä—É', price: 800, type: 'instant_size', effect: { value: 200 } },
          { id: 'instant_currency_small', name: 'üí¥ –ú–∞–ª—ã–π –±–æ–Ω—É—Å –≤–∞–ª—é—Ç—ã', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +100 –≤–∞–ª—é—Ç—ã', price: 50, type: 'instant_currency', effect: { value: 100 } },
          { id: 'instant_currency_large', name: 'üí∂ –ë–æ–ª—å—à–æ–π –±–æ–Ω—É—Å –≤–∞–ª—é—Ç—ã', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +500 –≤–∞–ª—é—Ç—ã', price: 200, type: 'instant_currency', effect: { value: 500 } }
        ];
      }

      generateShopItems(count = 8) {
        const shuffled = [...this.itemTemplates];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        
        const selectedItems = shuffled.slice(0, Math.min(count, shuffled.length));
        return selectedItems.map((template, index) => ({
          ...template,
          shopId: `${template.id}_${Date.now()}_${index}`
        }));
      }

      checkShopUpdate() {
        const state = this.stateManager.getState();
        const now = Date.now();
        const lastUpdate = state.lastShopUpdate;
        
        if (!lastUpdate || (now - lastUpdate) >= this.SHOP_UPDATE_INTERVAL) {
          const newItems = this.generateShopItems();
          this.stateManager.setState('shopItems', newItems);
          this.stateManager.setState('lastShopUpdate', now);
          this.eventBus.emit('shop:updated', { items: newItems, timestamp: now });
          return true;
        }
        return false;
      }

      purchaseItem(shopId) {
        const state = this.stateManager.getState();
        const item = state.shopItems.find(i => i.shopId === shopId);
        
        if (!item) return { success: false, message: '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' };
        if (state.player.currency < item.price) return { success: false, message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞–ª—é—Ç—ã' };
        
        this.stateManager.setState('player.currency', state.player.currency - item.price);
        this.applyItemEffect(item);
        
        const currentPurchases = state.statistics.itemsPurchased || 0;
        this.stateManager.setState('statistics.itemsPurchased', currentPurchases + 1);
        
        this.eventBus.emit('shop:purchase', { item, remainingCurrency: state.player.currency - item.price });
        this.eventBus.emit('checkAchievements');
        
        return { success: true, message: '–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞' };
      }

      applyItemEffect(item) {
        const state = this.stateManager.getState();
        
        switch (item.type) {
          case 'permanent_size_boost':
            const currentSizeValue = state.player.baseClickValue || 1;
            this.stateManager.setState('player.baseClickValue', currentSizeValue + item.effect.value);
            break;
            
          case 'permanent_currency_boost':
            const currentCurrencyValue = state.player.baseCurrencyValue || 1;
            this.stateManager.setState('player.baseCurrencyValue', currentCurrencyValue + item.effect.value);
            break;
            
          case 'temporary_multiplier':
            this.eventBus.emit('boost:add', { type: 'multiplier', multiplier: item.effect.multiplier, duration: item.effect.duration });
            break;
            
          case 'case_key':
            this.eventBus.emit('case:keys_added', { count: item.effect.count });
            break;
            
          case 'combo_pack':
            const currentSizeBoost = state.player.baseClickValue || 1;
            const currentCurrencyBoost = state.player.baseCurrencyValue || 1;
            this.stateManager.setState('player.baseClickValue', currentSizeBoost + item.effect.sizeBoost);
            this.stateManager.setState('player.baseCurrencyValue', currentCurrencyBoost + item.effect.currencyBoost);
            this.eventBus.emit('boost:add', { type: 'multiplier', multiplier: item.effect.multiplier, duration: item.effect.duration });
            break;
            
          case 'instant_size':
            this.stateManager.setState('player.size', state.player.size + item.effect.value);
            break;
            
          case 'instant_currency':
            this.stateManager.setState('player.currency', state.player.currency + item.effect.value);
            break;
        }
      }

      getTimeUntilNextUpdate() {
        const state = this.stateManager.getState();
        const lastUpdate = state.lastShopUpdate;
        if (!lastUpdate) return 0;
        const elapsed = Date.now() - lastUpdate;
        return Math.max(0, this.SHOP_UPDATE_INTERVAL - elapsed);
      }

      getCurrentItems() {
        return this.stateManager.get('shopItems') || [];
      }
    }

    /**
     * CaseManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ–π—Å–∞–º–∏
     */
    class CaseManager {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        
        this.rewardTypes = {
          BOOST: { weight: 30, duration: [60, 300], multiplier: [1.5, 3.0] },
          SIZE_BONUS: { weight: 25, amount: [10, 100] },
          ANTI_BOOST: { weight: 20, duration: [30, 120] },
          SIZE_PENALTY: { weight: 15, percent: [5, 20] },
          CURRENCY_BONUS: { weight: 10, amount: [50, 500] }
        };
        
        this.totalWeight = Object.values(this.rewardTypes).reduce((sum, type) => sum + type.weight, 0);
      }

      openCase() {
        const reward = this.generateReward();
        this.applyReward(reward);
        
        const state = this.stateManager.getState();
        const currentCases = state.statistics.casesOpened || 0;
        this.stateManager.setState('statistics.casesOpened', currentCases + 1);
        
        this.eventBus.emit('case:opened', { reward });
        this.eventBus.emit('checkAchievements');
        
        return reward;
      }

      generateReward() {
        let random = Math.random() * this.totalWeight;
        let selectedType = null;
        
        for (const [type, config] of Object.entries(this.rewardTypes)) {
          random -= config.weight;
          if (random <= 0) {
            selectedType = type;
            break;
          }
        }
        
        switch (selectedType) {
          case 'BOOST': {
            const config = this.rewardTypes.BOOST;
            const duration = this.randomInRange(config.duration[0], config.duration[1]);
            const multiplier = this.randomFloatInRange(config.multiplier[0], config.multiplier[1]);
            return { type: 'BOOST', name: '‚ö° –í—Ä–µ–º–µ–Ω–Ω—ã–π –±—É—Å—Ç', description: `–ú–Ω–æ–∂–∏—Ç–µ–ª—å x${multiplier.toFixed(1)} –Ω–∞ ${this.formatDuration(duration)}`, effect: { multiplier, duration } };
          }
          
          case 'SIZE_BONUS': {
            const config = this.rewardTypes.SIZE_BONUS;
            const amount = this.randomInRange(config.amount[0], config.amount[1]);
            return { type: 'SIZE_BONUS', name: 'üìà –ë–æ–Ω—É—Å —Ä–∞–∑–º–µ—Ä–∞', description: `–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +${amount} –∫ —Ä–∞–∑–º–µ—Ä—É`, effect: { amount } };
          }
          
          case 'ANTI_BOOST': {
            const config = this.rewardTypes.ANTI_BOOST;
            const duration = this.randomInRange(config.duration[0], config.duration[1]);
            const antiBoostTypes = ['Click Blocker', 'Currency Drain', 'Multiplier Reducer'];
            const antiBoostType = antiBoostTypes[Math.floor(Math.random() * antiBoostTypes.length)];
            return { type: 'ANTI_BOOST', name: '‚ö†Ô∏è –ê–Ω—Ç–∏–±—É—Å—Ç', description: `${this.getAntiBoostDescription(antiBoostType)} –Ω–∞ ${this.formatDuration(duration)}`, effect: { antiBoostType, duration } };
          }
          
          case 'SIZE_PENALTY': {
            const config = this.rewardTypes.SIZE_PENALTY;
            const percent = this.randomInRange(config.percent[0], config.percent[1]);
            return { type: 'SIZE_PENALTY', name: 'üìâ –®—Ç—Ä–∞—Ñ —Ä–∞–∑–º–µ—Ä–∞', description: `–£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ ${percent}%`, effect: { percent } };
          }
          
          case 'CURRENCY_BONUS': {
            const config = this.rewardTypes.CURRENCY_BONUS;
            const amount = this.randomInRange(config.amount[0], config.amount[1]);
            return { type: 'CURRENCY_BONUS', name: 'üí∞ –ë–æ–Ω—É—Å –≤–∞–ª—é—Ç—ã', description: `–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +${amount} –≤–∞–ª—é—Ç—ã`, effect: { amount } };
          }
          
          default:
            return { type: 'SIZE_BONUS', name: 'üìà –ë–æ–Ω—É—Å —Ä–∞–∑–º–µ—Ä–∞', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +50 –∫ —Ä–∞–∑–º–µ—Ä—É', effect: { amount: 50 } };
        }
      }

      applyReward(reward) {
        const state = this.stateManager.getState();
        
        switch (reward.type) {
          case 'BOOST':
            this.eventBus.emit('boost:add', { type: 'multiplier', multiplier: reward.effect.multiplier, duration: reward.effect.duration });
            break;
          
          case 'SIZE_BONUS':
            this.stateManager.setState('player.size', state.player.size + reward.effect.amount);
            break;
          
          case 'ANTI_BOOST':
            this.eventBus.emit('antiboost:add', { type: reward.effect.antiBoostType, duration: reward.effect.duration });
            break;
          
          case 'SIZE_PENALTY':
            const penalty = Math.floor(state.player.size * reward.effect.percent / 100);
            const newSize = Math.max(0, state.player.size - penalty);
            this.stateManager.setState('player.size', newSize);
            break;
          
          case 'CURRENCY_BONUS':
            this.stateManager.setState('player.currency', state.player.currency + reward.effect.amount);
            break;
        }
      }

      getAntiBoostDescription(type) {
        switch (type) {
          case 'Click Blocker': return '–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–ª–∏–∫–æ–≤';
          case 'Currency Drain': return '–£—Ç–µ—á–∫–∞ –≤–∞–ª—é—Ç—ã';
          case 'Multiplier Reducer': return '–°–Ω–∏–∂–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è';
          default: return '–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç';
        }
      }

      randomInRange(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      randomFloatInRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (minutes > 0 && secs > 0) return `${minutes}–º ${secs}—Å`;
        if (minutes > 0) return `${minutes}–º`;
        return `${secs}—Å`;
      }
    }

    /**
     * AchievementManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏
     */
    class AchievementManager {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.achievements = this.initializeAchievements();
        
        this.eventBus.on('checkAchievements', () => {
          this.checkAchievements();
        });
      }

      initializeAchievements() {
        return [
          // Size Milestones (7)
          { id: 'size_100', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 100', category: 'size', icon: 'üå±', condition: (state) => state.player.size >= 100, unlocked: false, progress: 0 },
          { id: 'size_500', name: '–†–∞—Å—Ç—É—â–∏–π', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 500', category: 'size', icon: 'üåø', condition: (state) => state.player.size >= 500, unlocked: false, progress: 0 },
          { id: 'size_1000', name: '–¢—ã—Å—è—á–Ω–∏–∫', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 1000', category: 'size', icon: 'üå≥', condition: (state) => state.player.size >= 1000, unlocked: false, progress: 0 },
          { id: 'size_5000', name: '–ì–∏–≥–∞–Ω—Ç', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 5000', category: 'size', icon: 'üèîÔ∏è', condition: (state) => state.player.size >= 5000, unlocked: false, progress: 0 },
          { id: 'size_10000', name: '–ö–æ–ª–æ—Å—Å', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 10000', category: 'size', icon: 'üóª', condition: (state) => state.player.size >= 10000, unlocked: false, progress: 0 },
          { id: 'size_50000', name: '–¢–∏—Ç–∞–Ω', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 50000', category: 'size', icon: 'üåã', condition: (state) => state.player.size >= 50000, unlocked: false, progress: 0 },
          { id: 'size_100000', name: '–õ–µ–≥–µ–Ω–¥–∞', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∞ 100000', category: 'size', icon: 'üëë', condition: (state) => state.player.size >= 100000, unlocked: false, progress: 0 },
          
          // Click Milestones (7)
          { id: 'clicks_100', name: '–ö–ª–∏–∫–µ—Ä-–Ω–æ–≤–∏—á–æ–∫', description: '–°–¥–µ–ª–∞–π—Ç–µ 100 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: 'üëÜ', condition: (state) => state.player.totalClicks >= 100, unlocked: false, progress: 0 },
          { id: 'clicks_500', name: '–ê–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∏–∫–µ—Ä', description: '–°–¥–µ–ª–∞–π—Ç–µ 500 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: '‚úåÔ∏è', condition: (state) => state.player.totalClicks >= 500, unlocked: false, progress: 0 },
          { id: 'clicks_1000', name: '–ú–∞—Å—Ç–µ—Ä –∫–ª–∏–∫–æ–≤', description: '–°–¥–µ–ª–∞–π—Ç–µ 1000 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: 'üëè', condition: (state) => state.player.totalClicks >= 1000, unlocked: false, progress: 0 },
          { id: 'clicks_5000', name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª', description: '–°–¥–µ–ª–∞–π—Ç–µ 5000 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: 'üôå', condition: (state) => state.player.totalClicks >= 5000, unlocked: false, progress: 0 },
          { id: 'clicks_10000', name: '–≠–∫—Å–ø–µ—Ä—Ç –∫–ª–∏–∫–æ–≤', description: '–°–¥–µ–ª–∞–π—Ç–µ 10000 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: 'üí™', condition: (state) => state.player.totalClicks >= 10000, unlocked: false, progress: 0 },
          { id: 'clicks_50000', name: '–ö–ª–∏–∫–µ—Ä-–±–æ–≥', description: '–°–¥–µ–ª–∞–π—Ç–µ 50000 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: 'üî•', condition: (state) => state.player.totalClicks >= 50000, unlocked: false, progress: 0 },
          { id: 'clicks_100000', name: '–ê–±—Å–æ–ª—é—Ç–Ω—ã–π —á–µ–º–ø–∏–æ–Ω', description: '–°–¥–µ–ª–∞–π—Ç–µ 100000 –∫–ª–∏–∫–æ–≤', category: 'clicks', icon: '‚ö°', condition: (state) => state.player.totalClicks >= 100000, unlocked: false, progress: 0 },
          
          // Shop Purchases (5)
          { id: 'shop_5', name: '–ü–µ—Ä–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ 5 –ø–æ–∫—É–ø–æ–∫', category: 'shop', icon: 'üõçÔ∏è', condition: (state) => (state.statistics.itemsPurchased || 0) >= 5, unlocked: false, progress: 0 },
          { id: 'shop_10', name: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ 10 –ø–æ–∫—É–ø–æ–∫', category: 'shop', icon: 'üõí', condition: (state) => (state.statistics.itemsPurchased || 0) >= 10, unlocked: false, progress: 0 },
          { id: 'shop_25', name: '–®–æ–ø–æ–≥–æ–ª–∏–∫', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ 25 –ø–æ–∫—É–ø–æ–∫', category: 'shop', icon: 'üí≥', condition: (state) => (state.statistics.itemsPurchased || 0) >= 25, unlocked: false, progress: 0 },
          { id: 'shop_50', name: 'VIP –ø–æ–∫—É–ø–∞—Ç–µ–ª—å', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ 50 –ø–æ–∫—É–ø–æ–∫', category: 'shop', icon: 'üíé', condition: (state) => (state.statistics.itemsPurchased || 0) >= 50, unlocked: false, progress: 0 },
          { id: 'shop_100', name: '–ú–∞–≥–Ω–∞—Ç –ø–æ–∫—É–ø–æ–∫', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ 100 –ø–æ–∫—É–ø–æ–∫', category: 'shop', icon: 'üëë', condition: (state) => (state.statistics.itemsPurchased || 0) >= 100, unlocked: false, progress: 0 },
          
          // Cases Opened (5)
          { id: 'cases_5', name: '–í–µ–∑—É–Ω—á–∏–∫', description: '–û—Ç–∫—Ä–æ–π—Ç–µ 5 –∫–µ–π—Å–æ–≤', category: 'cases', icon: 'üéÅ', condition: (state) => (state.statistics.casesOpened || 0) >= 5, unlocked: false, progress: 0 },
          { id: 'cases_10', name: '–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏', description: '–û—Ç–∫—Ä–æ–π—Ç–µ 10 –∫–µ–π—Å–æ–≤', category: 'cases', icon: 'üì¶', condition: (state) => (state.statistics.casesOpened || 0) >= 10, unlocked: false, progress: 0 },
          { id: 'cases_25', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', description: '–û—Ç–∫—Ä–æ–π—Ç–µ 25 –∫–µ–π—Å–æ–≤', category: 'cases', icon: 'üóÉÔ∏è', condition: (state) => (state.statistics.casesOpened || 0) >= 25, unlocked: false, progress: 0 },
          { id: 'cases_50', name: '–ú–∞—Å—Ç–µ—Ä –∫–µ–π—Å–æ–≤', description: '–û—Ç–∫—Ä–æ–π—Ç–µ 50 –∫–µ–π—Å–æ–≤', category: 'cases', icon: 'üé∞', condition: (state) => (state.statistics.casesOpened || 0) >= 50, unlocked: false, progress: 0 },
          { id: 'cases_100', name: '–ö–æ—Ä–æ–ª—å —É–¥–∞—á–∏', description: '–û—Ç–∫—Ä–æ–π—Ç–µ 100 –∫–µ–π—Å–æ–≤', category: 'cases', icon: 'üçÄ', condition: (state) => (state.statistics.casesOpened || 0) >= 100, unlocked: false, progress: 0 },
          
          // Special Achievements (6)
          { id: 'first_purchase', name: '–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞', description: '–°–æ–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω–µ', category: 'special', icon: 'üéâ', condition: (state) => (state.statistics.itemsPurchased || 0) >= 1, unlocked: false, progress: 0 },
          { id: 'first_case', name: '–ü–µ—Ä–≤—ã–π –∫–µ–π—Å', description: '–û—Ç–∫—Ä–æ–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫–µ–π—Å', category: 'special', icon: 'üéä', condition: (state) => (state.statistics.casesOpened || 0) >= 1, unlocked: false, progress: 0 },
          { id: 'rich_player', name: '–ë–æ–≥–∞—á', description: '–ù–∞–∫–æ–ø–∏—Ç–µ 10000 –≤–∞–ª—é—Ç—ã', category: 'special', icon: 'üí∞', condition: (state) => state.player.currency >= 10000, unlocked: false, progress: 0 },
          { id: 'active_boosts', name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π', description: '–ò–º–µ–π—Ç–µ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ', category: 'special', icon: '‚ö°', condition: (state) => (state.boosts || []).filter(b => b.endTime > Date.now()).length >= 3, unlocked: false, progress: 0 },
          { id: 'survivor', name: '–í—ã–∂–∏–≤—à–∏–π', description: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 10 –∞–Ω—Ç–∏–±—É—Å—Ç–æ–≤', category: 'special', icon: 'üõ°Ô∏è', condition: (state) => (state.statistics.antiBoostsUsed || 0) >= 10, unlocked: false, progress: 0 },
          { id: 'dedicated_player', name: '–ü—Ä–µ–¥–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–∫', description: '–ò–≥—Ä–∞–π—Ç–µ 1 —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)', category: 'special', icon: '‚è∞', condition: (state) => (state.player.playTime || 0) >= 3600, unlocked: false, progress: 0 }
        ];
      }

      checkAchievements() {
        const state = this.stateManager.getState();
        this.achievements.forEach(achievement => {
          if (!achievement.unlocked && achievement.condition(state)) {
            this.unlockAchievement(achievement.id);
          } else if (!achievement.unlocked) {
            achievement.progress = this.getProgress(achievement.id);
          }
        });
      }

      unlockAchievement(achievementId) {
        const achievement = this.achievements.find(a => a.id === achievementId);
        if (!achievement || achievement.unlocked) return;
        
        achievement.unlocked = true;
        achievement.unlockedAt = Date.now();
        achievement.progress = 100;
        
        const state = this.stateManager.getState();
        const unlockedAchievements = state.achievements || [];
        if (!unlockedAchievements.includes(achievementId)) {
          unlockedAchievements.push(achievementId);
          this.stateManager.setState('achievements', unlockedAchievements);
        }
        
        this.eventBus.emit('achievement:unlocked', { achievement });
        this.eventBus.emit('haptic:feedback', { type: 'success' });
      }

      getProgress(achievementId) {
        const achievement = this.achievements.find(a => a.id === achievementId);
        if (!achievement || achievement.unlocked) return 100;
        
        const state = this.stateManager.getState();
        switch (achievement.category) {
          case 'size': {
            const target = this.extractTarget(achievement.id);
            return Math.min(100, (state.player.size / target) * 100);
          }
          case 'clicks': {
            const target = this.extractTarget(achievement.id);
            return Math.min(100, (state.player.totalClicks / target) * 100);
          }
          case 'shop': {
            const target = this.extractTarget(achievement.id);
            const current = state.statistics.itemsPurchased || 0;
            return Math.min(100, (current / target) * 100);
          }
          case 'cases': {
            const target = this.extractTarget(achievement.id);
            const current = state.statistics.casesOpened || 0;
            return Math.min(100, (current / target) * 100);
          }
          case 'special':
            return achievement.condition(state) ? 100 : 0;
          default:
            return 0;
        }
      }

      extractTarget(achievementId) {
        const match = achievementId.match(/\d+/);
        return match ? parseInt(match[0]) : 0;
      }

      getAllAchievements() {
        return this.achievements;
      }

      getAchievementsByCategory(category) {
        return this.achievements.filter(a => a.category === category);
      }

      getUnlockedCount() {
        return this.achievements.filter(a => a.unlocked).length;
      }

      getTotalCount() {
        return this.achievements.length;
      }

      loadUnlockedAchievements() {
        const state = this.stateManager.getState();
        const unlockedIds = state.achievements || [];
        unlockedIds.forEach(id => {
          const achievement = this.achievements.find(a => a.id === id);
          if (achievement) {
            achievement.unlocked = true;
            achievement.progress = 100;
          }
        });
      }
    }

    /**
     * LeaderboardManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
     */
    class LeaderboardManager {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.STORAGE_KEY = 'telegram_clicker_leaderboard';
        this.leaderboard = this.loadLeaderboard();
        
        this.stateManager.subscribe('player.size', () => {
          this.updateCurrentPlayerScore();
        });
      }

      updatePlayerScore(playerId, playerName, size) {
        const existingIndex = this.leaderboard.findIndex(entry => entry.playerId === playerId);
        
        if (existingIndex !== -1) {
          this.leaderboard[existingIndex].size = size;
          this.leaderboard[existingIndex].playerName = playerName;
          this.leaderboard[existingIndex].updatedAt = Date.now();
        } else {
          this.leaderboard.push({ playerId, playerName, size, updatedAt: Date.now() });
        }
        
        this.sortLeaderboard();
        this.saveLeaderboard();
        this.eventBus.emit('leaderboard:updated', { playerId, rank: this.getPlayerRank(playerId) });
      }

      updateCurrentPlayerScore() {
        const state = this.stateManager.getState();
        const player = state.player;
        if (player.id && player.name) {
          this.updatePlayerScore(player.id, player.name, player.size);
        }
      }

      getLeaderboard(limit = 100) {
        return this.leaderboard.slice(0, limit).map((entry, index) => ({ ...entry, rank: index + 1 }));
      }

      getPlayerRank(playerId) {
        const index = this.leaderboard.findIndex(entry => entry.playerId === playerId);
        return index !== -1 ? index + 1 : null;
      }

      getPlayerEntry(playerId) {
        const index = this.leaderboard.findIndex(entry => entry.playerId === playerId);
        if (index === -1) return null;
        return { ...this.leaderboard[index], rank: index + 1 };
      }

      sortLeaderboard() {
        this.leaderboard.sort((a, b) => {
          if (b.size !== a.size) return b.size - a.size;
          return a.updatedAt - b.updatedAt;
        });
      }

      loadLeaderboard() {
        try {
          const data = localStorage.getItem(this.STORAGE_KEY);
          if (!data) return [];
          const parsed = JSON.parse(data);
          if (!Array.isArray(parsed)) return [];
          const validated = parsed.filter(entry => entry.playerId && entry.playerName && typeof entry.size === 'number' && typeof entry.updatedAt === 'number');
          validated.sort((a, b) => {
            if (b.size !== a.size) return b.size - a.size;
            return a.updatedAt - b.updatedAt;
          });
          return validated;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
          return [];
        }
      }

      saveLeaderboard() {
        try {
          const data = JSON.stringify(this.leaderboard);
          localStorage.setItem(this.STORAGE_KEY, data);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
        }
      }

      getStatistics() {
        if (this.leaderboard.length === 0) {
          return { totalPlayers: 0, averageSize: 0, topSize: 0, medianSize: 0 };
        }
        const sizes = this.leaderboard.map(entry => entry.size);
        const totalSize = sizes.reduce((sum, size) => sum + size, 0);
        const sortedSizes = [...sizes].sort((a, b) => a - b);
        const medianIndex = Math.floor(sortedSizes.length / 2);
        return {
          totalPlayers: this.leaderboard.length,
          averageSize: Math.round(totalSize / this.leaderboard.length),
          topSize: sizes[0] || 0,
          medianSize: sortedSizes[medianIndex] || 0
        };
      }
    }

    /**
     * AnimationController - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ UI
     */
    class AnimationController {
      constructor() {
        this.animations = [];
      }

      animateCaseOpening(element, reward, callback) {
        const animationContainer = document.createElement('div');
        animationContainer.className = 'case-opening-animation';
        animationContainer.innerHTML = `
          <div class="case-opening-overlay"></div>
          <div class="case-opening-content">
            <div class="case-box">üì¶</div>
            <div class="case-result" style="display: none;">
              <div class="result-name">${reward.name}</div>
              <div class="result-description">${reward.description}</div>
            </div>
          </div>
        `;
        
        element.appendChild(animationContainer);
        
        setTimeout(() => {
          const resultEl = animationContainer.querySelector('.case-result');
          if (resultEl) {
            resultEl.style.display = 'block';
            resultEl.style.opacity = '0';
            setTimeout(() => {
              resultEl.style.transition = 'opacity 0.3s';
              resultEl.style.opacity = '1';
            }, 50);
          }
        }, 1000);
        
        setTimeout(() => {
          animationContainer.style.transition = 'opacity 0.3s';
          animationContainer.style.opacity = '0';
          setTimeout(() => {
            animationContainer.remove();
            if (callback) callback();
          }, 300);
        }, 3000);
      }

      animateAchievement(achievement) {
        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
          <div class="achievement-icon">${achievement.icon || 'üèÜ'}</div>
          <div class="achievement-content">
            <div class="achievement-title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!</div>
            <div class="achievement-name">${achievement.name}</div>
            <div class="achievement-description">${achievement.description}</div>
          </div>
        `;
        
        document.body.appendChild(notification);
        notification.style.top = '-200px';
        notification.style.opacity = '0';
        
        setTimeout(() => {
          notification.style.transition = 'all 0.5s ease-out';
          notification.style.top = '20px';
          notification.style.opacity = '1';
        }, 100);
        
        setTimeout(() => {
          notification.style.transition = 'all 0.5s ease-in';
          notification.style.top = '-200px';
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 500);
        }, 3000);
      }
    }

    // ============================================================================
    // Application
    // ============================================================================

    /**
     * –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     */
    class App {
      constructor() {
        this.stateManager = new StateManager();
        this.eventBus = new EventBus();
        this.storageManager = new StorageManager(this.stateManager);
        this.telegramBridge = new TelegramBridge();
        this.gameEngine = new GameEngine(this.stateManager, this.eventBus);
        this.particleSystem = new ParticleSystem();
        this.clickerView = null;
        this.initialized = false;
        this.lastUpdateTime = Date.now();
        this.canvas = null;
        this.ctx = null;
      }

      async init() {
        try {
          this.canvas = document.getElementById('particle-canvas');
          this.ctx = this.canvas.getContext('2d');
          this.resizeCanvas();
          window.addEventListener('resize', () => this.resizeCanvas());

          this.eventBus.on('click', (data) => {
            this.particleSystem.emit(data.x, data.y, 8, {
              color: '#FFD700',
              size: 6,
              velocity: 3,
              lifetime: 800,
              gravity: 0.3
            });
          });

          let userData = null;
          try {
            userData = this.telegramBridge.init();
            console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', userData);
            
            if (userData) {
              this.stateManager.update('player', {
                id: userData.id,
                name: userData.first_name + (userData.last_name ? ' ' + userData.last_name : ''),
                avatar: userData.photo_url
              });
            }
          } catch (error) {
            console.warn('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
          }

          const savedState = this.storageManager.load();
          if (savedState) {
            const playerData = this.stateManager.get('player');
            this.stateManager.loadState(savedState);
            if (userData) {
              this.stateManager.update('player', {
                id: playerData.id,
                name: playerData.name,
                avatar: playerData.avatar
              });
            }
            console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ LocalStorage');
          } else {
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
          }

          this.stateManager.subscribe('player', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('boosts', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('antiBoosts', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('achievements', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('shopItems', () => {
            this.storageManager.save();
          });

          this.initialized = true;
          this.render();
          this.startGameLoop();
          
          console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
          this.showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', error.message);
        }
      }

      resizeCanvas() {
        if (this.canvas) {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }
      }

      startGameLoop() {
        const gameLoop = () => {
          const currentTime = Date.now();
          const deltaTime = currentTime - this.lastUpdateTime;
          this.lastUpdateTime = currentTime;
          
          this.gameEngine.update(deltaTime);
          this.particleSystem.update(deltaTime);
          
          if (this.ctx) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.particleSystem.render(this.ctx);
          }
          
          requestAnimationFrame(gameLoop);
        };
        
        requestAnimationFrame(gameLoop);
      }

      render() {
        const app = document.getElementById('app');
        const state = this.stateManager.getState();
        
        app.innerHTML = `
          <nav class="nav">
            <button class="nav-button active" data-view="clicker">
              <span class="nav-icon">üéÆ</span>
              <span class="nav-label">–ò–≥—Ä–∞</span>
            </button>
            <button class="nav-button" data-view="shop">
              <span class="nav-icon">üõí</span>
              <span class="nav-label">–ú–∞–≥–∞–∑–∏–Ω</span>
            </button>
            <button class="nav-button" data-view="profile">
              <span class="nav-icon">üë§</span>
              <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
            <button class="nav-button" data-view="leaderboard">
              <span class="nav-icon">üèÜ</span>
              <span class="nav-label">–†–µ–π—Ç–∏–Ω–≥</span>
            </button>
            <button class="nav-button" data-view="achievements">
              <span class="nav-icon">‚≠ê</span>
              <span class="nav-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span>
            </button>
          </nav>

          <div id="clicker-view" class="view active">
            <div class="card">
              <!-- ClickerView will render here -->
            </div>
          </div>

          <div id="shop-view" class="view">
            <div class="card">
              <h2>üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
              <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–æ–≤–∞—Ä—ã...</p>
            </div>
          </div>

          <div id="profile-view" class="view">
            <div class="card">
              <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
              <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞...</p>
            </div>
          </div>

          <div id="leaderboard-view" class="view">
            <div class="card">
              <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥</h2>
              <p>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤...</p>
            </div>
          </div>

          <div id="achievements-view" class="view">
            <div class="card">
              <h2>‚≠ê –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
              <p>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π...</p>
            </div>
          </div>
        `;

        this.setupNavigation();
        
        this.clickerView = new ClickerView(this.stateManager, this.eventBus, this.gameEngine);
        const clickerContainer = document.querySelector('#clicker-view .card');
        if (clickerContainer) {
          this.clickerView.render(clickerContainer);
        }
        
        this.eventBus.on('click', () => {
          this.telegramBridge.hapticFeedback('light');
        });
      }

      setupNavigation() {
        const navButtons = document.querySelectorAll('.nav-button');
        navButtons.forEach(button => {
          button.addEventListener('click', () => {
            const viewName = button.dataset.view;
            this.switchView(viewName);
          });
        });
      }

      switchView(viewName) {
        document.querySelectorAll('.nav-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });

        const button = document.querySelector(`[data-view="${viewName}"]`);
        const view = document.getElementById(`${viewName}-view`);
        
        if (button) button.classList.add('active');
        if (view) view.classList.add('active');
      }

      showError(title, message) {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="error">
            <div class="error-title">${title}</div>
            <div class="error-message">${message}</div>
            <button class="button" onclick="location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        `;
      }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new App();
      window.app.init();
    });
  </script>
</body>
</html>
–ø
