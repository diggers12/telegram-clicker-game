<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Telegram Clicker Game</title>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      overflow-x: hidden;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* Container */
    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navigation */
    .nav {
      display: flex;
      justify-content: space-around;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 10px;
      margin-bottom: 20px;
      position: sticky;
      top: 10px;
      z-index: 100;
    }

    .nav-button {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 15px;
      transition: all 0.3s ease;
      min-width: 44px;
      min-height: 44px;
    }

    .nav-button.active {
      background: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Views */
    .view {
      display: none;
      flex: 1;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Card style */
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* Button styles */
    .button {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 15px;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 44px;
      min-height: 44px;
    }

    .button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .button:active {
      transform: scale(0.95);
    }

    /* Responsive */
    @media (max-width: 768px) {
      #app {
        padding: 10px;
      }

      .nav-button {
        font-size: 12px;
        padding: 10px 8px;
      }
    }

    @media (max-width: 480px) {
      .nav-button {
        font-size: 11px;
        padding: 8px 6px;
      }
    }

    /* Loading state */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-size: 24px;
      font-weight: 600;
    }

    /* Error state */
    .error {
      background: rgba(255, 59, 48, 0.2);
      border: 2px solid rgba(255, 59, 48, 0.5);
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      text-align: center;
    }

    .error-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .error-message {
      font-size: 16px;
      opacity: 0.9;
    }

    /* Particle canvas */
    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* ClickerView styles */
    .clicker-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .player-info {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
    }

    .player-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin-bottom: 10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .player-name {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #FFD700;
    }

    .boosts-container {
      min-height: 40px;
    }

    .boosts-list {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 15px;
      padding: 15px;
    }

    .boosts-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .boost-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .boost-item:last-child {
      margin-bottom: 0;
    }

    .boost-icon {
      font-size: 20px;
    }

    .boost-multiplier {
      font-size: 18px;
      font-weight: 700;
      color: #FFD700;
      flex: 1;
    }

    .boost-timer {
      font-size: 14px;
      opacity: 0.8;
    }

    .click-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .click-button {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      border: 5px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .click-button:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    .click-button:active {
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .click-emoji {
      display: block;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .click-hint {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.7;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px;
    }

    .progress-label {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .antiboosts-warning {
      background: rgba(255, 59, 48, 0.2);
      border: 2px solid rgba(255, 59, 48, 0.5);
      border-radius: 15px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .warning-icon {
      font-size: 24px;
    }

    .warning-text {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <canvas id="particle-canvas"></canvas>
  <div id="app">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    'use strict';

    // ============================================================================
    // Core Modules
    // ============================================================================

    /**
     * StateManager - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
     * –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
     */
    class StateManager {
      constructor() {
        this.state = {
          player: {
            id: null,
            name: null,
            avatar: null,
            size: 0,
            currency: 0,
            totalClicks: 0,
            playTime: 0,
            startTime: Date.now(),
            baseClickValue: 1,
            baseCurrencyValue: 1
          },
          boosts: [],
          antiBoosts: [],
          achievements: [],
          shopItems: [],
          lastShopUpdate: null,
          statistics: {
            casesOpened: 0,
            itemsPurchased: 0
          }
        };
        this.listeners = new Map();
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
       * @returns {Object} –ö–æ–ø–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
       */
      getState() {
        return JSON.parse(JSON.stringify(this.state));
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏
       * @param {string} path - –ü—É—Ç—å –∫ –∑–Ω–∞—á–µ–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'player.size')
       * @returns {*} –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏
       */
      get(path) {
        const keys = path.split('.');
        let value = this.state;
        for (const key of keys) {
          if (value === null || value === undefined) return undefined;
          value = value[key];
        }
        return value;
      }

      /**
       * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏
       * @param {string} path - –ü—É—Ç—å –∫ –∑–Ω–∞—á–µ–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'player.size')
       * @param {*} value - –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
       */
      setState(path, value) {
        const keys = path.split('.');
        const lastKey = keys.pop();
        let target = this.state;
        
        for (const key of keys) {
          if (!(key in target)) {
            target[key] = {};
          }
          target = target[key];
        }
        
        target[lastKey] = value;
        this.notify(path, value);
      }

      /**
       * –û–±–Ω–æ–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
       * @param {string} path - –ü—É—Ç—å –∫ –æ–±—ä–µ–∫—Ç—É
       * @param {Object} updates - –û–±—ä–µ–∫—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
       */
      update(path, updates) {
        const current = this.get(path);
        if (typeof current === 'object' && current !== null) {
          const updated = { ...current, ...updates };
          this.setState(path, updated);
        }
      }

      /**
       * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
       * @param {string} path - –ü—É—Ç—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
       * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
       * @returns {Function} –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏
       */
      subscribe(path, callback) {
        if (!this.listeners.has(path)) {
          this.listeners.set(path, []);
        }
        this.listeners.get(path).push(callback);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
        return () => {
          const callbacks = this.listeners.get(path);
          const index = callbacks.indexOf(callback);
          if (index > -1) {
            callbacks.splice(index, 1);
          }
        };
      }

      /**
       * –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
       * @param {string} path - –ü—É—Ç—å, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω–∏–ª—Å—è
       * @param {*} value - –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
       */
      notify(path, value) {
        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–æ—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        if (this.listeners.has(path)) {
          this.listeners.get(path).forEach(callback => callback(value, path));
        }
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø—É—Ç–µ–π
        const parts = path.split('.');
        for (let i = parts.length - 1; i > 0; i--) {
          const parentPath = parts.slice(0, i).join('.');
          if (this.listeners.has(parentPath)) {
            const parentValue = this.get(parentPath);
            this.listeners.get(parentPath).forEach(callback => callback(parentValue, parentPath));
          }
        }
      }

      /**
       * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –æ–±—ä–µ–∫—Ç–∞
       * @param {Object} newState - –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
       */
      loadState(newState) {
        this.state = newState;
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ –ø–æ–ª–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        this.listeners.forEach((callbacks, path) => {
          const value = this.get(path);
          callbacks.forEach(callback => callback(value, path));
        });
      }
    }

    /**
     * EventBus - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
     * –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Observer –¥–ª—è —Å–ª–∞–±–æ—Å–≤—è–∑–∞–Ω–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
     */
    class EventBus {
      constructor() {
        this.events = new Map();
      }

      /**
       * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
       * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
       * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
       * @returns {Function} –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏
       */
      on(event, callback) {
        if (!this.events.has(event)) {
          this.events.set(event, []);
        }
        this.events.get(event).push(callback);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
        return () => this.off(event, callback);
      }

      /**
       * –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Å–æ–±—ã—Ç–∏—è
       * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
       * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
       */
      off(event, callback) {
        if (!this.events.has(event)) return;
        
        const callbacks = this.events.get(event);
        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
        }
      }

      /**
       * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
       * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
       * @param {*} data - –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
       */
      emit(event, data) {
        if (!this.events.has(event)) return;
        
        this.events.get(event).forEach(callback => {
          try {
            callback(data);
          } catch (error) {
            console.error(`Error in event handler for "${event}":`, error);
          }
        });
      }

      /**
       * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
       * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
       * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
       */
      once(event, callback) {
        const onceCallback = (data) => {
          callback(data);
          this.off(event, onceCallback);
        };
        this.on(event, onceCallback);
      }

      /**
       * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
       * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
       */
      clear(event) {
        if (event) {
          this.events.delete(event);
        } else {
          this.events.clear();
        }
      }
    }

    /**
     * StorageManager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
     * –†–∞–±–æ—Ç–∞–µ—Ç —Å LocalStorage –∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç debouncing –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
     */
    class StorageManager {
      constructor(stateManager) {
        this.stateManager = stateManager;
        this.STORAGE_KEY = 'telegram_clicker_game';
        this.SAVE_DEBOUNCE_MS = 1000;
        this.saveTimeout = null;
        this.isAvailable = this.checkAvailability();
      }

      /**
       * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å LocalStorage
       * @returns {boolean} true –µ—Å–ª–∏ LocalStorage –¥–æ—Å—Ç—É–ø–µ–Ω
       */
      checkAvailability() {
        try {
          const test = '__storage_test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
          return false;
        }
      }

      /**
       * –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ LocalStorage
       * @returns {Object|null} –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ null
       */
      load() {
        if (!this.isAvailable) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞');
          return null;
        }

        try {
          const data = localStorage.getItem(this.STORAGE_KEY);
          if (!data) {
            return null;
          }

          const parsed = JSON.parse(data);
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          if (!this.validateState(parsed)) {
            console.warn('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            return null;
          }

          return parsed;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
          return null;
        }
      }

      /**
       * –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
       * @param {Object} state - –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
       * @returns {boolean} true –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ
       */
      validateState(state) {
        if (!state || typeof state !== 'object') return false;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π player
        if (!state.player || typeof state.player !== 'object') return false;
        if (typeof state.player.size !== 'number' || state.player.size < 0) return false;
        if (typeof state.player.currency !== 'number' || state.player.currency < 0) return false;
        if (typeof state.player.totalClicks !== 'number' || state.player.totalClicks < 0) return false;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤
        if (!Array.isArray(state.boosts)) return false;
        if (!Array.isArray(state.antiBoosts)) return false;
        if (!Array.isArray(state.achievements)) return false;
        if (!Array.isArray(state.shopItems)) return false;
        
        return true;
      }

      /**
       * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å debouncing
       */
      save() {
        if (!this.isAvailable) {
          console.warn('LocalStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ');
          return;
        }

        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (this.saveTimeout) {
          clearTimeout(this.saveTimeout);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
        this.saveTimeout = setTimeout(() => {
          this.saveImmediate();
        }, this.SAVE_DEBOUNCE_MS);
      }

      /**
       * –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ debouncing
       */
      saveImmediate() {
        if (!this.isAvailable) return;

        try {
          const state = this.stateManager.getState();
          const serialized = JSON.stringify(state);
          localStorage.setItem(this.STORAGE_KEY, serialized);
        } catch (error) {
          if (error.name === 'QuotaExceededError') {
            console.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ LocalStorage');
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          } else {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
          }
        }
      }

      /**
       * –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
       */
      clear() {
        if (!this.isAvailable) return;

        try {
          localStorage.removeItem(this.STORAGE_KEY);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
      }
    }

    /**
     * TelegramBridge - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp API
     * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
     */
    class TelegramBridge {
      constructor() {
        this.tg = window.Telegram?.WebApp;
        this.isAvailable = !!this.tg;
      }

      /**
       * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Telegram WebApp
       * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–µ–º—É, —Ü–≤–µ—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       * @returns {Object|null} –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ
       * @throws {Error} –ï—Å–ª–∏ Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
       */
      init() {
        if (!this.isAvailable) {
          throw new Error('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram.');
        }

        try {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp
          this.tg.ready();
          
          // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–º—É
          this.tg.expand();
          
          // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const userData = this.getUserData();
          
          if (!userData) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram');
          }

          return userData;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
          throw error;
        }
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
       * @returns {Object|null} –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: { id, first_name, last_name, username, photo_url }
       */
      getUserData() {
        if (!this.isAvailable) {
          return null;
        }

        try {
          const user = this.tg.initDataUnsafe?.user;
          
          if (!user) {
            return null;
          }

          return {
            id: user.id?.toString() || null,
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: user.username || '',
            photo_url: user.photo_url || ''
          };
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          return null;
        }
      }

      /**
       * –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–≥—Ä—ã
       * @param {number} size - –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –∏–≥—Ä–æ–∫–∞
       * @param {number} rank - –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
       * @throws {Error} –ï—Å–ª–∏ Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
       */
      shareScore(size, rank) {
        if (!this.isAvailable) {
          throw new Error('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        try {
          const message = `üéÆ –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram Clicker Game!\n\n` +
                         `üìä –†–∞–∑–º–µ—Ä: ${size}\n` +
                         `üèÜ –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: ${rank}\n\n` +
                         `–ü–æ–ø—Ä–æ–±—É–π –æ–±–æ–≥–Ω–∞—Ç—å –º–µ–Ω—è!`;
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
          this.tg.switchInlineQuery(message, ['users', 'groups']);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
          throw error;
        }
      }

      /**
       * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
       * @param {string} color - –¶–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ hex (#RRGGBB)
       */
      setHeaderColor(color) {
        if (!this.isAvailable) {
          return;
        }

        try {
          this.tg.setHeaderColor(color);
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞:', error);
        }
      }

      /**
       * –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Telegram
       * @param {string} message - –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
       */
      showAlert(message) {
        if (!this.isAvailable) {
          // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π alert
          alert(message);
          return;
        }

        try {
          this.tg.showAlert(message);
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', error);
          alert(message);
        }
      }

      /**
       * –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö (haptic feedback)
       * @param {string} type - –¢–∏–ø –≤–∏–±—Ä–∞—Ü–∏–∏: 'light', 'medium', 'heavy', 'rigid', 'soft', 'error', 'success', 'warning'
       */
      hapticFeedback(type = 'light') {
        if (!this.isAvailable) {
          return;
        }

        try {
          const validTypes = ['light', 'medium', 'heavy', 'rigid', 'soft'];
          const notificationTypes = ['error', 'success', 'warning'];
          
          if (validTypes.includes(type)) {
            this.tg.HapticFeedback?.impactOccurred(type);
          } else if (notificationTypes.includes(type)) {
            this.tg.HapticFeedback?.notificationOccurred(type);
          }
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å haptic feedback:', error);
        }
      }
    }

    /**
     * GameEngine - –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
     * –£–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Ö–∞–Ω–∏–∫–æ–π –∫–ª–∏–∫–æ–≤, –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–∞–π–º–µ—Ä–æ–≤
     */
    class GameEngine {
      constructor(stateManager, eventBus) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.baseClickValue = 1;
        this.baseCurrencyValue = 1;
      }

      /**
       * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–∫ –∏–≥—Ä–æ–∫–∞
       * @param {number} x - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X –∫–ª–∏–∫–∞
       * @param {number} y - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y –∫–ª–∏–∫–∞
       */
      handleClick(x, y) {
        // 1. –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –±—É—Å—Ç–æ–≤
        const multiplier = this.calculateMultiplier();
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        const player = this.stateManager.get('player');
        const baseClickValue = player.baseClickValue || this.baseClickValue;
        const baseCurrencyValue = player.baseCurrencyValue || this.baseCurrencyValue;
        
        // 3. –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏—Ä–æ—Å—Ç —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–∏—Ç–µ–ª—è
        const sizeIncrease = baseClickValue * multiplier;
        const currencyIncrease = baseCurrencyValue;
        
        // 4. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏ –≤–∞–ª—é—Ç—É
        const newSize = player.size + sizeIncrease;
        const newCurrency = player.currency + currencyIncrease;
        const newTotalClicks = player.totalClicks + 1;
        
        this.stateManager.setState('player.size', newSize);
        this.stateManager.setState('player.currency', newCurrency);
        this.stateManager.setState('player.totalClicks', newTotalClicks);
        
        // 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        this.eventBus.emit('click', {
          x,
          y,
          sizeIncrease,
          currencyIncrease,
          multiplier
        });
        
        // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        this.eventBus.emit('checkAchievements');
      }

      /**
       * –í—ã—á–∏—Å–ª–∏—Ç—å –æ–±—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤
       * @returns {number} –û–±—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–º–∏–Ω–∏–º—É–º 1.0)
       */
      calculateMultiplier() {
        const boosts = this.stateManager.get('boosts') || [];
        const currentTime = Date.now();
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã (–Ω–µ –∏—Å—Ç–µ–∫—à–∏–µ)
        const activeBoosts = boosts.filter(boost => {
          return boost.endTime > currentTime;
        });
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 1.0
        if (activeBoosts.length === 0) {
          return 1.0;
        }
        
        // –ü–µ—Ä–µ–º–Ω–æ–∂–∞–µ–º –≤—Å–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤
        const totalMultiplier = activeBoosts.reduce((acc, boost) => {
          return acc * (boost.multiplier || 1.0);
        }, 1.0);
        
        return totalMultiplier;
      }

      /**
       * –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã –±—É—Å—Ç–æ–≤ –∏ –∞–Ω—Ç–∏–±—É—Å—Ç–æ–≤
       * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
       * @param {number} deltaTime - –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
       */
      update(deltaTime) {
        const currentTime = Date.now();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±—É—Å—Ç—ã - —É–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ
        const boosts = this.stateManager.get('boosts') || [];
        const activeBoosts = boosts.filter(boost => {
          const isActive = boost.endTime > currentTime;
          
          // –ï—Å–ª–∏ –±—É—Å—Ç –∏—Å—Ç–µ–∫, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
          if (!isActive) {
            this.eventBus.emit('boostExpired', { boost });
          }
          
          return isActive;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
        if (activeBoosts.length !== boosts.length) {
          this.stateManager.setState('boosts', activeBoosts);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω—Ç–∏–±—É—Å—Ç—ã - —É–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ
        const antiBoosts = this.stateManager.get('antiBoosts') || [];
        const activeAntiBoosts = antiBoosts.filter(antiBoost => {
          const isActive = antiBoost.endTime > currentTime;
          
          // –ï—Å–ª–∏ –∞–Ω—Ç–∏–±—É—Å—Ç –∏—Å—Ç–µ–∫, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
          if (!isActive) {
            this.eventBus.emit('antiBoostExpired', { antiBoost });
          }
          
          return isActive;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
        if (activeAntiBoosts.length !== antiBoosts.length) {
          this.stateManager.setState('antiBoosts', activeAntiBoosts);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∏–≥—Ä—ã
        const player = this.stateManager.get('player');
        if (player && player.startTime) {
          const playTime = Math.floor((currentTime - player.startTime) / 1000);
          if (playTime !== player.playTime) {
            this.stateManager.setState('player.playTime', playTime);
          }
        }
      }
    }

    /**
     * ClickerView - –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–≥—Ä–æ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç, —Ä–∞–∑–º–µ—Ä, –≤–∞–ª—é—Ç—É –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏
     */
    class ClickerView {
      constructor(stateManager, eventBus, gameEngine) {
        this.stateManager = stateManager;
        this.eventBus = eventBus;
        this.gameEngine = gameEngine;
        this.container = null;
        
        // –ü–æ—Ä–æ–≥–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        this.visualThresholds = [
          { size: 0, scale: 1.0, emoji: 'üéØ' },
          { size: 100, scale: 1.2, emoji: 'üéÆ' },
          { size: 500, scale: 1.4, emoji: 'üöÄ' },
          { size: 1000, scale: 1.6, emoji: '‚≠ê' },
          { size: 5000, scale: 1.8, emoji: 'üíé' },
          { size: 10000, scale: 2.0, emoji: 'üëë' },
          { size: 50000, scale: 2.2, emoji: 'üî•' },
          { size: 100000, scale: 2.5, emoji: 'üåü' }
        ];
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.stateManager.subscribe('player', () => {
          this.updateVisuals();
        });
      }

      /**
       * –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å view
       * @param {HTMLElement} container - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
       */
      render(container) {
        this.container = container;
        const state = this.stateManager.getState();
        const player = state.player;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
        const visualLevel = this.getVisualLevel(player.size);
        
        container.innerHTML = `
          <div class="clicker-container">
            <div class="player-info">
              ${player.avatar ? `<img src="${player.avatar}" alt="${player.name}" class="player-avatar">` : ''}
              <h2 class="player-name">${player.name || '–ò–≥—Ä–æ–∫'}</h2>
            </div>
            
            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                <div class="stat-value" id="size-display">${this.formatNumber(player.size)}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">–í–∞–ª—é—Ç–∞</div>
                <div class="stat-value" id="currency-display">${this.formatNumber(player.currency)}</div>
              </div>
            </div>
            
            <div class="boosts-container" id="boosts-display">
              ${this.renderBoosts(state.boosts)}
            </div>
            
            <div class="click-area">
              <button id="click-button" class="click-button" style="transform: scale(${visualLevel.scale})">
                <span class="click-emoji">${visualLevel.emoji}</span>
              </button>
              <div class="click-hint">–ù–∞–∂–º–∏ –º–µ–Ω—è!</div>
            </div>
            
            <div class="progress-container">
              <div class="progress-label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: ${this.getProgressToNextLevel(player.size)}%"></div>
              </div>
            </div>
            
            ${state.antiBoosts.length > 0 ? `
              <div class="antiboosts-warning">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-text">–ê–∫—Ç–∏–≤–Ω—ã –∞–Ω—Ç–∏–±—É—Å—Ç—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –≤ –ø—Ä–æ—Ñ–∏–ª–µ.</div>
              </div>
            ` : ''}
          </div>
        `;
        
        this.setupClickHandler();
        this.updateVisuals();
      }

      /**
       * –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
       */
      setupClickHandler() {
        const clickButton = document.getElementById('click-button');
        if (!clickButton) return;
        
        clickButton.addEventListener('click', (event) => {
          this.handleClick(event);
        });
      }

      /**
       * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–∫ –ø–æ –∏–≥—Ä–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
       * @param {MouseEvent} event - –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞
       */
      handleClick(event) {
        const clickButton = event.currentTarget;
        const rect = clickButton.getBoundingClientRect();
        
        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∏
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // –ü–µ—Ä–µ–¥–∞–µ–º –∫–ª–∏–∫ –≤ GameEngine
        this.gameEngine.handleClick(event.clientX, event.clientY);
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
        clickButton.style.transform = `scale(${this.getCurrentScale() * 0.95})`;
        setTimeout(() => {
          clickButton.style.transform = `scale(${this.getCurrentScale()})`;
        }, 100);
      }

      /**
       * –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
       */
      updateVisuals() {
        if (!this.container) return;
        
        const state = this.stateManager.getState();
        const player = state.player;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ –≤–∞–ª—é—Ç—ã
        const sizeDisplay = document.getElementById('size-display');
        const currencyDisplay = document.getElementById('currency-display');
        
        if (sizeDisplay) {
          sizeDisplay.textContent = this.formatNumber(player.size);
        }
        
        if (currencyDisplay) {
          currencyDisplay.textContent = this.formatNumber(player.currency);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∫–Ω–æ–ø–∫–∏
        const clickButton = document.getElementById('click-button');
        const visualLevel = this.getVisualLevel(player.size);
        
        if (clickButton) {
          const emoji = clickButton.querySelector('.click-emoji');
          if (emoji) {
            emoji.textContent = visualLevel.emoji;
          }
          clickButton.style.transform = `scale(${visualLevel.scale})`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) {
          progressFill.style.width = `${this.getProgressToNextLevel(player.size)}%`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É—Å—Ç–æ–≤
        const boostsDisplay = document.getElementById('boosts-display');
        if (boostsDisplay) {
          boostsDisplay.innerHTML = this.renderBoosts(state.boosts);
        }
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
       * @param {number} size - –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
       * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
       */
      getVisualLevel(size) {
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Ä–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É —Ä–∞–∑–º–µ—Ä—É
        for (let i = this.visualThresholds.length - 1; i >= 0; i--) {
          if (size >= this.visualThresholds[i].size) {
            return this.visualThresholds[i];
          }
        }
        return this.visualThresholds[0];
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–± –∫–Ω–æ–ø–∫–∏
       * @returns {number} –ú–∞—Å—à—Ç–∞–±
       */
      getCurrentScale() {
        const player = this.stateManager.get('player');
        const visualLevel = this.getVisualLevel(player.size);
        return visualLevel.scale;
      }

      /**
       * –í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
       * @param {number} size - –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
       * @returns {number} –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (0-100)
       */
      getProgressToNextLevel(size) {
        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Ä–æ–≥–∏
        let currentThreshold = this.visualThresholds[0];
        let nextThreshold = null;
        
        for (let i = 0; i < this.visualThresholds.length; i++) {
          if (size >= this.visualThresholds[i].size) {
            currentThreshold = this.visualThresholds[i];
            if (i + 1 < this.visualThresholds.length) {
              nextThreshold = this.visualThresholds[i + 1];
            }
          }
        }
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
        if (!nextThreshold) {
          return 100;
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const range = nextThreshold.size - currentThreshold.size;
        const progress = size - currentThreshold.size;
        return Math.min(100, (progress / range) * 100);
      }

      /**
       * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
       * @param {number} num - –ß–∏—Å–ª–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
       * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
       */
      formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(2) + 'M';
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'K';
        }
        return num.toFixed(0);
      }

      /**
       * –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤
       * @param {Array} boosts - –ú–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–æ–≤
       * @returns {string} HTML —Å—Ç—Ä–æ–∫–∞ —Å –±—É—Å—Ç–∞–º–∏
       */
      renderBoosts(boosts) {
        if (!boosts || boosts.length === 0) {
          return '';
        }
        
        const currentTime = Date.now();
        const activeBoosts = boosts.filter(boost => boost.endTime > currentTime);
        
        if (activeBoosts.length === 0) {
          return '';
        }
        
        return `
          <div class="boosts-list">
            <div class="boosts-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã:</div>
            ${activeBoosts.map(boost => {
              const timeLeft = Math.ceil((boost.endTime - currentTime) / 1000);
              return `
                <div class="boost-item">
                  <span class="boost-icon">‚ö°</span>
                  <span class="boost-multiplier">x${boost.multiplier.toFixed(1)}</span>
                  <span class="boost-timer">${this.formatTime(timeLeft)}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      /**
       * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
       * @param {number} seconds - –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
       * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
       */
      formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (minutes > 0) {
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        return `${secs}s`;
      }
    }

    /**
     * ParticleSystem - –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—Ü –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
     * –°–æ–∑–¥–∞–µ—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞—Å—Ç–∏—Ü–∞–º–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–ª–∏–∫–æ–≤
     */
    class ParticleSystem {
      constructor() {
        this.particles = [];
        this.maxParticles = 50;
      }

      /**
       * –°–æ–∑–¥–∞—Ç—å —á–∞—Å—Ç–∏—Ü—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
       * @param {number} x - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X
       * @param {number} y - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y
       * @param {number} count - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
       * @param {Object} config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü
       * @param {string} config.color - –¶–≤–µ—Ç —á–∞—Å—Ç–∏—Ü (CSS color)
       * @param {number} config.size - –†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü –≤ –ø–∏–∫—Å–µ–ª—è—Ö
       * @param {number} config.velocity - –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü
       * @param {number} config.lifetime - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —á–∞—Å—Ç–∏—Ü –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
       * @param {number} config.gravity - –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–Ω–∏–∑)
       */
      emit(x, y, count, config = {}) {
        // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const defaultConfig = {
          color: '#ffffff',
          size: 4,
          velocity: 2,
          lifetime: 1000,
          gravity: 0.5
        };

        const finalConfig = { ...defaultConfig, ...config };

        // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —á–∞—Å—Ç–∏—Ü –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
        if (this.particles.length + count > this.maxParticles) {
          const toRemove = this.particles.length + count - this.maxParticles;
          this.particles.splice(0, toRemove);
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —á–∞—Å—Ç–∏—Ü—ã
        const currentTime = Date.now();
        for (let i = 0; i < count; i++) {
          // –°–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª –¥–ª—è —Ä–∞–∑–ª–µ—Ç–∞ —á–∞—Å—Ç–∏—Ü
          const angle = Math.random() * Math.PI * 2;
          const speed = finalConfig.velocity * (0.5 + Math.random() * 0.5);

          const particle = {
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: finalConfig.color,
            size: finalConfig.size * (0.7 + Math.random() * 0.6),
            lifetime: finalConfig.lifetime,
            createdAt: currentTime,
            gravity: finalConfig.gravity,
            alpha: 1.0
          };

          this.particles.push(particle);
        }
      }

      /**
       * –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Å—Ç–∏—Ü
       * @param {number} deltaTime - –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
       */
      update(deltaTime) {
        const currentTime = Date.now();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç–∏—Ü—É
        this.particles = this.particles.filter(particle => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏
          const age = currentTime - particle.createdAt;
          if (age >= particle.lifetime) {
            return false; // –£–¥–∞–ª—è–µ–º "–º–µ—Ä—Ç–≤—É—é" —á–∞—Å—Ç–∏—Ü—É
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
          particle.x += particle.vx;
          particle.y += particle.vy;

          // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é
          particle.vy += particle.gravity;

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (fade out)
          const lifeProgress = age / particle.lifetime;
          particle.alpha = 1.0 - lifeProgress;

          return true; // –û—Å—Ç–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—É
        });
      }

      /**
       * –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã –Ω–∞ canvas
       * @param {CanvasRenderingContext2D} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç canvas –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
       */
      render(ctx) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        ctx.save();

        // –†–∏—Å—É–µ–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç–∏—Ü—É
        this.particles.forEach(particle => {
          ctx.globalAlpha = particle.alpha;
          ctx.fillStyle = particle.color;
          ctx.beginPath();
          ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
          ctx.fill();
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        ctx.restore();
      }

      /**
       * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Å—Ç–∏—Ü
       * @returns {number} –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü
       */
      getParticleCount() {
        return this.particles.length;
      }

      /**
       * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —á–∞—Å—Ç–∏—Ü—ã
       */
      clear() {
        this.particles = [];
      }
    }

    // ============================================================================
    // Application Initialization
    // ============================================================================

    /**
     * –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     */
    class App {
      constructor() {
        this.stateManager = new StateManager();
        this.eventBus = new EventBus();
        this.storageManager = new StorageManager(this.stateManager);
        this.telegramBridge = new TelegramBridge();
        this.gameEngine = new GameEngine(this.stateManager, this.eventBus);
        this.particleSystem = new ParticleSystem();
        this.clickerView = null;
        this.initialized = false;
        this.lastUpdateTime = Date.now();
        this.canvas = null;
        this.ctx = null;
      }

      /**
       * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
       */
      async init() {
        try {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas –¥–ª—è —á–∞—Å—Ç–∏—Ü
          this.canvas = document.getElementById('particle-canvas');
          this.ctx = this.canvas.getContext('2d');
          this.resizeCanvas();
          window.addEventListener('resize', () => this.resizeCanvas());

          // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü
          this.eventBus.on('click', (data) => {
            // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –≤ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞
            this.particleSystem.emit(data.x, data.y, 8, {
              color: '#FFD700',
              size: 6,
              velocity: 3,
              lifetime: 800,
              gravity: 0.3
            });
          });

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
          let userData = null;
          try {
            userData = this.telegramBridge.init();
            console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', userData);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (userData) {
              this.stateManager.update('player', {
                id: userData.id,
                name: userData.first_name + (userData.last_name ? ' ' + userData.last_name : ''),
                avatar: userData.photo_url
              });
            }
          } catch (error) {
            console.warn('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            this.showError(
              '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏',
              '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç.'
            );
            return;
          }

          // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          const savedState = this.storageManager.load();
          if (savedState) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram, –Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ LocalStorage
            const playerData = this.stateManager.get('player');
            this.stateManager.loadState(savedState);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
            if (userData) {
              this.stateManager.update('player', {
                id: playerData.id,
                name: playerData.name,
                avatar: playerData.avatar
              });
            }
            console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ LocalStorage');
          } else {
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
          }

          // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
          this.stateManager.subscribe('player', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('boosts', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('antiBoosts', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('achievements', () => {
            this.storageManager.save();
          });

          this.stateManager.subscribe('shopItems', () => {
            this.storageManager.save();
          });

          this.initialized = true;
          this.render();
          this.startGameLoop();
          
          console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
          this.showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', error.message);
        }
      }

      /**
       * –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä canvas –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
       */
      resizeCanvas() {
        if (this.canvas) {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }
      }

      /**
       * –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
       */
      startGameLoop() {
        const gameLoop = () => {
          const currentTime = Date.now();
          const deltaTime = currentTime - this.lastUpdateTime;
          this.lastUpdateTime = currentTime;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–π –¥–≤–∏–∂–æ–∫
          this.gameEngine.update(deltaTime);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É —á–∞—Å—Ç–∏—Ü
          this.particleSystem.update(deltaTime);
          
          // –û—á–∏—â–∞–µ–º canvas
          if (this.ctx) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã
            this.particleSystem.render(this.ctx);
          }
          
          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
          requestAnimationFrame(gameLoop);
        };
        
        requestAnimationFrame(gameLoop);
      }

      /**
       * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
       */
      render() {
        const app = document.getElementById('app');
        const state = this.stateManager.getState();
        const playerName = state.player.name || '–ò–≥—Ä–æ–∫';
        
        app.innerHTML = `
          <nav class="nav">
            <button class="nav-button active" data-view="clicker">üéÆ –ò–≥—Ä–∞</button>
            <button class="nav-button" data-view="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-button" data-view="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="nav-button" data-view="leaderboard">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
            <button class="nav-button" data-view="achievements">‚≠ê –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
          </nav>

          <div id="clicker-view" class="view active">
            <div class="card">
              <!-- ClickerView will render here -->
            </div>
          </div>

          <div id="shop-view" class="view">
            <div class="card">
              <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
              <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–æ–≤–∞—Ä—ã...</p>
            </div>
          </div>

          <div id="profile-view" class="view">
            <div class="card">
              <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
              <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞...</p>
            </div>
          </div>

          <div id="leaderboard-view" class="view">
            <div class="card">
              <h2>–†–µ–π—Ç–∏–Ω–≥</h2>
              <p>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤...</p>
            </div>
          </div>

          <div id="achievements-view" class="view">
            <div class="card">
              <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
              <p>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π...</p>
            </div>
          </div>
        `;

        this.setupNavigation();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ClickerView
        this.clickerView = new ClickerView(this.stateManager, this.eventBus, this.gameEngine);
        const clickerContainer = document.querySelector('#clicker-view .card');
        if (clickerContainer) {
          this.clickerView.render(clickerContainer);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º haptic feedback –¥–ª—è –∫–ª–∏–∫–æ–≤
        this.eventBus.on('click', () => {
          this.telegramBridge.hapticFeedback('light');
        });
      }

      /**
       * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
       */
      setupNavigation() {
        const navButtons = document.querySelectorAll('.nav-button');
        navButtons.forEach(button => {
          button.addEventListener('click', () => {
            const viewName = button.dataset.view;
            this.switchView(viewName);
          });
        });
      }

      /**
       * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
       * @param {string} viewName - –ù–∞–∑–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
       */
      switchView(viewName) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ —ç–∫—Ä–∞–Ω–æ–≤
        document.querySelectorAll('.nav-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º
        const button = document.querySelector(`[data-view="${viewName}"]`);
        const view = document.getElementById(`${viewName}-view`);
        
        if (button) button.classList.add('active');
        if (view) view.classList.add('active');
      }

      /**
       * –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
       * @param {string} title - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—à–∏–±–∫–∏
       * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
       */
      showError(title, message) {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="error">
            <div class="error-title">${title}</div>
            <div class="error-message">${message}</div>
            <button class="button" onclick="location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        `;
      }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new App();
      window.app.init();
    });
  </script>
</body>
</html>
